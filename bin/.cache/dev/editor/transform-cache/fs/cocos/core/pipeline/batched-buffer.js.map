{"version":3,"sources":["file:///Users/disstian/Documents/CreatorProjects/engine3.3.0/cocos/core/pipeline/batched-buffer.ts"],"names":["BatchedBuffer","constructor","pass","batches","dynamicOffsets","_device","device","destroy","i","length","batch","j","vbs","vbIdx","ia","ubo","merge","subModel","passIdx","model","flatBuffers","subMesh","vbSize","vbIdxSize","vbCount","count","passes","shader","shaders","descriptorSet","isBatchExist","mergeCount","UBOLocalBatched","BATCHING_COUNT","vb","stride","flatBuff","batchVB","vbBuf","vbDatas","size","resize","Uint8Array","set","buffer","vbIdxBuf","vbIdxData","Float32Array","BYTES_PER_ELEMENT","start","end","Mat4","toArray","uboData","transform","worldMatrix","MAT_WORLDS_OFFSET","bindBuffer","BINDING","update","vertexCount","totalVBs","newVB","createBuffer","BufferInfo","BufferUsageBit","VERTEX","TRANSFER_DST","MemoryUsageBit","HOST","DEVICE","push","fill","attributes","inputAssembler","attrs","Array","a","Attribute","Format","R32F","iaInfo","InputAssemblerInfo","createInputAssembler","UNIFORM","SIZE","COUNT","clear"],"mappings":";;;;;;;AA8BA;;AAEA;;AAEA;;AAlCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAyBO,MAAMA,aAAN,CAAoB;AAKvBC,EAAAA,WAAW,CAAEC,IAAF,EAAc;AAAA,SAJlBC,OAIkB,GAJQ,EAIR;AAAA,SAHlBC,cAGkB,GAHS,EAGT;AAAA,SAFjBC,OAEiB;AACrB,SAAKA,OAAL,GAAeH,IAAI,CAACI,MAApB;AACH;;AAEMC,EAAAA,OAAO,GAAI;AACd,SAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKL,OAAL,CAAaM,MAAjC,EAAyC,EAAED,CAA3C,EAA8C;AAC1C,YAAME,KAAK,GAAG,KAAKP,OAAL,CAAaK,CAAb,CAAd;;AACA,WAAK,IAAIG,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGD,KAAK,CAACE,GAAN,CAAUH,MAA9B,EAAsC,EAAEE,CAAxC,EAA2C;AACvCD,QAAAA,KAAK,CAACE,GAAN,CAAUD,CAAV,EAAaJ,OAAb;AACH;;AACDG,MAAAA,KAAK,CAACG,KAAN,CAAYN,OAAZ;AACAG,MAAAA,KAAK,CAACI,EAAN,CAASP,OAAT;AACAG,MAAAA,KAAK,CAACK,GAAN,CAAUR,OAAV;AACH;;AACD,SAAKJ,OAAL,CAAaM,MAAb,GAAsB,CAAtB;AACH;;AAEMO,EAAAA,KAAK,CAAEC,QAAF,EAAsBC,OAAtB,EAAuCC,KAAvC,EAAqD;AAC7D,UAAMC,WAAW,GAAGH,QAAQ,CAACI,OAAT,CAAiBD,WAArC;;AACA,QAAIA,WAAW,CAACX,MAAZ,KAAuB,CAA3B,EAA8B;AAAE;AAAS;;AACzC,QAAIa,MAAM,GAAG,CAAb;AACA,QAAIC,SAAS,GAAG,CAAhB;AACA,UAAMC,OAAO,GAAGJ,WAAW,CAAC,CAAD,CAAX,CAAeK,KAA/B;AACA,UAAMvB,IAAI,GAAGe,QAAQ,CAACS,MAAT,CAAgBR,OAAhB,CAAb;AACA,UAAMS,MAAM,GAAGV,QAAQ,CAACW,OAAT,CAAiBV,OAAjB,CAAf;AACA,UAAMW,aAAa,GAAGZ,QAAQ,CAACY,aAA/B;AACA,QAAIC,YAAY,GAAG,KAAnB;;AACA,SAAK,IAAItB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKL,OAAL,CAAaM,MAAjC,EAAyC,EAAED,CAA3C,EAA8C;AAC1C,YAAME,KAAK,GAAG,KAAKP,OAAL,CAAaK,CAAb,CAAd;;AACA,UAAIE,KAAK,CAACE,GAAN,CAAUH,MAAV,KAAqBW,WAAW,CAACX,MAAjC,IAA2CC,KAAK,CAACqB,UAAN,GAAmBC,wBAAgBC,cAAlF,EAAkG;AAC9FH,QAAAA,YAAY,GAAG,IAAf;;AACA,aAAK,IAAInB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGD,KAAK,CAACE,GAAN,CAAUH,MAA9B,EAAsC,EAAEE,CAAxC,EAA2C;AACvC,gBAAMuB,EAAE,GAAGxB,KAAK,CAACE,GAAN,CAAUD,CAAV,CAAX;;AACA,cAAIuB,EAAE,CAACC,MAAH,KAAcf,WAAW,CAACT,CAAD,CAAX,CAAewB,MAAjC,EAAyC;AACrCL,YAAAA,YAAY,GAAG,KAAf;AACA;AACH;AACJ;;AAED,YAAIA,YAAJ,EAAkB;AACd,eAAK,IAAInB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGD,KAAK,CAACE,GAAN,CAAUH,MAA9B,EAAsC,EAAEE,CAAxC,EAA2C;AACvC,kBAAMyB,QAAQ,GAAGhB,WAAW,CAACT,CAAD,CAA5B;AACA,kBAAM0B,OAAO,GAAG3B,KAAK,CAACE,GAAN,CAAUD,CAAV,CAAhB;AACA,kBAAM2B,KAAK,GAAG5B,KAAK,CAAC6B,OAAN,CAAc5B,CAAd,CAAd;AACAW,YAAAA,MAAM,GAAG,CAACE,OAAO,GAAGd,KAAK,CAACc,OAAjB,IAA4BY,QAAQ,CAACD,MAA9C;;AACA,gBAAIb,MAAM,GAAGe,OAAO,CAACG,IAArB,EAA2B;AACvBH,cAAAA,OAAO,CAACI,MAAR,CAAenB,MAAf;AACAZ,cAAAA,KAAK,CAAC6B,OAAN,CAAc5B,CAAd,IAAmB,IAAI+B,UAAJ,CAAepB,MAAf,CAAnB;AACAZ,cAAAA,KAAK,CAAC6B,OAAN,CAAc5B,CAAd,EAAiBgC,GAAjB,CAAqBL,KAArB;AACH;;AACD5B,YAAAA,KAAK,CAAC6B,OAAN,CAAc5B,CAAd,EAAiBgC,GAAjB,CAAqBP,QAAQ,CAACQ,MAA9B,EAAsClC,KAAK,CAACc,OAAN,GAAgBY,QAAQ,CAACD,MAA/D;AACH;;AAED,cAAIU,QAAQ,GAAGnC,KAAK,CAACoC,SAArB;AACAvB,UAAAA,SAAS,GAAG,CAACC,OAAO,GAAGd,KAAK,CAACc,OAAjB,IAA4B,CAAxC;;AACA,cAAID,SAAS,GAAGb,KAAK,CAACG,KAAN,CAAY2B,IAA5B,EAAkC;AAC9B9B,YAAAA,KAAK,CAACG,KAAN,CAAY4B,MAAZ,CAAmBlB,SAAnB;AACAb,YAAAA,KAAK,CAACoC,SAAN,GAAkB,IAAIC,YAAJ,CAAiBxB,SAAS,GAAGwB,YAAY,CAACC,iBAA1C,CAAlB;AACAtC,YAAAA,KAAK,CAACoC,SAAN,CAAgBH,GAAhB,CAAoBE,QAApB;AACAA,YAAAA,QAAQ,GAAGnC,KAAK,CAACoC,SAAjB;AACH;;AAED,gBAAMG,KAAK,GAAGvC,KAAK,CAACc,OAApB;AACA,gBAAM0B,GAAG,GAAGD,KAAK,GAAGzB,OAApB;AACA,gBAAMO,UAAU,GAAGrB,KAAK,CAACqB,UAAzB;;AACA,cAAIc,QAAQ,CAACI,KAAD,CAAR,KAAoBlB,UAApB,IAAkCc,QAAQ,CAACK,GAAG,GAAG,CAAP,CAAR,KAAsBnB,UAA5D,EAAwE;AACpE,iBAAK,IAAIpB,CAAC,GAAGsC,KAAb,EAAoBtC,CAAC,GAAGuC,GAAxB,EAA6BvC,CAAC,EAA9B,EAAkC;AAC9BkC,cAAAA,QAAQ,CAAClC,CAAD,CAAR,GAAcoB,UAAU,GAAG,GAA3B,CAD8B,CACE;AACnC;AACJ,WA9Ba,CAgCd;;;AACAoB,uBAAKC,OAAL,CAAa1C,KAAK,CAAC2C,OAAnB,EAA4BlC,KAAK,CAACmC,SAAN,CAAgBC,WAA5C,EAAyDvB,wBAAgBwB,iBAAhB,GAAoC9C,KAAK,CAACqB,UAAN,GAAmB,EAAhH;;AACA,cAAI,CAACrB,KAAK,CAACqB,UAAX,EAAuB;AACnBF,YAAAA,aAAa,CAAC4B,UAAd,CAAyBzB,wBAAgB0B,OAAzC,EAAkDhD,KAAK,CAACK,GAAxD;AACAc,YAAAA,aAAa,CAAC8B,MAAd;AACAjD,YAAAA,KAAK,CAACR,IAAN,GAAaA,IAAb;AACAQ,YAAAA,KAAK,CAACiB,MAAN,GAAeA,MAAf;AACAjB,YAAAA,KAAK,CAACmB,aAAN,GAAsBA,aAAtB;AACH;;AAED,YAAEnB,KAAK,CAACqB,UAAR;AACArB,UAAAA,KAAK,CAACc,OAAN,IAAiBA,OAAjB;AACAd,UAAAA,KAAK,CAACI,EAAN,CAAS8C,WAAT,IAAwBpC,OAAxB;AAEA;AACH;AACJ;AACJ,KAvE4D,CAyE7D;;;AACA,UAAMZ,GAAa,GAAG,EAAtB;AACA,UAAM2B,OAAqB,GAAG,EAA9B;AACA,UAAMsB,QAAkB,GAAG,EAA3B;;AACA,SAAK,IAAIrD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGY,WAAW,CAACX,MAAhC,EAAwC,EAAED,CAA1C,EAA6C;AACzC,YAAM4B,QAAQ,GAAGhB,WAAW,CAACZ,CAAD,CAA5B;;AACA,YAAMsD,KAAK,GAAG,KAAKzD,OAAL,CAAa0D,YAAb,CAA0B,IAAIC,iBAAJ,CACpCC,sBAAeC,MAAf,GAAwBD,sBAAeE,YADH,EAEpCC,sBAAeC,IAAf,GAAsBD,sBAAeE,MAFD,EAGpClC,QAAQ,CAACX,KAAT,GAAiBW,QAAQ,CAACD,MAHU,EAIpCC,QAAQ,CAACD,MAJ2B,CAA1B,CAAd;;AAMA2B,MAAAA,KAAK,CAACH,MAAN,CAAavB,QAAQ,CAACQ,MAAT,CAAgBA,MAA7B;AACAhC,MAAAA,GAAG,CAAC2D,IAAJ,CAAST,KAAT;AACAvB,MAAAA,OAAO,CAACgC,IAAR,CAAa,IAAI7B,UAAJ,CAAeoB,KAAK,CAACtB,IAArB,CAAb;AACAqB,MAAAA,QAAQ,CAACU,IAAT,CAAcT,KAAd;AACH;;AAED,UAAMjD,KAAK,GAAG,KAAKR,OAAL,CAAa0D,YAAb,CAA0B,IAAIC,iBAAJ,CACpCC,sBAAeC,MAAf,GAAwBD,sBAAeE,YADH,EAEpCC,sBAAeC,IAAf,GAAsBD,sBAAeE,MAFD,EAGpC9C,OAAO,GAAG,CAH0B,EAIpC,CAJoC,CAA1B,CAAd;;AAMA,UAAMsB,SAAS,GAAG,IAAIC,YAAJ,CAAiBvB,OAAjB,CAAlB;AACAsB,IAAAA,SAAS,CAAC0B,IAAV,CAAe,CAAf;AACA3D,IAAAA,KAAK,CAAC8C,MAAN,CAAab,SAAb;AACAe,IAAAA,QAAQ,CAACU,IAAT,CAAc1D,KAAd;AAEA,UAAM4D,UAAU,GAAGxD,QAAQ,CAACyD,cAAT,CAAwBD,UAA3C;AACA,UAAME,KAAK,GAAG,IAAIC,KAAJ,CAAqBH,UAAU,CAAChE,MAAX,GAAoB,CAAzC,CAAd;;AACA,SAAK,IAAIoE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,UAAU,CAAChE,MAA/B,EAAuC,EAAEoE,CAAzC,EAA4C;AACxCF,MAAAA,KAAK,CAACE,CAAD,CAAL,GAAWJ,UAAU,CAACI,CAAD,CAArB;AACH;;AACDF,IAAAA,KAAK,CAACF,UAAU,CAAChE,MAAZ,CAAL,GAA2B,IAAIqE,gBAAJ,CAAc,gBAAd,EAAgCC,cAAOC,IAAvC,EAA6C,KAA7C,EAAoD5D,WAAW,CAACX,MAAhE,CAA3B;AAEA,UAAMwE,MAAM,GAAG,IAAIC,yBAAJ,CAAuBP,KAAvB,EAA8Bd,QAA9B,CAAf;;AACA,UAAM/C,EAAE,GAAG,KAAKT,OAAL,CAAa8E,oBAAb,CAAkCF,MAAlC,CAAX;;AAEA,UAAMlE,GAAG,GAAG,KAAKV,OAAL,CAAa0D,YAAb,CAA0B,IAAIC,iBAAJ,CAClCC,sBAAemB,OAAf,GAAyBnB,sBAAeE,YADN,EAElCC,sBAAeC,IAAf,GAAsBD,sBAAeE,MAFH,EAGlCtC,wBAAgBqD,IAHkB,EAIlCrD,wBAAgBqD,IAJkB,CAA1B,CAAZ;;AAOAxD,IAAAA,aAAa,CAAC4B,UAAd,CAAyBzB,wBAAgB0B,OAAzC,EAAkD3C,GAAlD;AACAc,IAAAA,aAAa,CAAC8B,MAAd;AAEA,UAAMN,OAAO,GAAG,IAAIN,YAAJ,CAAiBf,wBAAgBsD,KAAjC,CAAhB;;AACAnC,iBAAKC,OAAL,CAAaC,OAAb,EAAsBlC,KAAK,CAACmC,SAAN,CAAgBC,WAAtC,EAAmDvB,wBAAgBwB,iBAAnE;;AAEA,SAAKrD,OAAL,CAAaoE,IAAb,CAAkB;AACdxC,MAAAA,UAAU,EAAE,CADE;AAEdnB,MAAAA,GAFc;AAGd2B,MAAAA,OAHc;AAId1B,MAAAA,KAJc;AAKdiC,MAAAA,SALc;AAMdtB,MAAAA,OANc;AAOdV,MAAAA,EAPc;AAQdC,MAAAA,GARc;AASdsC,MAAAA,OATc;AAUdnD,MAAAA,IAVc;AAWdyB,MAAAA,MAXc;AAYdE,MAAAA;AAZc,KAAlB;AAcH;;AAEM0D,EAAAA,KAAK,GAAI;AACZ,SAAK,IAAI/E,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKL,OAAL,CAAaM,MAAjC,EAAyC,EAAED,CAA3C,EAA8C;AAC1C,YAAME,KAAK,GAAG,KAAKP,OAAL,CAAaK,CAAb,CAAd;AACAE,MAAAA,KAAK,CAACc,OAAN,GAAgB,CAAhB;AACAd,MAAAA,KAAK,CAACqB,UAAN,GAAmB,CAAnB;AACArB,MAAAA,KAAK,CAACI,EAAN,CAAS8C,WAAT,GAAuB,CAAvB;AACH;AACJ;;AA1KsB"}