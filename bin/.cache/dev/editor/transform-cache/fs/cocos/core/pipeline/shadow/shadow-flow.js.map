{"version":3,"sources":["file:///Users/disstian/Documents/CreatorProjects/engine3.3.0/cocos/core/pipeline/shadow/shadow-flow.ts"],"names":["_validLights","ShadowFlow","RenderFlow","_shadowRenderPass","initialize","info","_stages","length","shadowMapStage","ShadowStage","initInfo","push","render","camera","pipeline","_pipeline","shadowInfo","pipelineSceneData","shadows","shadowFrameBufferMap","castShadowObjects","validPunctualLights","enabled","type","ShadowType","ShadowMap","n","m","maxReceived","light","LightType","SPOT","clearShadowMap","shadowMapDirty","resizeShadowMap","mainLight","scene","globalDS","descriptorSet","has","_initShadowFrameBuffer","window","swapchain","shadowFrameBuffer","get","i","shadowStage","setUsage","l","globalDSManager","getOrCreateDescriptorSet","destroy","shadowFrameBuffers","Array","from","values","frameBuffer","renderTargets","colorTextures","j","renderTarget","depth","depthStencilTexture","clear","device","shadowMapSize","size","format","Format","R32F","RGBA8","colorAttachment","ColorAttachment","loadOp","LoadOp","CLEAR","storeOp","StoreOp","STORE","sampleCount","depthStencilAttachment","DepthStencilAttachment","DEPTH_STENCIL","depthLoadOp","depthStoreOp","DISCARD","stencilLoadOp","stencilStoreOp","renderPassInfo","RenderPassInfo","createRenderPass","shadowRenderTargets","createTexture","TextureInfo","TextureType","TEX2D","TextureUsageBit","COLOR_ATTACHMENT","SAMPLED","x","y","DEPTH_STENCIL_ATTACHMENT","createFramebuffer","FramebufferInfo","set","validLights","clearFramebuffer","it","res","next","done","value","resize","shadowRenderPass","renderPass","name","PIPELINE_FLOW_SHADOW","priority","ForwardFlowPriority","SHADOW","tag","RenderFlowTag","SCENE","stages"],"mappings":"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"}