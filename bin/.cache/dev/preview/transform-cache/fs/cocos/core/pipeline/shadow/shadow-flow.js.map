{"version":3,"sources":["../../../../../../../../../../cocos/core/pipeline/shadow/shadow-flow.ts"],"names":["ccclass","PIPELINE_FLOW_SHADOW","supportsFloatTexture","RenderFlow","ForwardFlowPriority","ShadowStage","LoadOp","StoreOp","Format","TextureType","TextureUsageBit","ColorAttachment","DepthStencilAttachment","RenderPassInfo","TextureInfo","FramebufferInfo","RenderFlowTag","ShadowType","LightType","_validLights","ShadowFlow","_shadowRenderPass","initialize","info","_stages","length","shadowMapStage","initInfo","push","render","camera","pipeline","_pipeline","shadowInfo","pipelineSceneData","shadows","shadowFrameBufferMap","castShadowObjects","validPunctualLights","enabled","type","ShadowMap","n","m","maxReceived","light","SPOT","clearShadowMap","shadowMapDirty","resizeShadowMap","scene","mainLight","globalDS","descriptorSet","has","_initShadowFrameBuffer","window","swapchain","shadowFrameBuffer","get","i","shadowStage","setUsage","l","globalDSManager","getOrCreateDescriptorSet","destroy","shadowFrameBuffers","Array","from","values","frameBuffer","renderTargets","colorTextures","j","renderTarget","depth","depthStencilTexture","clear","device","shadowMapSize","size","format","R32F","RGBA8","colorAttachment","loadOp","CLEAR","storeOp","STORE","sampleCount","depthStencilAttachment","DEPTH_STENCIL","depthLoadOp","depthStoreOp","DISCARD","stencilLoadOp","stencilStoreOp","renderPassInfo","createRenderPass","shadowRenderTargets","createTexture","TEX2D","COLOR_ATTACHMENT","SAMPLED","x","y","DEPTH_STENCIL_ATTACHMENT","createFramebuffer","set","validLights","clearFramebuffer","it","res","next","done","value","resize","shadowRenderPass","renderPass","name","priority","SHADOW","tag","SCENE","stages"],"mappings":";;;;;;;;;;;AA8BSA,MAAAA,O,0BAAAA,O;;AACAC,MAAAA,oB,aAAAA,oB;AAAsBC,MAAAA,oB,aAAAA,oB;;AACLC,MAAAA,U,iBAAAA,U;;AACjBC,MAAAA,mB,WAAAA,mB;;AACAC,MAAAA,W,kBAAAA,W;;AACYC,MAAAA,M,eAAAA,M;AAAQC,MAAAA,O,eAAAA,O;AACzBC,MAAAA,M,eAAAA,M;AAAiBC,MAAAA,W,eAAAA,W;AAAaC,MAAAA,e,eAAAA,e;AAAiBC,MAAAA,e,eAAAA,e;AAC/CC,MAAAA,sB,eAAAA,sB;AAAwBC,MAAAA,c,eAAAA,c;AAAgBC,MAAAA,W,eAAAA,W;AAAaC,MAAAA,e,eAAAA,e;;AAChDC,MAAAA,a,4BAAAA,a;;AAGAC,MAAAA,U,2BAAAA,U;;AACOC,MAAAA,S,yBAAAA,S;;;AAGVC,MAAAA,Y,GAAwB,E;AAE9B;AACA;AACA;AACA;;4BAEaC,U,WADZpB,OAAO,CAAC,YAAD,C;;;;;;;;;;;gBAaIqB,iB,GAAqC,I;;;;;;eAEtCC,U,GAAP,oBAAmBC,IAAnB,EAAmD;AAC/C,gCAAMD,UAAN,YAAiBC,IAAjB;;AACA,cAAI,KAAKC,OAAL,CAAaC,MAAb,KAAwB,CAA5B,EAA+B;AAC3B;AACA,gBAAMC,cAAc,GAAG,IAAIrB,WAAJ,EAAvB;AACAqB,YAAAA,cAAc,CAACJ,UAAf,CAA0BjB,WAAW,CAACsB,QAAtC;;AACA,iBAAKH,OAAL,CAAaI,IAAb,CAAkBF,cAAlB;AACH;;AACD,iBAAO,IAAP;AACH,S;;eAEMG,M,GAAP,gBAAeC,MAAf,EAA+B;AAC3B,cAAMC,QAAQ,GAAG,KAAKC,SAAtB;AACA,cAAMC,UAAU,GAAGF,QAAQ,CAACG,iBAAT,CAA2BC,OAA9C;AACA,cAAMC,oBAAoB,GAAGL,QAAQ,CAACG,iBAAT,CAA2BE,oBAAxD;AACA,cAAMC,iBAAiB,GAAGN,QAAQ,CAACG,iBAAT,CAA2BG,iBAArD;AACA,cAAMC,mBAAmB,GAAG,KAAKN,SAAL,CAAeE,iBAAf,CAAiCI,mBAA7D;;AACA,cAAI,CAACL,UAAU,CAACM,OAAZ,IAAuBN,UAAU,CAACO,IAAX,KAAoBvB,UAAU,CAACwB,SAA1D,EAAqE;AAAE;AAAS;;AAEhF,cAAIC,CAAC,GAAG,CAAR;AACA,cAAIC,CAAC,GAAG,CAAR;;AACA,iBAAMD,CAAC,GAAGT,UAAU,CAACW,WAAf,IAA8BD,CAAC,GAAGL,mBAAmB,CAACb,MAA5D,GAAqE;AACjE,gBAAMoB,KAAK,GAAGP,mBAAmB,CAACK,CAAD,CAAjC;;AACA,gBAAIE,KAAK,CAACL,IAAN,KAAetB,SAAS,CAAC4B,IAA7B,EAAmC;AAC/B3B,cAAAA,YAAY,CAACS,IAAb,CAAkBiB,KAAlB;;AACAH,cAAAA,CAAC;AACJ;;AACDC,YAAAA,CAAC;AACJ;;AAED,cAAIN,iBAAiB,CAACZ,MAAlB,KAA6B,CAAjC,EAAoC;AAChC,iBAAKsB,cAAL,CAAoB5B,YAApB,EAAkCW,MAAlC;AACA;AACH;;AAED,cAAIG,UAAU,CAACe,cAAf,EAA+B;AAAE,iBAAKC,eAAL;AAAyB;;AAxB/B,qBA0BLnB,MAAM,CAACoB,KA1BF;AAAA,cA0BnBC,SA1BmB,QA0BnBA,SA1BmB;;AA2B3B,cAAIA,SAAJ,EAAe;AACX,gBAAMC,QAAQ,GAAGrB,QAAQ,CAACsB,aAA1B;;AACA,gBAAI,CAACjB,oBAAoB,CAACkB,GAArB,CAAyBH,SAAzB,CAAL,EAA0C;AACtC,mBAAKI,sBAAL,CAA4BxB,QAA5B,EAAsCoB,SAAtC,EAAiDrB,MAAM,CAAC0B,MAAP,CAAcC,SAA/D;AACH;;AAED,gBAAMC,iBAAiB,GAAGtB,oBAAoB,CAACuB,GAArB,CAAyBR,SAAzB,CAA1B;;AACA,iBAAK,IAAIS,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKpC,OAAL,CAAaC,MAAjC,EAAyCmC,CAAC,EAA1C,EAA8C;AAC1C,kBAAMC,WAAW,GAAG,KAAKrC,OAAL,CAAaoC,CAAb,CAApB;AACAC,cAAAA,WAAW,CAACC,QAAZ,CAAqBV,QAArB,EAA+BD,SAA/B,EAA0CO,iBAA1C;AACAG,cAAAA,WAAW,CAAChC,MAAZ,CAAmBC,MAAnB;AACH;AACJ;;AAED,eAAK,IAAIiC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG5C,YAAY,CAACM,MAAjC,EAAyCsC,CAAC,EAA1C,EAA8C;AAC1C,gBAAMlB,MAAK,GAAG1B,YAAY,CAAC4C,CAAD,CAA1B;;AACA,gBAAMX,SAAQ,GAAGrB,QAAQ,CAACiC,eAAT,CAAyBC,wBAAzB,CAAkDF,CAAlD,CAAjB;;AAEA,gBAAI,CAAC3B,oBAAoB,CAACkB,GAArB,CAAyBT,MAAzB,CAAL,EAAsC;AAClC,mBAAKU,sBAAL,CAA4BxB,QAA5B,EAAsCc,MAAtC,EAA6Cf,MAAM,CAAC0B,MAAP,CAAcC,SAA3D;AACH;;AAED,gBAAMC,kBAAiB,GAAGtB,oBAAoB,CAACuB,GAArB,CAAyBd,MAAzB,CAA1B;;AACA,iBAAK,IAAIe,EAAC,GAAG,CAAb,EAAgBA,EAAC,GAAG,KAAKpC,OAAL,CAAaC,MAAjC,EAAyCmC,EAAC,EAA1C,EAA8C;AAC1C,kBAAMC,YAAW,GAAG,KAAKrC,OAAL,CAAaoC,EAAb,CAApB;;AACAC,cAAAA,YAAW,CAACC,QAAZ,CAAqBV,SAArB,EAA+BP,MAA/B,EAAsCa,kBAAtC;;AACAG,cAAAA,YAAW,CAAChC,MAAZ,CAAmBC,MAAnB;AACH;AACJ;;AAEDX,UAAAA,YAAY,CAACM,MAAb,GAAsB,CAAtB;AACH,S;;eAEMyC,O,GAAP,mBAAkB;AACd,gCAAMA,OAAN;;AACA,cAAI,KAAKlC,SAAT,EAAoB;AAChB,gBAAMI,oBAAoB,GAAG,KAAKJ,SAAL,CAAeE,iBAAf,CAAiCE,oBAA9D;AACA,gBAAM+B,kBAAkB,GAAGC,KAAK,CAACC,IAAN,CAAWjC,oBAAoB,CAACkC,MAArB,EAAX,CAA3B;;AACA,iBAAK,IAAIV,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGO,kBAAkB,CAAC1C,MAAvC,EAA+CmC,CAAC,EAAhD,EAAoD;AAChD,kBAAMW,WAAW,GAAGJ,kBAAkB,CAACP,CAAD,CAAtC;;AAEA,kBAAI,CAACW,WAAL,EAAkB;AAAE;AAAW;;AAC/B,kBAAMC,aAAa,GAAGD,WAAW,CAACE,aAAlC;;AACA,mBAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGF,aAAa,CAAC/C,MAAlC,EAA0CiD,CAAC,EAA3C,EAA+C;AAC3C,oBAAMC,YAAY,GAAGH,aAAa,CAACZ,CAAD,CAAlC;;AACA,oBAAIe,YAAJ,EAAkB;AAAEA,kBAAAA,YAAY,CAACT,OAAb;AAAyB;AAChD;;AACDM,cAAAA,aAAa,CAAC/C,MAAd,GAAuB,CAAvB;AAEA,kBAAMmD,KAAK,GAAGL,WAAW,CAACM,mBAA1B;;AACA,kBAAID,KAAJ,EAAW;AAAEA,gBAAAA,KAAK,CAACV,OAAN;AAAkB;;AAE/BK,cAAAA,WAAW,CAACL,OAAZ;AACH;;AAED9B,YAAAA,oBAAoB,CAAC0C,KAArB;AACH;;AAED,cAAI,KAAKzD,iBAAT,EAA4B;AAAE,iBAAKA,iBAAL,CAAuB6C,OAAvB;AAAmC;AACpE,S;;eAEMX,sB,GAAP,gCAAgCxB,QAAhC,EAA0Dc,KAA1D,EAAwEY,SAAxE,EAA8F;AAAA,cAClFsB,MADkF,GACvEhD,QADuE,CAClFgD,MADkF;AAE1F,cAAM5C,OAAO,GAAGJ,QAAQ,CAACG,iBAAT,CAA2BC,OAA3C;AACA,cAAM6C,aAAa,GAAG7C,OAAO,CAAC8C,IAA9B;AACA,cAAM7C,oBAAoB,GAAGL,QAAQ,CAACG,iBAAT,CAA2BE,oBAAxD;AACA,cAAM8C,MAAM,GAAGhF,oBAAoB,CAAC6E,MAAD,CAApB,GAA+BvE,MAAM,CAAC2E,IAAtC,GAA6C3E,MAAM,CAAC4E,KAAnE;;AAEA,cAAI,CAAC,KAAK/D,iBAAV,EAA6B;AACzB,gBAAMgE,eAAe,GAAG,IAAI1E,eAAJ,EAAxB;AACA0E,YAAAA,eAAe,CAACH,MAAhB,GAAyBA,MAAzB;AACAG,YAAAA,eAAe,CAACC,MAAhB,GAAyBhF,MAAM,CAACiF,KAAhC,CAHyB,CAGc;;AACvCF,YAAAA,eAAe,CAACG,OAAhB,GAA0BjF,OAAO,CAACkF,KAAlC;AACAJ,YAAAA,eAAe,CAACK,WAAhB,GAA8B,CAA9B;AAEA,gBAAMC,sBAAsB,GAAG,IAAI/E,sBAAJ,EAA/B;AACA+E,YAAAA,sBAAsB,CAACT,MAAvB,GAAgC1E,MAAM,CAACoF,aAAvC;AACAD,YAAAA,sBAAsB,CAACE,WAAvB,GAAqCvF,MAAM,CAACiF,KAA5C;AACAI,YAAAA,sBAAsB,CAACG,YAAvB,GAAsCvF,OAAO,CAACwF,OAA9C;AACAJ,YAAAA,sBAAsB,CAACK,aAAvB,GAAuC1F,MAAM,CAACiF,KAA9C;AACAI,YAAAA,sBAAsB,CAACM,cAAvB,GAAwC1F,OAAO,CAACwF,OAAhD;AACAJ,YAAAA,sBAAsB,CAACD,WAAvB,GAAqC,CAArC;AAEA,gBAAMQ,cAAc,GAAG,IAAIrF,cAAJ,CAAmB,CAACwE,eAAD,CAAnB,EAAsCM,sBAAtC,CAAvB;AACA,iBAAKtE,iBAAL,GAAyB0D,MAAM,CAACoB,gBAAP,CAAwBD,cAAxB,CAAzB;AACH;;AAED,cAAME,mBAA8B,GAAG,EAAvC;AACAA,UAAAA,mBAAmB,CAACxE,IAApB,CAAyBmD,MAAM,CAACsB,aAAP,CAAqB,IAAIvF,WAAJ,CAC1CL,WAAW,CAAC6F,KAD8B,EAE1C5F,eAAe,CAAC6F,gBAAhB,GAAmC7F,eAAe,CAAC8F,OAFT,EAG1CtB,MAH0C,EAI1CF,aAAa,CAACyB,CAJ4B,EAK1CzB,aAAa,CAAC0B,CAL4B,CAArB,CAAzB;AAQA,cAAM9B,KAAK,GAAGG,MAAM,CAACsB,aAAP,CAAqB,IAAIvF,WAAJ,CAC/BL,WAAW,CAAC6F,KADmB,EAE/B5F,eAAe,CAACiG,wBAFe,EAG/BnG,MAAM,CAACoF,aAHwB,EAI/BZ,aAAa,CAACyB,CAJiB,EAK/BzB,aAAa,CAAC0B,CALiB,CAArB,CAAd;AAQA,cAAMhD,iBAAiB,GAAGqB,MAAM,CAAC6B,iBAAP,CAAyB,IAAI7F,eAAJ,CAC/C,KAAKM,iBAD0C,EAE/C+E,mBAF+C,EAG/CxB,KAH+C,CAAzB,CAA1B,CA3C0F,CAiD1F;;AACAxC,UAAAA,oBAAoB,CAACyE,GAArB,CAAyBhE,KAAzB,EAAgCa,iBAAhC;AACH,S;;eAEOX,c,GAAR,wBAAwB+D,WAAxB,EAA8ChF,MAA9C,EAA8D;AAC1D,cAAMC,QAAQ,GAAG,KAAKC,SAAtB;AACA,cAAMkB,KAAK,GAAGnB,QAAQ,CAACG,iBAAvB;AAF0D,sBAIpCJ,MAAM,CAACoB,KAJ6B;AAAA,cAIlDC,SAJkD,SAIlDA,SAJkD;;AAK1D,cAAIA,SAAJ,EAAe;AACX,gBAAMC,QAAQ,GAAG,KAAKpB,SAAL,CAAeqB,aAAhC;;AACA,gBAAI,CAACH,KAAK,CAACd,oBAAN,CAA2BkB,GAA3B,CAA+BH,SAA/B,CAAL,EAAgD;AAC5C,mBAAKI,sBAAL,CAA4B,KAAKvB,SAAjC,EAA4CmB,SAA5C,EAAuDrB,MAAM,CAAC0B,MAAP,CAAcC,SAArE;AACH;;AAED,gBAAMC,iBAAiB,GAAGR,KAAK,CAACd,oBAAN,CAA2BuB,GAA3B,CAA+BR,SAA/B,CAA1B;;AACA,iBAAK,IAAIS,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKpC,OAAL,CAAaC,MAAjC,EAAyCmC,CAAC,EAA1C,EAA8C;AAC1C,kBAAMC,WAAW,GAAG,KAAKrC,OAAL,CAAaoC,CAAb,CAApB;AACAC,cAAAA,WAAW,CAACC,QAAZ,CAAqBV,QAArB,EAA+BD,SAA/B,EAA0CO,iBAA1C;AACAG,cAAAA,WAAW,CAAChC,MAAZ,CAAmBC,MAAnB;AACH;AACJ;;AAED,eAAK,IAAIiC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG+C,WAAW,CAACrF,MAAhC,EAAwCsC,CAAC,EAAzC,EAA6C;AACzC,gBAAMlB,KAAK,GAAGiE,WAAW,CAAC/C,CAAD,CAAzB;;AACA,gBAAML,mBAAiB,GAAGR,KAAK,CAACd,oBAAN,CAA2BuB,GAA3B,CAA+Bd,KAA/B,CAA1B;;AACA,gBAAMO,UAAQ,GAAGrB,QAAQ,CAACiC,eAAT,CAAyBC,wBAAzB,CAAkDF,CAAlD,CAAjB;;AAEA,gBAAI,CAACb,KAAK,CAACd,oBAAN,CAA2BkB,GAA3B,CAA+BT,KAA/B,CAAL,EAA4C;AAAE;AAAW;;AAEzD,iBAAK,IAAIe,GAAC,GAAG,CAAb,EAAgBA,GAAC,GAAG,KAAKpC,OAAL,CAAaC,MAAjC,EAAyCmC,GAAC,EAA1C,EAA8C;AAC1C,kBAAMC,aAAW,GAAG,KAAKrC,OAAL,CAAaoC,GAAb,CAApB;;AACAC,cAAAA,aAAW,CAACC,QAAZ,CAAqBV,UAArB,EAA+BP,KAA/B,EAAsCa,mBAAtC;;AACAG,cAAAA,aAAW,CAACkD,gBAAZ,CAA6BjF,MAA7B;AACH;AACJ;AACJ,S;;eAEOmB,e,GAAR,2BAA2B;AACvB,cAAMd,OAAO,GAAG,KAAKH,SAAL,CAAeE,iBAAf,CAAiCC,OAAjD;AACA,cAAM6C,aAAa,GAAG7C,OAAO,CAAC8C,IAA9B;AACA,cAAMlD,QAAQ,GAAG,KAAKC,SAAtB;AACA,cAAM+C,MAAM,GAAGhD,QAAQ,CAACgD,MAAxB;AACA,cAAM3C,oBAAoB,GAAGL,QAAQ,CAACG,iBAAT,CAA2BE,oBAAxD;AACA,cAAM8C,MAAM,GAAGhF,oBAAoB,CAAC6E,MAAD,CAApB,GAA+BvE,MAAM,CAAC2E,IAAtC,GAA6C3E,MAAM,CAAC4E,KAAnE;AAEA,cAAM4B,EAAE,GAAG5E,oBAAoB,CAACkC,MAArB,EAAX;AACA,cAAI2C,GAAG,GAAGD,EAAE,CAACE,IAAH,EAAV;;AACA,iBAAO,CAACD,GAAG,CAACE,IAAZ,EAAkB;AACd,gBAAM5C,WAAW,GAAG0C,GAAG,CAACG,KAAxB;;AACA,gBAAI,CAAC7C,WAAL,EAAkB;AACd0C,cAAAA,GAAG,GAAGD,EAAE,CAACE,IAAH,EAAN;AACA;AACH;;AAED,gBAAM1C,aAAwB,GAAG,EAAjC;AACAA,YAAAA,aAAa,CAAC5C,IAAd,CAAmBG,QAAQ,CAACgD,MAAT,CAAgBsB,aAAhB,CAA8B,IAAIvF,WAAJ,CAC7CL,WAAW,CAAC6F,KADiC,EAE7C5F,eAAe,CAAC6F,gBAAhB,GAAmC7F,eAAe,CAAC8F,OAFN,EAG7CtB,MAH6C,EAI7CF,aAAa,CAACyB,CAJ+B,EAK7CzB,aAAa,CAAC0B,CAL+B,CAA9B,CAAnB;AAQA,gBAAM9B,KAAK,GAAGL,WAAW,CAACM,mBAA1B;;AACA,gBAAID,KAAJ,EAAW;AAAEA,cAAAA,KAAK,CAACyC,MAAN,CAAarC,aAAa,CAACyB,CAA3B,EAA8BzB,aAAa,CAAC0B,CAA5C;AAAiD;;AAE9D,gBAAMY,gBAAgB,GAAG/C,WAAW,CAACgD,UAArC;AACAhD,YAAAA,WAAW,CAACL,OAAZ;AACAK,YAAAA,WAAW,CAACjD,UAAZ,CAAuB,IAAIP,eAAJ,CACnBuG,gBADmB,EAEnB9C,aAFmB,EAGnBI,KAHmB,CAAvB;AAMAqC,YAAAA,GAAG,GAAGD,EAAE,CAACE,IAAH,EAAN;AACH;;AAED/E,UAAAA,OAAO,CAACa,cAAR,GAAyB,KAAzB;AACH,S;;;QAjP2B7C,U,WAKdwB,Q,GAA4B;AACtC6F,QAAAA,IAAI,EAAEvH,oBADgC;AAEtCwH,QAAAA,QAAQ,EAAErH,mBAAmB,CAACsH,MAFQ;AAGtCC,QAAAA,GAAG,EAAE3G,aAAa,CAAC4G,KAHmB;AAItCC,QAAAA,MAAM,EAAE;AAJ8B,O"}