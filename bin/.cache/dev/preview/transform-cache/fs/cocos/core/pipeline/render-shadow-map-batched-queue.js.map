{"version":3,"sources":["../../../../../../../../../cocos/core/pipeline/render-shadow-map-batched-queue.ts"],"names":["getShadowPassIndex","subModels","shadowPassIndices","length","hasShadowPass","j","passes","shadowPassIndex","k","phase","_phaseID","push","SetIndex","getPhaseID","PipelineStateManager","BatchingSchemes","RenderInstancedQueue","RenderBatchedQueue","ShadowType","LightType","AABB","intersect","Mat4","_matShadowView","_matShadowProj","_matShadowViewProj","_ab","_shadowPassIndices","RenderShadowMapBatchedQueue","pipeline","_pipeline","_subModelsArray","_passArray","_shaderArray","_instancedQueue","_batchedQueue","gatherLightPasses","globalDS","camera","light","cmdBuff","clear","pipelineSceneData","shadowInfo","shadows","dirShadowObjects","castShadowObjects","enabled","type","ShadowMap","DIRECTIONAL","i","ro","model","add","SPOT","invert","node","getWorldMatrix","perspective","angle","aspect","range","multiply","worldBounds","transform","aabbFrustum","frustum","subModel","shadowPassIdx","pass","batchingScheme","INSTANCING","buffer","getInstancedBuffer","merge","instancedAttributes","queue","VB_MERGING","getBatchedBuffer","shader","shaders","uploadBuffers","recordCommandBuffer","device","renderPass","ia","inputAssembler","pso","getOrCreatePipelineState","descriptorSet","bindPipelineState","bindDescriptorSet","MATERIAL","LOCAL","bindInputAssembler","draw"],"mappings":"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"}