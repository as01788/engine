System.register(["./json-asset-7bb011fd.js"],(function(t){"use strict";var e,i,s,n,r,o,a,h,u,_,c,l,d,p,f,g,m,v,y,S,w,D,b,I,M,R,L,E,P,B,T,k,A,C,N,F,V,x,O,H,U,j,G,z,W,Y,Z,K,Q,q,X,J,$,tt,et,it,st,nt;return{setters:[function(t){e=t.ej,i=t.c4,s=t.cb,n=t.ae,r=t.v,o=t.fX,a=t.l,h=t.gh,u=t.eX,_=t.cp,c=t.cq,l=t.aq,d=t.cg,p=t.ef,f=t.d,g=t.bQ,m=t.gi,v=t.dF,y=t.az,S=t.H,w=t.I,D=t.x,b=t.gj,I=t.aB,M=t.L,R=t.N,L=t.gk,E=t.aY,P=t.f,B=t.dJ,T=t.gl,k=t.ed,A=t.c6,C=t.dQ,N=t.gm,F=t.F,V=t.b8,x=t.aL,O=t.bh,H=t.gn,U=t.au,j=t.z,G=t.G,z=t.go,W=t.t,Y=t.fU,Z=t.cR,K=t.cQ,Q=t.bR,q=t.bF,X=t.ew,J=t.bB,$=t.bP,tt=t.ey,et=t.dp,it=t.gp,st=t.gq,nt=t.c8}],execute:function(){var rt,ot,at,ht,ut;t({C:void 0,L:void 0,M:void 0,a:void 0,b:void 0,c:void 0,d:void 0,g:Pt}),t("O",function(){function t(){this._enabled=!1,this._minPos=new i(0,0,0),this._maxPos=new i(0,0,0),this._depth=0}var s=t.prototype;return s.initialize=function(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth},s._destroy=function(){},s.destroy=function(){this._destroy()},e(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t}},{key:"native",get:function(){return this._nativeObj}}]),t}()),function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(rt||(rt=t("C",{}))),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(ot||(ot=t("a",{}))),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(at||(at=t("b",{}))),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(ht||(ht=t("c",{}))),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(ut||(ut=t("d",{})));var _t,ct=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],lt=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],dt=[100,200,400,800],pt=new i,ft=new i,gt=new s,mt=(t("S",n.STENCIL<<1),[]),vt=t("e",function(){function t(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=rt.VERTICAL,this._fov=c(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new l(.2,.2,.2,1),this._viewport=new d(0,0,1,1),this._orientedViewport=new d(0,0,1,1),this._curTransform=r.IDENTITY,this._isProjDirty=!0,this._matView=new s,this._matProj=new s,this._matProjInv=new s,this._matViewProj=new s,this._matViewProjInv=new s,this._frustum=new p,this._forward=new i,this._position=new i,this._priority=0,this._aperture=at.F16_0,this._apertureValue=void 0,this._shutter=ut.D125,this._shutterValue=0,this._iso=ht.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=n.NONE,this._clearDepth=1,this._visibility=o,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=ct[this._aperture],this._shutterValue=lt[this._shutter],this._isoValue=dt[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!mt.length){var e=t.capabilities.clipSpaceSignY;mt[r.IDENTITY]=new s(1,0,0,0,0,e),mt[r.ROTATE_90]=new s(0,1,0,0,-e,0),mt[r.ROTATE_180]=new s(-1,0,0,0,0,-e),mt[r.ROTATE_270]=new s(0,-1,0,0,e,0)}}var g=t.prototype;return g._setWidth=function(t){this._width=t},g._setHeight=function(t){this._height=t},g._setScene=function(t){this._scene=t},g._updateAspect=function(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){var e=this.window.swapchain;(e&&e.surfaceTransform||r.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},g._init=function(){},g.initialize=function(t){this._init(t),this.node=t.node,this._setWidth(1),this._setHeight(1),this.clearFlag=n.NONE,this.clearDepth=1,this.visibility=o,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)},g._destroy=function(){},g.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},g.attachToScene=function(t){this._enabled=!0,this._setScene(t)},g.detachFromScene=function(){this._enabled=!1,this._setScene(null)},g.resize=function(t,e){this._window&&(this._setWidth(t),this._setHeight(e),this._updateAspect())},g.setFixedSize=function(t,e){this._setWidth(t),this._setHeight(e),this._updateAspect(!1),this.isWindowSize=!1},g.syncCameraEditor=function(){},g.update=function(t){var e;if(void 0===t&&(t=!1),this._node){var i=!1;(this._node.hasChangedFlags||t)&&(s.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),i=!0);var n=null===(e=this.window)||void 0===e?void 0:e.swapchain,o=n&&n.surfaceTransform||r.IDENTITY;if(this._isProjDirty||this._curTransform!==o){this._curTransform=o;var a=this._device.capabilities.clipSpaceSignY;if(this._proj===ot.PERSPECTIVE)s.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===rt.VERTICAL,this._device.capabilities.clipSpaceMinZ,a,o);else{var h=this._orthoHeight*this._aspect,u=this._orthoHeight;s.ortho(this._matProj,-h,h,-u,u,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,a,o)}s.invert(this._matProjInv,this._matProj),i=!0,this._isProjDirty=!1}i&&(s.multiply(this._matViewProj,this._matProj,this._matView),s.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},g.setViewportInOrientedSpace=function(t){var e,i=t.x,s=t.width,n=t.height,o=this._device.capabilities.screenSpaceSignY<0?1-t.y-n:t.y,a=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(a&&a.surfaceTransform||r.IDENTITY){case r.ROTATE_90:this._viewport.x=1-o-n,this._viewport.y=i,this._viewport.width=n,this._viewport.height=s;break;case r.ROTATE_180:this._viewport.x=1-i-s,this._viewport.y=1-o-n,this._viewport.width=s,this._viewport.height=n;break;case r.ROTATE_270:this._viewport.x=o,this._viewport.y=1-i-s,this._viewport.width=n,this._viewport.height=s;break;case r.IDENTITY:this._viewport.x=i,this._viewport.y=o,this._viewport.width=s,this._viewport.height=n}this._orientedViewport.x=i,this._orientedViewport.y=o,this._orientedViewport.width=s,this._orientedViewport.height=n,this.resize(this.width,this.height)},g.changeTargetWindow=function(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);var e=t||a.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;var i=e.swapchain;(i&&i.surfaceTransform||r.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}},g.detachCamera=function(){this._window&&this._window.detachCamera(this)},g.screenPointToRay=function(t,e,s){if(!this._node)return null;var n=this.width,r=this.height,o=this._orientedViewport.x*n,a=this._orientedViewport.y*r,_=this._orientedViewport.width*n,c=this._orientedViewport.height*r,l=this._proj===ot.PERSPECTIVE,d=this._device.capabilities.clipSpaceSignY,p=h[this._curTransform];i.set(pt,(e-o)/_*2-1,(s-a)/c*2-1,l?1:-1);var f=pt.x,g=pt.y;return pt.x=f*p[0]+g*p[2]*d,pt.y=f*p[1]+g*p[3]*d,i.transformMat4(l?pt:t.o,pt,this._matViewProjInv),l?(this._node.getWorldPosition(ft),u.fromPoints(t,ft,pt)):i.transformQuat(t.d,i.FORWARD,this._node.worldRotation),t},g.screenToWorld=function(t,e){var s=this.width,n=this.height,r=this._orientedViewport.x*s,o=this._orientedViewport.y*n,a=this._orientedViewport.width*s,u=this._orientedViewport.height*n,c=this._device.capabilities.clipSpaceSignY,l=h[this._curTransform];if(this._proj===ot.PERSPECTIVE){i.set(t,(e.x-r)/a*2-1,(e.y-o)/u*2-1,1);var d=t.x,p=t.y;t.x=d*l[0]+p*l[2]*c,t.y=d*l[1]+p*l[3]*c,i.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(pt),i.lerp(t,pt,t,_(this._nearClip/this._farClip,1,e.z))}else{i.set(t,(e.x-r)/a*2-1,(e.y-o)/u*2-1,2*e.z-1);var f=t.x,g=t.y;t.x=f*l[0]+g*l[2]*c,t.y=f*l[1]+g*l[3]*c,i.transformMat4(t,t,this._matViewProjInv)}return t},g.worldToScreen=function(t,e){var s=this._device.capabilities.clipSpaceSignY,n=h[this._curTransform];i.transformMat4(t,e,this._matViewProj);var r=t.x,o=t.y;t.x=r*n[0]+o*n[2]*s,t.y=r*n[1]+o*n[3]*s;var a=this.width,u=this.height,_=this._orientedViewport.x*a,c=this._orientedViewport.y*u,l=this._orientedViewport.width*a,d=this._orientedViewport.height*u;return t.x=_+.5*(t.x+1)*l,t.y=c+.5*(t.y+1)*d,t.z=.5*t.z+.5,t},g.worldMatrixToScreen=function(t,e,n,r){s.multiply(t,this._matViewProj,e),s.multiply(t,mt[this._curTransform],t);var o=n/2,a=r/2;return s.identity(gt),s.transform(gt,gt,i.set(pt,o,a,0)),s.scale(gt,gt,i.set(pt,o,a,1)),s.multiply(t,gt,t),t},g.setExposure=function(t){this._exposure=.833333/Math.pow(2,t)},g.updateExposure=function(){var t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)},e(t,[{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(t){this._proj=t,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){this._fovAxis=t,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(t){this._nearClip=t,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(t){this._farClip=t,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}},{key:"viewport",get:function(){return this._viewport},set:function(t){f(8302),this.setViewportInOrientedSpace(t)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(t){this._frustum=t}},{key:"window",get:function(){return this._window},set:function(t){this._window=t}},{key:"forward",get:function(){return this._forward},set:function(t){this._forward=t}},{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._apertureValue=ct[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._shutterValue=lt[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._isoValue=dt[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(t){this._ec=t}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),t}()),yt=new E(null),St=t("m",function(){function t(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=m.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var i=t.prototype;return i._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},i._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},i._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},i._createDescriptorSet=function(t){this._descriptorSet=this._device.createDescriptorSet(t)},i._createWorldBoundDescriptorSet=function(t){this._worldBoundDescriptorSet=this._device.createDescriptorSet(t)},i._setInputAssembler=function(t){this._inputAssembler=this._device.createInputAssembler(t)},i._setSubMesh=function(t){this._subMesh=t},i._init=function(){},i.initialize=function(t,e,i){void 0===i&&(i=null);var s=a.director.root;this._device=s.device,yt.layout=e[0].localSetLayout,this._init(),this._setInputAssembler(t.iaInfo),this._createDescriptorSet(yt);var n=a.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),r=new E(null);if(r.layout=n.localSetLayout,this._createWorldBoundDescriptorSet(r),this._setSubMesh(t),this._patches=i,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===g.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=m.DEFAULT,e[0].phase===v("reflection")){var o=s.mainWindow.width,h=s.mainWindow.height,u=512;h<o?(o=u*o/h,h=u):h=u*h/(o=u),this._reflectionTex=this._device.createTexture(new y(S.TEX2D,w.STORAGE|w.TRANSFER_SRC|w.SAMPLED,D.RGBA8,o,h)),this.descriptorSet.bindTexture(b,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new I(M.LINEAR,M.LINEAR,M.NONE,R.CLAMP,R.CLAMP,R.CLAMP)),this.descriptorSet.bindSampler(b,this._reflectionSampler),this.descriptorSet.bindTexture(L,this._reflectionTex)}},i._initNativePlanarShadowShader=function(t){this._planarShader=t.getPlanarShader(this._patches)},i.initPlanarShadowShader=function(){var t=a.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(t)},i._initNativePlanarShadowInstanceShader=function(t){this._planarInstanceShader=t.getPlanarInstanceShader(this._patches)},i.initPlanarShadowInstanceShader=function(){var t=a.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(t)},i._destroy=function(){},i.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=m.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},i.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},i.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},i.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var i=0;i<e.length;i++){var s=e[i];s.beginChangeStatesSilently(),s.tryCompile(),s.endChangeStatesSilently()}this._flushPassInfo()}},i._flushPassInfo=function(){var t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(var e=0,i=t.length;e<i;e++)this._shaders[e]=t[e].getShaderVariant(this.patches)}},e(t,[{key:"passes",get:function(){return this._passes},set:function(t){t.length>8?P(12004,8):(this._passes=t,this._flushPassInfo(),this._passes[0].batchingScheme===g.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),yt.layout=t[0].localSetLayout,this._createDescriptorSet(yt)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===g.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(t)}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),t}()),wt=new s,Dt=[{name:"CC_ENABLE_DIR_SHADOW",value:!0},{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(_t||(_t=t("M",{})));var bt=new I(M.LINEAR,M.LINEAR,M.NONE,R.CLAMP,R.CLAMP,R.CLAMP),It=new I(M.LINEAR,M.LINEAR,M.LINEAR,R.CLAMP,R.CLAMP,R.CLAMP),Mt=(t("i",function(){function t(){this.type=_t.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(T.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new A,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=B.Enum.NONE,this._device=a.director.root.device}var i=t.prototype;return i._setReceiveShadow=function(t){this._receiveShadow=t},i._init=function(){},i.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=B.Enum.NONE,this._inited=!0)},i._destroySubmodel=function(t){t.destroy()},i._destroy=function(){},i.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var i=this._subModels[e];this._destroySubmodel(i)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},i.attachToScene=function(t){this.scene=t,this._localDataUpdated=!0},i.detachFromScene=function(){this.scene=null},i.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},i.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},i._applyLocalData=function(){},i._applyLocalBuffer=function(){},i._applyWorldBoundBuffer=function(){},i.updateUBOs=function(t){for(var e=this._subModels,i=0;i<e.length;i++)e[i].update();if(this._updateStamp=t,this._localDataUpdated){this._localDataUpdated=!1;var n,r,o,a,h=this.transform._mat,u=this._instMatWorldIdx;if(u>=0){var _=this.instancedAttributes.views;n=h,r=_[u],o=_[u+1],a=_[u+2],r[0]=n.m00,r[1]=n.m01,r[2]=n.m02,r[3]=n.m12,o[0]=n.m04,o[1]=n.m05,o[2]=n.m06,o[3]=n.m13,a[0]=n.m08,a[1]=n.m09,a[2]=n.m10,a[3]=n.m14}else if(this._localBuffer){s.toArray(this._localData,h,T.MAT_WORLD_OFFSET),s.inverseTranspose(wt,h);var c=Math.abs(s.determinant(wt)),l=1/Math.sqrt(c);s.multiplyScalar(wt,wt,l),s.toArray(this._localData,wt,T.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},i._updateNativeBounds=function(){},i.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=k.fromPoints(k.create(),t,e),this._worldBounds=k.clone(this._modelBounds),this._updateNativeBounds())},i._createSubModel=function(){return new St},i.initSubModel=function(t,e,i){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,i.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t)},i.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},i.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},i.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},i.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},i.updateLightingmap=function(t,e){A.toArray(this._localData,e,T.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=C.get("empty-texture"));var i=t.getGFXTexture();if(i)for(var s=this._device.getSampler(t.mipmaps.length>1?It:bt),n=this._subModels,r=0;r<n.length;r++){var o=n[r].descriptorSet;o.bindTexture(N,i),o.bindSampler(N,s),o.update()}},i.getMacroPatches=function(){return this.receiveShadow?Dt:null},i._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);var i=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(i.attributes,e.passes[0])}},i._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,i=0;i<e.length;i++)if(e[i].name===t)return i;return-1},i._setInstMatWorldIdx=function(t){this._instMatWorldIdx=t},i._updateInstancedAttributes=function(t,e){if(e.device.hasFeature(F.INSTANCED_ARRAYS)){for(var i=0,s=0;s<t.length;s++){var n=t[s];n.isInstanced&&(i+=V[n.format].size)}var r=this.instancedAttributes;r.buffer=new Uint8Array(i),r.views.length=r.attributes.length=0;for(var o=0,a=0;a<t.length;a++){var h=t[a];if(h.isInstanced){var u=new x;u.format=h.format,u.name=h.name,u.isNormalized=h.isNormalized,u.location=h.location,r.attributes.push(u);var _=V[h.format],c=new(O(_))(r.buffer.buffer,o,_.count);r.views.push(c),o+=_.size}}e.batchingScheme===g.INSTANCING&&e.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(H)),this._localDataUpdated=!0}},i._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new U(j.UNIFORM|j.TRANSFER_DST,G.DEVICE,T.SIZE,T.SIZE)),this._applyLocalBuffer())},i._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new U(j.UNIFORM|j.TRANSFER_DST,G.DEVICE,z.SIZE,z.SIZE)),this._applyWorldBoundBuffer())},i._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(T.BINDING,this._localBuffer)},i._updateWorldBoundDescriptors=function(t,e){this._worldBoundBuffer&&e.bindBuffer(z.BINDING,this._worldBoundBuffer)},e(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._setReceiveShadow(t),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"native",get:function(){return this._nativeObj}}]),t}()),t("R",function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var i=t.prototype;return i.initialize=function(t){return this._name=t.name,!0},i.activate=function(){},i.update=function(t){var e=this._mainLight;e&&e.update();for(var i=this._sphereLights,s=0;s<i.length;s++)i[s].update();for(var n=this._spotLights,r=0;r<n.length;r++)n[r].update();for(var o=this._models,a=0;a<o.length;a++){var h=o[a];h.enabled&&(h.updateTransform(t),h.updateUBOs(t))}},i._destroy=function(){},i.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},i.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},i.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},i.removeCameras=function(){for(var t,e=W(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},i.setMainLight=function(t){this._mainLight=t},i.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Y.ROTATION));this.setMainLight(null)}},i.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},i.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},i.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t)},i.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),void this._sphereLights.splice(e,1)},i.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t)},i.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),void this._spotLights.splice(e,1)},i.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0},i.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[]},i.addModel=function(t){t.attachToScene(this),this._models.push(t)},i.removeModel=function(t){for(var e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),void this._models.splice(e,1)},i.removeModels=function(){for(var t,e=W(this._models);!(t=e()).done;){var i=t.value;i.detachFromScene(),i.destroy()}this._models.length=0},i.addBatch=function(t){this._batches.push(t)},i.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return void this._batches.splice(e,1)},i.removeBatches=function(){this._batches.length=0},i.onGlobalPipelineStateChanged=function(){for(var t,e=W(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},i.generateModelId=function(){return this._modelId++},i._createNativeObject=function(){},e(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),t}()));Z(Mt.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Z(Mt.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var Rt=t("f",{});Z(Rt,"CameraVisFlags",[{name:"GENERAL"}]),K(Rt,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:B.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:B.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:B.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:B.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:B.BitMask,targetName:"UI_2D"}]),a.CameraVisFlags=Rt;var Lt,Et=t("V",{});function Pt(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);var i=e*e,s=(.860117757+.000154118254*e+1.28641212e-7*i)/(1+.000842420235*e+7.08145163e-7*i),n=(.317398726+422806245e-13*e+4.20481691e-8*i)/(1-289741816e-13*e+1.61456053e-7*i),r=2*s-8*n+4,o=3*s/r,a=2*n/r,h=1/a*o,u=1/a*(1-o-a);t.x=3.2404542*h-1.5371385+-.4985314*u,t.y=-.969266*h+1.8760108+.041556*u,t.z=.0556434*h-.2040259+1.0572252*u}Z(Et,"VisibilityFlags",[{name:"GENERAL"}]),K(Et,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:B.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:B.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:B.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:B.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:B.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:B.Enum,targetName:"UI_2D"}]),a.VisibilityFlags=Et,K(Q.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),Z(vt.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),Z(q.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(Lt||(Lt=t("L",{})));var Bt=t("n",(function(t){return 4*Math.PI*Math.PI*t*t})),Tt=t("h",function(){function t(){this._baked=!1,this._color=new i(1,1,1),this._colorTemp=6550,this._colorTempRGB=new i(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Lt.UNKNOWN}var s=t.prototype;return s._init=function(){},s._destroy=function(){},s.initialize=function(){this._init(),this.color=new i(1,1,1),this.colorTemperature=6550},s.attachToScene=function(t){this._scene=t},s.detachFromScene=function(){this._scene=null},s.destroy=function(){this._name=null,this._node=null,this._destroy()},s.update=function(){},e(t,[{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"color",get:function(){return this._color},set:function(t){this._color.set(t)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(t){this._colorTemp=t,Pt(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,this._node&&(this._node.hasChangedFlags|=Y.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),t}()),kt=new i(0,0,-1),At=new i,Ct=(t("D",function(t){function s(){var e;return(e=t.call(this)||this)._dir=new i(1,-1,-1),e._illuminanceHDR=J.SUN_ILLUM,e._illuminanceLDR=1,e._type=Lt.DIRECTIONAL,e}X(s,t);var n=s.prototype;return n.initialize=function(){t.prototype.initialize.call(this),this.illuminance=J.SUN_ILLUM,this.direction=new i(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=i.transformQuat(At,kt,this._node.worldRotation))},e(s,[{key:"direction",get:function(){return this._dir},set:function(t){i.normalize(this._dir,t)}},{key:"illuminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){a.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(t){this._illuminanceHDR=t}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(t){this._illuminanceLDR=t}}]),s}(Tt)),t("P",function(t){function i(e,i){var s;(s=t.call(this,e.root)||this)._parent=void 0,s._owner=void 0,s._dontNotify=!1,s._parent=e,s._owner=i,s._doInit(s._parent,!0);for(var n=0;n<s._shaderInfo.blocks.length;n++){var r=s._shaderInfo.blocks[n],o=s._blocks[r.binding],a=s._parent.blocks[r.binding];o.set(a)}s._setRootBufferDirty(!0);for(var h=s._parent,u=0;u<s._shaderInfo.samplerTextures.length;u++)for(var _=s._shaderInfo.samplerTextures[u],c=0;c<_.count;c++){var l=h._descriptorSet.getSampler(_.binding,c),d=h._descriptorSet.getTexture(_.binding,c);s._descriptorSet.bindSampler(_.binding,l,c),s._descriptorSet.bindTexture(_.binding,d,c)}return t.prototype.tryCompile.call(tt(s)),s}X(i,t);var s=i.prototype;return s.overridePipelineStates=function(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),Q.fillPipelineInfo(this,t),Q.fillPipelineInfo(this,e),this._onStateChange()},s.tryCompile=function(e){if(e&&!$(this._defines,e))return!1;var i=t.prototype.tryCompile.call(this);return this._onStateChange(),i},s.beginChangeStatesSilently=function(){this._dontNotify=!0},s.endChangeStatesSilently=function(){this._dontNotify=!1},s._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(g.NONE)},s._onStateChange=function(){this._setHash(Q.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},e(i,[{key:"parent",get:function(){return this._parent}}]),i}(Q))),Nt=t("o",function(t){function i(e){var i;return(i=t.call(this)||this)._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=e.parent,i._owner=e.owner||null,i._subModelIdx=e.subModelIdx||0,i.copy(i._parent),i}X(i,t);var s=i.prototype;return s.recompileShaders=function(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(var i,s=W(this._passes);!(i=s()).done;)i.value.tryCompile(t);else this._passes[e].tryCompile(t)},s.overridePipelineStates=function(t,e){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(var s=0;s<this._passes.length;s++){var n=this._passes[s],r=this._states[s]||(this._states[s]={});for(var o in t)r[o]=t[o];n.overridePipelineStates(i[n.passIndex],r)}else{var a=this._states[e]||(this._states[e]={});for(var h in t)a[h]=t[h];this._passes[e].overridePipelineStates(i[e],a)}}},s.destroy=function(){return this._doDestroy(),!0},s.onPassStateChange=function(t){this._hash=et.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},s._createPasses=function(){var t=[],e=this._parent.passes;if(!e)return t;for(var i=0;i<e.length;++i)t.push(new Ct(e[i],this));return t},e(i,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),i}(et)),Ft=null,Vt=null,xt=t("j",function(){function t(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var i=t.prototype;return i._setEnabled=function(t){this._enabled=t},i._setUseIBL=function(t){this._useIBL=t},i._setUseHDR=function(t){this._useHDR=t},i._setUseDiffuseMap=function(t){this._useDiffuseMap=t},i.initialize=function(t){this._setEnabled(t.enabled),this._setUseIBL(t.useIBL),this._setUseDiffuseMap(t.applyDiffuseMap),this._setUseHDR(t.useHDR)},i.setEnvMaps=function(t,e){this._envmapHDR=t,this._envmapLDR=e;var i=a.director.root;i.pipeline.pipelineSceneData.isHDR?t&&(i.pipeline.pipelineSceneData.ambient.groundAlbedo.w=t.mipmapLevel):e&&(i.pipeline.pipelineSceneData.ambient.groundAlbedo.w=e.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},i.setDiffuseMaps=function(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()},i.activate=function(){var t=a.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=C.get("default-cube-texture"),this._model||(this._model=a.director.root.createModel(a.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var e=this._default.isRGBE;if(this.envmap&&(e=this.envmap.isRGBE),!Vt){var i=new et;i.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:e}}),Vt=new Nt({parent:i})}this.enabled&&(Ft||(Ft=a.utils.createMesh(a.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,Ft.renderingSubMeshes[0],Vt)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},i._updatePipeline=function(){this.enabled&&Vt&&Vt.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,Vt);var t=a.director.root,e=t.pipeline,i=this.useIBL?this.isRGBE?2:1:0,s=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,n=this.useHDR;e.macros.CC_USE_IBL===i&&e.macros.CC_USE_DIFFUSEMAP===s&&e.macros.CC_USE_HDR===n||(e.macros.CC_USE_IBL=i,e.macros.CC_USE_DIFFUSEMAP=s,e.macros.CC_USE_HDR=n,t.onGlobalPipelineStateChanged())},i._updateGlobalBinding=function(){if(this._globalDSManager){var t=a.director.root.device,e=this.envmap?this.envmap:this._default;if(e){var i=e.getGFXTexture(),s=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(it,s),this._globalDSManager.bindTexture(it,i)}var n=this.diffuseMap?this.diffuseMap:this._default;if(n){var r=n.getGFXTexture(),o=t.getSampler(n.getSamplerInfo());this._globalDSManager.bindSampler(st,o),this._globalDSManager.bindTexture(st,r)}this._globalDSManager.update()}},i._destroy=function(){},i.destroy=function(){this._destroy()},e(t,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnabled(t),t?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(t){this._setUseHDR(t),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._setUseIBL(t),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(t){this._useDiffuseMap=t,this._updateGlobalBinding(),this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){a.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}},{key:"diffuseMap",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){a.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}},{key:"native",get:function(){return this._nativeObj}}]),t}());a.Skybox=xt,t("k",function(t){X(n,t);var s=n.prototype;function n(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=k.create(),e._pos=new i,e._type=Lt.SPHERE,e}return s._init=function(){t.prototype._init.call(this)},s._destroy=function(){t.prototype._destroy.call(this)},s.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/Bt(.15),this.luminanceLDR=1},s.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=this._range;k.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}},e(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){a.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",set:function(t){this._luminanceLDR=t}},{key:"aabb",get:function(){return this._aabb}}]),n}(Tt));var Ot=new i(0,0,-1),Ht=new nt,Ut=new s,jt=new s,Gt=new s,zt=new s;t("l",function(t){X(r,t);var n=r.prototype;function r(){var e;return(e=t.call(this)||this)._dir=new i(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._aspect=0,e._aabb=k.create(),e._frustum=p.create(),e._pos=new i,e._type=Lt.SPOT,e}return n._init=function(){t.prototype._init.call(this)},n._destroy=function(){t.prototype._destroy.call(this)},n._setDirection=function(t){this._dir.set(t)},n.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/Bt(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new i(1,-1,-1))},n.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),i.transformQuat(this._dir,Ot,this._node.getWorldRotation(Ht)),i.normalize(this._dir,this._dir),k.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Ut),s.invert(Ut,Ut),s.perspective(jt,this._angle,1,.001,this._range),s.multiply(Gt,jt,Ut),this._frustum.update(Gt,zt),this._needUpdate=!1)},e(r,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){a.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(t){this._luminanceLDR=t}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(t){this._aspect=t,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),r}(Tt))}}}));
