System.register(["./json-asset-7bb011fd.js","./index-07e0e256.js","./spot-light-44c8b89f.js","./texture-buffer-pool-2b0fe4d4.js","./deprecated-229f0693.js","./renderable-component-0ffd84e0.js","./transform-utils-ec8404a7.js","./terrain-asset-0aafabc0.js"],(function(t){"use strict";var e,i,r,n,s,a,o,l,h,u,_,f,c,d,g,p,b,v,y,M,w,m,x,z,k,I,S,C,A,L,E,B,P,R,N,T,D,U,O,H,V,F,W,j,X,G,K,Y,q,Q,Z,J,$,tt,et,it,rt,nt;return{setters:[function(t){e=t.cn,i=t.eq,r=t.ej,n=t.er,s=t.ew,a=t.l,o=t.dp,l=t.dQ,h=t.c2,u=t.c4,_=t.au,f=t.z,c=t.G,d=t.aL,g=t.b7,p=t.x,b=t.dg,v=t.a4,y=t.c6,M=t.cg,w=t.dl,m=t.fH,x=t.gE,z=t.h7,k=t.ev,I=t.dn,S=t.d5,C=t.d4,A=t.fT,L=t.gQ,E=t.c_,B=t.ez,P=t.es,R=t.ce,N=t.et,T=t.dH,D=t.cZ,U=t.fV,O=t.gG,H=t.ey,V=t.dO,F=t.gL},function(t){W=t.d},function(t){j=t.i},function(){},function(t){X=t.j},function(t){G=t.R},function(){},function(e){K=e.a,Y=e.b,q=e.c,Q=e.T,Z=e.d,J=e.e,$=e.f,tt=e.g,et=e.h,it=e.i,rt=e.j,nt=e.k;var i={};i.TERRAIN_BLOCK_TILE_COMPLEXITY=e.b,i.TERRAIN_BLOCK_VERTEX_COMPLEXITY=e.a,i.TERRAIN_BLOCK_VERTEX_SIZE=e.c,i.TERRAIN_DATA_VERSION=e.q,i.TERRAIN_DATA_VERSION2=e.r,i.TERRAIN_DATA_VERSION3=e.s,i.TERRAIN_DATA_VERSION4=e.t,i.TERRAIN_DATA_VERSION5=e.j,i.TERRAIN_DATA_VERSION_DEFAULT=e.u,i.TERRAIN_EAST_INDEX=e.p,i.TERRAIN_HEIGHT_BASE=e.g,i.TERRAIN_HEIGHT_FACTORY=e.h,i.TERRAIN_HEIGHT_FMAX=e.e,i.TERRAIN_HEIGHT_FMIN=e.f,i.TERRAIN_MAX_BLEND_LAYERS=e.i,i.TERRAIN_MAX_LAYER_COUNT=e.k,i.TERRAIN_MAX_LEVELS=e.l,i.TERRAIN_NORTH_INDEX=e.m,i.TERRAIN_SOUTH_INDEX=e.n,i.TERRAIN_WEST_INDEX=e.o,i.TerrainAsset=e.T,i.TerrainLayerBinaryInfo=e.v,i.TerrainLayerInfo=e.d,t(i)}],execute:function(){t("HeightField",function(){function t(t,e){this.data=new Uint16Array,this.w=0,this.h=0,this.w=t,this.h=e,this.data=new Uint16Array(t*e);for(var i=0;i<t*e;++i)this.data[i]=0}var i=t.prototype;return i.set=function(t,e,i){this.data[e*this.w+t]=i},i.get=function(t,e){return this.data[e*this.w+t]},i.getClamp=function(t,i){return t=e(t,0,this.w-1),i=e(i,0,this.h-1),this.get(t,i)},i.getAt=function(t,i){var r=t,n=i,s=Math.floor(r),a=Math.floor(n),o=s+1,l=a+1,h=r-s,u=n-a;s=e(s,0,this.w-1),a=e(a,0,this.h-1),o=e(o,0,this.w-1),l=e(l,0,this.h-1);var _=this.get(s,a),f=this.get(o,a),c=this.get(s,l),d=this.get(o,l),g=.5*(f+c);return h+u<=1?d=g+(g-_):_=g+(g-d),(_*(1-h)+f*h)*(1-u)+(c*(1-h)+d*h)*u},t}());var st,at,ot,lt,ht,ut,_t,ft,ct,dt,gt,pt,bt,vt,yt,Mt,wt,mt,xt,zt,kt,It,St,Ct,At,Lt,Et,Bt,Pt,Rt,Nt,Tt,Dt,Ut,Ot,Ht,Vt,Ft,Wt,jt,Xt,Gt,Kt,Yt,qt,Qt,Zt,Jt,$t=33,te=1e14,ee=function(){function t(){this.level=0,this.north=0,this.south=0,this.west=0,this.east=0}return t.prototype.equals=function(t){return this.level===t.level&&this.north===t.north&&this.south===t.south&&this.west===t.west&&this.east===t.east},t}(),ie=function(){this.size=0,this.indices=null},re=function(){this.key=new ee,this.start=0,this.size=0,this.buffer=null,this.primCount=0},ne=function(){function t(){this._bodyIndexPool=void 0,this._connecterIndexPool=void 0,this._indexMap=[],this._indexBuffer=new Uint16Array,this._bodyIndexPool=new Array(4);for(var e=0;e<4;++e)this._bodyIndexPool[e]=new ie;this._connecterIndexPool=new Array(64);for(var i=0;i<4;++i)for(var r=0;r<4;++r)for(var n=0;n<4;++n)this._connecterIndexPool[t.mapIndex(i,r,n)]=new ie;for(var s=0;s<4;++s)this._genBodyIndex(s);for(var a=0;a<4;++a)for(var o=0;o<4;++o)this._genConnecterIndexNorth(a,o),this._genConnecterIndexSouth(a,o),this._genConnecterIndexWest(a,o),this._genConnecterIndexEast(a,o);for(var l=0;l<4;++l)for(var h=0;h<4;++h)if(!(h<l))for(var u=0;u<4;++u)if(!(u<l))for(var _=0;_<4;++_)if(!(_<l))for(var f=0;f<4;++f)if(!(f<l)){var c=new ee;c.level=l,c.north=h,c.south=u,c.west=_,c.east=f,this._genIndexData(c)}}t.mapIndex=function(t,e,i){return 16*t+4*e+i};var e=t.prototype;return e.getIndexData=function(t){for(var e=0;e<this._indexMap.length;++e)if(this._indexMap[e].key.equals(t))return this._indexMap[e];return null},e._genBodyIndex=function(t){var e=1<<t,i=32>>t,r=0;if(t<3&&(i-=2,r=e*$t+e),0!==i&&0!==i){var n=i*i*6;this._bodyIndexPool[t].indices=new Uint16Array(n);for(var s=0,a=new Uint16Array(n),o=r,l=o+$t*e,h=0;h<i;++h){for(var u=0;u<i;++u)a[s++]=l+u*e,a[s++]=l+(u+1)*e,a[s++]=o+u*e,a[s++]=l+(u+1)*e,a[s++]=o+(u+1)*e,a[s++]=o+u*e;o+=$t*e,l+=$t*e}this._bodyIndexPool[t].size=s,this._bodyIndexPool[t].indices=a}},e._genConnecterIndexNorth=function(e,i){var r=t.mapIndex(e,i,0);if(i<e||3===e)return this._connecterIndexPool[r].size=0,void(this._connecterIndexPool[r].indices=null);var n=1<<e,s=1<<i,a=32>>e,o=0,l=new Uint16Array(2*a+2);l[o++]=0,l[o++]=0;for(var h=1;h<a;++h){var u=h*n,_=n*$t+u,f=(n-n)*$t+u/s*s;l[o++]=_,l[o++]=f}l[o++]=32,l[o++]=32,this._connecterIndexPool[r].size=o,this._connecterIndexPool[r].indices=l},e._genConnecterIndexSouth=function(e,i){var r=t.mapIndex(e,i,1);if(i<e||3===e)return this._connecterIndexPool[r].size=0,void(this._connecterIndexPool[r].indices=null);var n=1<<e,s=1<<i,a=32>>e,o=0,l=new Uint16Array(2*a+2);l[o++]=1056,l[o++]=1056;for(var h=1;h<a;++h){var u=h*n,_=32-n,f=(_+n)*$t+u/s*s,c=_*$t+u;l[o++]=f,l[o++]=c}l[o++]=1088,l[o++]=1088,this._connecterIndexPool[r].size=o,this._connecterIndexPool[r].indices=l},e._genConnecterIndexWest=function(e,i){var r=t.mapIndex(e,i,2);if(i<e||3===e)return this._connecterIndexPool[r].size=0,void(this._connecterIndexPool[r].indices=null);var n=1<<e,s=1<<i,a=32>>e,o=0,l=new Uint16Array(2*a+2);l[o++]=0,l[o++]=0;for(var h=1;h<a;++h){var u=h*n/s*s*$t+0,_=h*n*$t+n;l[o++]=u,l[o++]=_}l[o++]=1056,l[o++]=1056,this._connecterIndexPool[r].size=o,this._connecterIndexPool[r].indices=l},e._genConnecterIndexEast=function(e,i){var r=t.mapIndex(e,i,3);if(i<e||3===e)return this._connecterIndexPool[r].size=0,void(this._connecterIndexPool[r].indices=null);var n=1<<e,s=1<<i,a=32>>e,o=0,l=new Uint16Array(2*a+2);l[o++]=32,l[o++]=32;for(var h=1;h<a;++h){var u=h*n*$t+(32-n),_=h*n/s*s*$t+32;l[o++]=u,l[o++]=_}l[o++]=1088,l[o++]=1088,this._connecterIndexPool[r].size=o,this._connecterIndexPool[r].indices=l},e._getConnenterIndex=function(e,i,r){return this._connecterIndexPool[t.mapIndex(e,i,r)]},e._genIndexData=function(t){var e=this.getIndexData(t);if(null!=e)return e;var i=this._bodyIndexPool[t.level],r=this._getConnenterIndex(t.level,t.north,0),n=this._getConnenterIndex(t.level,t.south,1),s=this._getConnenterIndex(t.level,t.west,2),a=this._getConnenterIndex(t.level,t.east,3);if((e=new re).size=0,e.primCount=0,null!=i.indices&&(e.size+=i.size),r.indices&&(e.size+=3*(r.size-2)),n.indices&&(e.size+=3*(n.size-2)),s.indices&&(e.size+=3*(s.size-2)),a.indices&&(e.size+=3*(a.size-2)),0===e.size)return null;var o=0;if(e.buffer=new Uint16Array(e.size),e.key.level=t.level,e.key.east=t.east,e.key.west=t.west,e.key.north=t.north,e.key.south=t.south,i.indices)for(var l=0;l<i.size;++l)e.buffer[o++]=i.indices[l];if(r.indices)for(var h=0;h<r.size-2;h+=2){var u=r.indices[h+0],_=r.indices[h+1],f=r.indices[h+2],c=r.indices[h+3];e.buffer[o++]=u,e.buffer[o++]=f,e.buffer[o++]=_,e.buffer[o++]=f,e.buffer[o++]=c,e.buffer[o++]=_}if(n.indices)for(var d=0;d<n.size-2;d+=2){var g=n.indices[d+0],p=n.indices[d+1],b=n.indices[d+2],v=n.indices[d+3];e.buffer[o++]=g,e.buffer[o++]=b,e.buffer[o++]=p,e.buffer[o++]=b,e.buffer[o++]=v,e.buffer[o++]=p}if(s.indices)for(var y=0;y<s.size-2;y+=2){var M=s.indices[y+0],w=s.indices[y+1],m=s.indices[y+2],x=s.indices[y+3];e.buffer[o++]=M,e.buffer[o++]=m,e.buffer[o++]=w,e.buffer[o++]=m,e.buffer[o++]=x,e.buffer[o++]=w}if(a.indices)for(var z=0;z<a.size-2;z+=2){var k=a.indices[z+0],I=a.indices[z+1],S=a.indices[z+2],C=a.indices[z+3];e.buffer[o++]=k,e.buffer[o++]=S,e.buffer[o++]=I,e.buffer[o++]=S,e.buffer[o++]=C,e.buffer[o++]=I}e.primCount=o/3,e.start=this._indexBuffer.length,this._indexMap.push(e);var A=new Uint16Array(e.start+e.size);return A.set(this._indexBuffer,0),A.set(e.buffer,e.start),this._indexBuffer=A,e},t}(),se=t("TerrainInfo",i("cc.TerrainInfo")((_t=function(){function t(){P(this,"tileSize",ot,this),P(this,"blockCount",lt,this),P(this,"weightMapSize",ht,this),P(this,"lightMapSize",ut,this)}return r(t,[{key:"size",get:function(){var t=new R(0,0);return t.width=this.blockCount[0]*Y*this.tileSize,t.height=this.blockCount[1]*Y*this.tileSize,t}},{key:"tileCount",get:function(){var t=[0,0];return t[0]=this.blockCount[0]*Y,t[1]=this.blockCount[1]*Y,t}},{key:"vertexCount",get:function(){var t=this.tileCount;return t[0]+=1,t[1]+=1,t}}]),t}(),ot=n((at=_t).prototype,"tileSize",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt=n(at.prototype,"blockCount",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),ht=n(at.prototype,"weightMapSize",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),ut=n(at.prototype,"lightMapSize",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),st=at))||st),ae=t("TerrainLayer",i("cc.TerrainLayer")((dt=n((ct=function(){P(this,"detailMap",dt,this),P(this,"normalMap",gt,this),P(this,"tileSize",pt,this),P(this,"metallic",bt,this),P(this,"roughness",vt,this)}).prototype,"detailMap",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gt=n(ct.prototype,"normalMap",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pt=n(ct.prototype,"tileSize",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bt=n(ct.prototype,"metallic",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vt=n(ct.prototype,"roughness",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ft=ct))||ft),oe=function(t){function e(){for(var e,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(e=t.call.apply(t,[this].concat(r))||this)._model=null,e._meshData=null,e._brushPass=null,e._brushMaterial=null,e._currentMaterial=null,e._currentMaterialLayers=0,e}s(e,t);var i=e.prototype;return i.destroy=function(){return null!=this._model&&(a.director.root.destroyModel(this._model),this._model=null),t.prototype.destroy.call(this)},i._destroyModel=function(){null!=this._model&&(a.director.root.destroyModel(this._model),this._model=null)},i._invalidMaterial=function(){null!=this._currentMaterial&&(this._clearMaterials(),this._brushPass=null,this._currentMaterial=null,null!=this._model&&(this._model.enabled=!1))},i._updateMaterial=function(t,e){if(null!=this._meshData&&null!=this._model){var i=t.getMaxLayer();if(null==this._currentMaterial||i!==this._currentMaterialLayers){if(this._currentMaterial=new o,this._currentMaterial.initialize({effectAsset:t.getTerrain().getEffectAsset(),defines:t._getMaterialDefines(i)}),null!==this._brushMaterial){var r=new o;r.copy(this._brushMaterial),this._brushPass=null,null!==r.passes&&r.passes.length>0&&(this._brushPass=r.passes[0],this._currentMaterial.passes.push(this._brushPass),r.passes.pop())}e&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0,this._model.receiveShadow=t.getTerrain().receiveShadow}}},i._onMaterialModified=function(t,e){null!=this._model&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},i._onRebuildPSO=function(t,e){this._model&&this._model.setSubModelMaterial(t,e)},i._clearMaterials=function(){null!=this._model&&this._onMaterialModified(0,null)},i._getBuiltinMaterial=function(){return l.get("missing-material")},e}(G),le=t("TerrainBlockLightmapInfo",i("cc.TerrainBlockLightmapInfo")((wt=n((Mt=function(){P(this,"texture",wt,this),P(this,"UOff",mt,this),P(this,"VOff",xt,this),P(this,"UScale",zt,this),P(this,"VScale",kt,this)}).prototype,"texture",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mt=n(Mt.prototype,"UOff",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xt=n(Mt.prototype,"VOff",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zt=n(Mt.prototype,"UScale",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kt=n(Mt.prototype,"VScale",[N,B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yt=Mt))||yt),he=t("TerrainBlock",function(){function t(t,e,i){this._terrain=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._lightmapInfo=null,this._lodLevel=0,this._lodKey=new ee,this._errorMetrics=[0,0,0,0],this._LevelDistances=[te,te,te,te],this._bbMin=new u,this._bbMax=new u,this._terrain=t,this._index[0]=e,this._index[1]=i,this._lightmapInfo=t._getLightmapInfo(e,i),this._node=new T("TerrainBlock"),this._node.setParent(this._terrain.node),this._node.hideFlags|=D.Flags.DontSave|D.Flags.HideInHierarchy,this._node.layer=this._terrain.node.layer,this._renderable=this._node.addComponent(oe)}var e=t.prototype;return e.build=function(){var t=W.root.device,e=new Float32Array(q*K*K),i=0;this._bbMin.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._bbMax.set(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);for(var r=0;r<K;++r)for(var n=0;n<K;++n){var s=this._index[0]*Y+n,o=this._index[1]*Y+r,l=this._terrain.getPosition(s,o),y=this._terrain.getNormal(s,o),M=new h(n/Y,r/Y);e[i++]=l.x,e[i++]=l.y,e[i++]=l.z,e[i++]=y.x,e[i++]=y.y,e[i++]=y.z,e[i++]=M.x,e[i++]=M.y,u.min(this._bbMin,this._bbMin,l),u.max(this._bbMax,this._bbMax,l)}var w=t.createBuffer(new _(f.VERTEX|f.TRANSFER_DST,c.DEVICE,q*Float32Array.BYTES_PER_ELEMENT*K*K,q*Float32Array.BYTES_PER_ELEMENT));w.update(e);var m=[new d(g.ATTR_POSITION,p.RGB32F),new d(g.ATTR_NORMAL,p.RGB32F),new d(g.ATTR_TEX_COORD,p.RG32F)];this._renderable._meshData=new b([w],m,v.TRIANGLE_LIST,this._terrain._getSharedIndexBuffer()),this._renderable._model=a.director.root.createModel(j),this._renderable._model.createBoundingShape(this._bbMin,this._bbMax),this._renderable._model.node=this._renderable._model.transform=this._node,null!=this._renderable.node.scene&&(this.visible=!0),this._updateWeightMap(),this._updateMaterial(!0),this._updateLodBuffer(e),this._updateIndexBuffer()},e.rebuild=function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)},e.destroy=function(){this.visible=!1,this._renderable._destroyModel(),null!=this._node&&this._node.isValid&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()},e.update=function(){this._updateMaterial(!1);var t=this._terrain.useNormalMap,e=this._terrain.usePBR,i=function(t){return null!==t?t.detailMap:null},r=function(t){var e=null!==t?t.normalMap:null;return null===e&&(e=a.builtinResMgr.get("normal-texture")),e},n=this._renderable._currentMaterial;if(null!==n){var s=this.getMaxLayer(),o=new y(1,1,1,1),l=new y(1,1,1,1),h=new y(0,0,0,0);if(0===s)if(-1!==this.layers[0]){var u=this._terrain.getLayer(this.layers[0]);null!==u&&(o.x=1/u.tileSize,l.x=u.roughness,h.x=u.metallic),n.setProperty("detailMap0",i(u)),t&&n.setProperty("normalMap0",r(u))}else n.setProperty("detailMap0",a.builtinResMgr.get("default-texture")),t&&n.setProperty("normalMap0",a.builtinResMgr.get("normal-texture"));else if(1===s){var _=this._terrain.getLayer(this.layers[0]),f=this._terrain.getLayer(this.layers[1]);null!==_&&(o.x=1/_.tileSize,l.x=_.roughness,h.x=_.metallic),null!==f&&(o.y=1/f.tileSize,l.y=f.roughness,h.y=f.metallic),n.setProperty("weightMap",this._weightMap),n.setProperty("detailMap0",i(_)),n.setProperty("detailMap1",i(f)),t&&(n.setProperty("normalMap0",r(_)),n.setProperty("normalMap1",r(f)))}else if(2===s){var c=this._terrain.getLayer(this.layers[0]),d=this._terrain.getLayer(this.layers[1]),g=this._terrain.getLayer(this.layers[2]);null!==c&&(o.x=1/c.tileSize,l.x=c.roughness,h.x=c.metallic),null!==d&&(o.y=1/d.tileSize,l.y=d.roughness,h.y=d.metallic),null!==g&&(o.z=1/g.tileSize,l.z=g.roughness,h.z=g.metallic),n.setProperty("weightMap",this._weightMap),n.setProperty("detailMap0",i(c)),n.setProperty("detailMap1",i(d)),n.setProperty("detailMap2",i(g)),t&&(n.setProperty("normalMap0",r(c)),n.setProperty("normalMap1",r(d)),n.setProperty("normalMap2",r(g)))}else if(3===s){var p=this._terrain.getLayer(this.layers[0]),b=this._terrain.getLayer(this.layers[1]),v=this._terrain.getLayer(this.layers[2]),M=this._terrain.getLayer(this.layers[3]);null!==p&&(o.x=1/p.tileSize,l.x=p.roughness,h.x=p.metallic),null!==b&&(o.y=1/b.tileSize,l.y=b.roughness,h.y=b.metallic),null!==v&&(o.z=1/v.tileSize,l.z=v.roughness,h.z=v.metallic),null!==M&&(o.w=1/M.tileSize,l.w=M.roughness,h.w=M.metallic),n.setProperty("weightMap",this._weightMap),n.setProperty("detailMap0",i(p)),n.setProperty("detailMap1",i(b)),n.setProperty("detailMap2",i(v)),n.setProperty("detailMap3",i(M)),t&&(n.setProperty("normalMap0",r(p)),n.setProperty("normalMap1",r(b)),n.setProperty("normalMap2",r(v)),n.setProperty("normalMap3",r(M)))}n.setProperty("UVScale",o),e&&(n.setProperty("roughness",l),n.setProperty("metallic",h)),null!==this.lightmap&&(n.setProperty("lightMap",this.lightmap),n.setProperty("lightMapUVParam",this.lightmapUVParam))}},e._updateLevel=function(t){var e=new u,i=new u;u.add(e,this._bbMin,this._terrain.node.getWorldPosition()),u.add(i,this._bbMax,this._terrain.node.getWorldPosition());var r=u.distance(e,t),n=u.distance(i,t),s=Math.min(r,n);for(s-=this._terrain.LodBias,this._lodLevel=0;this._lodLevel<3&&!(s<=this._LevelDistances[this._lodLevel+1]);)++this._lodLevel},e.setBrushMaterial=function(t){this._renderable._brushMaterial!==t&&(this._renderable._invalidMaterial(),this._renderable._brushMaterial=t)},e._getBrushMaterial=function(){return this._renderable?this._renderable._brushMaterial:null},e._getBrushPass=function(){return this._renderable?this._renderable._brushPass:null},e.getTerrain=function(){return this._terrain},e.getIndex=function(){return this._index},e.getRect=function(){var t=new M;return t.x=this._index[0]*Y,t.y=this._index[1]*Y,t.width=Y,t.height=Y,t},e.setLayer=function(t,e){this.layers[t]!==e&&(this._terrain.setBlockLayer(this._index[0],this._index[1],t,e),this._renderable._invalidMaterial(),this._updateMaterial(!1))},e.getLayer=function(t){return this.layers[t]},e.getMaxLayer=function(){return this.layers[3]>=0?3:this.layers[2]>=0?2:this.layers[1]>=0?1:0},e._getMaterialDefines=function(t){return{LAYERS:t+1,USE_LIGHTMAP:null!==this.lightmap?1:0,USE_NORMALMAP:this._terrain.useNormalMap?1:0,USE_PBR:this._terrain.usePBR?1:0}},e._invalidMaterial=function(){this._renderable._invalidMaterial()},e._updateMaterial=function(t){this._renderable._updateMaterial(this,t)},e._updateHeight=function(){if(null!=this._renderable._meshData){var t=new Float32Array(q*K*K),e=0;this._bbMin.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._bbMax.set(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);for(var i=0;i<K;++i)for(var r=0;r<K;++r){var n=this._index[0]*Y+r,s=this._index[1]*Y+i,a=this._terrain.getPosition(n,s),o=this._terrain.getNormal(n,s),l=new h(r/K,i/K);t[e++]=a.x,t[e++]=a.y,t[e++]=a.z,t[e++]=o.x,t[e++]=o.y,t[e++]=o.z,t[e++]=l.x,t[e++]=l.y,u.min(this._bbMin,this._bbMin,a),u.max(this._bbMax,this._bbMax,a)}this._renderable._meshData.vertexBuffers[0].update(t),this._renderable._model.createBoundingShape(this._bbMin,this._bbMax),this._renderable._model.updateWorldBound(),this._updateLodBuffer(t),this._updateIndexBuffer()}},e._updateWeightMap=function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new w,this._weightMap.create(this._terrain.weightMapSize,this._terrain.weightMapSize,m.RGBA8888),this._weightMap.setFilters(x.LINEAR,x.LINEAR),this._weightMap.setWrapMode(z.CLAMP_TO_EDGE,z.CLAMP_TO_EDGE));for(var t=new Uint8Array(this._terrain.weightMapSize*this._terrain.weightMapSize*4),e=0,i=0;i<this._terrain.weightMapSize;++i)for(var r=0;r<this._terrain.weightMapSize;++r){var n=this._index[0]*this._terrain.weightMapSize+r,s=this._index[1]*this._terrain.weightMapSize+i,a=this._terrain.getWeight(n,s);t[4*e+0]=Math.floor(255*a.x),t[4*e+1]=Math.floor(255*a.y),t[4*e+2]=Math.floor(255*a.z),t[4*e+3]=Math.floor(255*a.w),e+=1}this._weightMap.uploadData(t)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)},e._updateLightmap=function(t){this._lightmapInfo=t,this._invalidMaterial()},e._updateLod=function(){var t=new ee;if(t.level=this._lodLevel,t.north=this._lodLevel,t.south=this._lodLevel,t.west=this._lodLevel,t.east=this._lodLevel,this._index[0]>0){var e=this.getTerrain().getBlock(this._index[0]-1,this._index[1]);t.west=e._lodLevel,t.west<this._lodLevel&&(t.west=this._lodLevel)}if(this._index[0]<this._terrain.info.blockCount[0]-1){var i=this.getTerrain().getBlock(this._index[0]+1,this._index[1]);t.east=i._lodLevel,t.east<this._lodLevel&&(t.east=this._lodLevel)}if(this._index[1]>0){var r=this.getTerrain().getBlock(this._index[0],this._index[1]-1);t.north=r._lodLevel,t.north<this._lodLevel&&(t.north=this._lodLevel)}if(this._index[1]<this._terrain.info.blockCount[1]-1){var n=this.getTerrain().getBlock(this._index[0],this._index[1]+1);t.south=n._lodLevel,t.south<this._lodLevel&&(t.south=this._lodLevel)}this._lodKey.equals(t)||(this._lodKey=t,this._updateIndexBuffer())},e._resetLod=function(){var t=new ee;t.level=0,t.north=0,t.south=0,t.west=0,t.east=0,this._lodKey.equals(t)||(this._lodKey=t,this._updateIndexBuffer())},e._updateIndexBuffer=function(){if(null!==this._renderable._meshData&&null!==this._renderable._model&&0!==this._renderable._model.subModels.length){var t=this._terrain._getIndexData(this._lodKey);if(null!==t){var e=this._renderable._model.subModels[0];e.inputAssembler.firstIndex=t.start,e.inputAssembler.indexCount=t.size}}},e._getHeight=function(t,e,i){return i[(K*e+t)*q+1]},e._updateLodBuffer=function(t){this._lodLevel=0,this._lodKey=new ee,this._calcErrorMetrics(t),this._calcLevelDistances(t)},e._calcErrorMetrics=function(t){this._errorMetrics[0]=0;for(var e=1;e<4;++e)this._errorMetrics[e]=this._calcErrorMetric(e,t);for(var i=2;i<4;++i)this._errorMetrics[i]=Math.max(this._errorMetrics[i],this._errorMetrics[i-1])},e._calcErrorMetric=function(t,e){for(var i=0,r=1<<t,n=K,s=K,a=n-1>>t,o=s-1>>t,l=0;l<s;l+=r)for(var h=0;h<a;++h){var u=h*r,_=u+r,f=(_+u)/2,c=this._getHeight(u,l,e),d=this._getHeight(_,l,e),g=this._getHeight(f,l,e),p=(c+d)/2,b=Math.abs(g-p);i=Math.max(i,b)}for(var v=0;v<n;v+=r)for(var y=0;y<o;++y){var M=y*r,w=M+r,m=(M+w)/2,x=this._getHeight(v,M,e),z=this._getHeight(v,w,e),k=this._getHeight(v,m,e),I=(x+z)/2,S=Math.abs(k-I);i=Math.max(i,S)}for(var C=0;C<o;++C)for(var A=C*r,L=A+r,E=(A+L)/2,B=0;B<a;++B){var P=B*r,R=P+r,N=(P+R)/2,T=this._getHeight(P,A,e),D=this._getHeight(R,L,e),U=this._getHeight(N,E,e),O=(T+D)/2,H=Math.abs(U-O);i=Math.max(i,H)}return i},e._calcLevelDistances=function(){for(var t=1;t<4;++t){var e=96*this._errorMetrics[t];this._LevelDistances[t]=e}},r(t,[{key:"valid",get:function(){if(null===this._terrain)return!1;for(var t=this._terrain.getBlocks(),e=0;e<t.length;++e)if(t[e]===this)return!0;return!1}},{key:"material",get:function(){return this._renderable?this._renderable._currentMaterial:null}},{key:"layers",get:function(){return this._terrain.getBlockLayers(this._index[0],this._index[1])}},{key:"weightmap",get:function(){return this._weightMap}},{key:"lightmap",get:function(){return this._lightmapInfo?this._lightmapInfo.texture:null}},{key:"lightmapUVParam",get:function(){return null!=this._lightmapInfo?new y(this._lightmapInfo.UOff,this._lightmapInfo.VOff,this._lightmapInfo.UScale,this._lightmapInfo.VScale):new y(0,0,0,0)}},{key:"visible",get:function(){return null!==this._renderable._model&&null!==this._renderable._model.scene},set:function(t){null!==this._renderable._model&&(t?null!=this._terrain.node&&null!=this._terrain.node.scene&&null!=this._terrain.node.scene.renderScene&&null==this._renderable._model.scene&&this._terrain.node.scene.renderScene.addModel(this._renderable._model):null!==this._renderable._model.scene&&this._renderable._model.scene.removeModel(this._renderable._model))}}]),t}());t("Terrain",(It=i("cc.Terrain"),St=U(),Ct=k(Q),At=k(I),Lt=O(),Et=k(le),Bt=k(S),Pt=k(S),Rt=k(S),Nt=k(S),Tt=k(C),Dt=k(Q),Ut=O(),Ot=k(I),Ht=O(),Vt=k(se),It(Ft=St(Ft=A(Ft=L((Jt=function(t){function i(){var e;e=t.call(this)||this,P(e,"__asset",jt,H(e)),P(e,"_effectAsset",Xt,H(e)),P(e,"_lightmapInfos",Gt,H(e)),P(e,"_receiveShadow",Kt,H(e)),P(e,"_useNormalmap",Yt,H(e)),P(e,"_usePBR",qt,H(e)),P(e,"_lodEnable",Qt,H(e)),P(e,"_lodBias",Zt,H(e)),e._buitinAsset=null,e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._normals=[],e._layerList=[],e._layerBuffer=[],e._blocks=[],e._lod=new ne,e._sharedIndexBuffer=null;for(var i=0;i<nt;++i)e._layerList.push(null);return e}s(i,t);var n=i.prototype;return n.build=function(t){return this._tileSize=t.tileSize,this._blockCount[0]=t.blockCount[0],this._blockCount[1]=t.blockCount[1],this._weightMapSize=t.weightMapSize,this._lightMapSize=t.lightMapSize,this._buildImp()},n.rebuild=function(t){for(var e=0;e<this._blocks.length;++e)this._blocks[e].destroy();this._blocks=[],this._rebuildLayerBuffer(t),this._rebuildHeights(t),this._rebuildWeights(t),this._tileSize=t.tileSize,this._blockCount[0]=t.blockCount[0],this._blockCount[1]=t.blockCount[1],this._weightMapSize=t.weightMapSize,this._lightMapSize=t.lightMapSize,this._buildNormals();for(var i=0;i<this._blockCount[1];++i)for(var r=0;r<this._blockCount[0];++r)this._blocks.push(new he(this,r,i));for(var n=0;n<this._blocks.length;++n)this._blocks[n].build()},n.importHeightField=function(t,e){for(var i=0,r=0;r<this.vertexCount[1];++r)for(var n=0;n<this.vertexCount[0];++n){var s=n/this.tileCount[0],a=r/this.tileCount[1],o=t.getAt(s*t.w,a*t.h)*e;this._heights[i++]=o}this._buildNormals();for(var l=0;l<this._blocks.length;++l)this._blocks[l]._updateHeight()},n.exportHeightField=function(t,e){for(var i=0,r=0;r<t.h;++r)for(var n=0;n<t.w;++n){var s=n/(t.w-1),a=r/(t.h-1),o=s*this.size.width,l=a*this.size.height,h=this.getHeightAt(o,l);null!=h&&(t.data[i++]=h*e)}},n.exportAsset=function(){var t=new Q;t.tileSize=this.tileSize,t.blockCount=this.blockCount,t.lightMapSize=this.lightMapSize,t.weightMapSize=this.weightMapSize,t.heights=this.heights,t.weights=this.weights,t.layerBuffer=new Array(4*this._blocks.length);for(var e=0;e<this._blocks.length;++e)t.layerBuffer[4*e+0]=this._blocks[e].layers[0],t.layerBuffer[4*e+1]=this._blocks[e].layers[1],t.layerBuffer[4*e+2]=this._blocks[e].layers[2],t.layerBuffer[4*e+3]=this._blocks[e].layers[3];for(var i=0;i<this._layerList.length;++i){var r=this._layerList[i];if(r&&r.detailMap&&E(r.detailMap)){var n=new Z;n.slot=i,n.tileSize=r.tileSize,n.detailMap=r.detailMap,n.normalMap=r.normalMap,n.metallic=r.metallic,n.roughness=r.roughness,t.layerInfos.push(n)}}return t},n.getEffectAsset=function(){return null===this._effectAsset?a.EffectAsset.get("terrain"):this._effectAsset},n.onEnable=function(){0===this._blocks.length&&this._buildImp();for(var t=0;t<this._blocks.length;++t)this._blocks[t].visible=!0;a.director.root.pipeline.on(X.RENDER_CAMERA_BEGIN,this.onUpdateFromCamera,this)},n.onDisable=function(){a.director.root.pipeline.off(X.RENDER_CAMERA_BEGIN,this.onUpdateFromCamera,this);for(var t=0;t<this._blocks.length;++t)this._blocks[t].visible=!1},n.onDestroy=function(){for(var t=0;t<this._blocks.length;++t)this._blocks[t].destroy();this._blocks=[];for(var e=0;e<this._layerList.length;++e)this._layerList[e]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()},n.onRestore=function(){this.onEnable(),this._buildImp(!0)},n.update=function(){for(var t=0;t<this._blocks.length;++t)this._blocks[t].update()},n.onUpdateFromCamera=function(t){if(this.lodEnable&&t.scene===this._getRenderScene()){for(var e=0;e<this._blocks.length;++e)this._blocks[e]._updateLevel(t.position);for(var i=0;i<this._blocks.length;++i)this._blocks[i]._updateLod()}},n.addLayer=function(t){for(var e=0;e<this._layerList.length;++e){var i;if(null===this._layerList[e]||this._layerList[e]&&null===(null===(i=this._layerList[e])||void 0===i?void 0:i.detailMap))return this._layerList[e]=t,e}return-1},n.setLayer=function(t,e){this._layerList[t]=e},n.removeLayer=function(t){this._layerList[t]=null},n.getLayer=function(t){return-1===t?null:this._layerList[t]},n.getPosition=function(t,e){var i=t*this._tileSize,r=e*this._tileSize,n=this.getHeight(t,e);return new u(i,n,r)},n.getHeightField=function(){return this._heights},n.setHeight=function(t,i,r){r=e(r,$,J),this._heights[i*this.vertexCount[0]+t]=tt+r/et},n.getHeight=function(t,e){return(this._heights[e*this.vertexCount[0]+t]-tt)*et},n.getHeightClamp=function(t,i){return t=e(t,0,this.vertexCount[0]-1),i=e(i,0,this.vertexCount[1]-1),this.getHeight(t,i)},n.getHeightAt=function(t,i){var r=t/this.tileSize,n=i/this.tileSize,s=Math.floor(r),a=Math.floor(n),o=s+1,l=a+1,h=r-s,u=n-a;if(s<0||s>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;s=e(s,0,this.vertexCount[0]-1),a=e(a,0,this.vertexCount[1]-1),o=e(o,0,this.vertexCount[0]-1),l=e(l,0,this.vertexCount[1]-1);var _=this.getHeight(s,a),f=this.getHeight(o,a),c=this.getHeight(s,l),d=this.getHeight(o,l),g=.5*(f+c);return h+u<=1?d=g+(g-_):_=g+(g-d),(_*(1-h)+f*h)*(1-u)+(c*(1-h)+d*h)*u},n._setNormal=function(t,e,i){var r=e*this.vertexCount[0]+t;this._normals[3*r+0]=i.x,this._normals[3*r+1]=i.y,this._normals[3*r+2]=i.z},n.getNormal=function(t,e){var i=e*this.vertexCount[0]+t,r=new u;return r.x=this._normals[3*i+0],r.y=this._normals[3*i+1],r.z=this._normals[3*i+2],r},n.getNormalAt=function(t,i){var r=t/this.tileSize,n=i/this.tileSize,s=Math.floor(r),a=Math.floor(n),o=s+1,l=a+1,h=r-s,_=n-a;if(s<0||s>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;s=e(s,0,this.vertexCount[0]-1),a=e(a,0,this.vertexCount[1]-1),o=e(o,0,this.vertexCount[0]-1),l=e(l,0,this.vertexCount[1]-1);var f=this.getNormal(s,a),c=this.getNormal(o,a),d=this.getNormal(s,l),g=this.getNormal(o,l),p=new u;u.add(p,c,d).multiplyScalar(.5),h+_<=1?(g.set(p),g.subtract(f),g.add(p)):(f.set(p),f.subtract(g),f.add(p));var b=new u,v=new u,y=new u;return u.lerp(b,f,c,h),u.lerp(v,d,g,h),u.lerp(y,b,v,_),y},n.setWeight=function(t,e,i){var r=e*this._weightMapSize*this._blockCount[0]+t;this._weights[4*r+0]=255*i.x,this._weights[4*r+1]=255*i.y,this._weights[4*r+2]=255*i.z,this._weights[4*r+3]=255*i.w},n.getWeight=function(t,e){var i=e*this._weightMapSize*this._blockCount[0]+t,r=new y;return r.x=this._weights[4*i+0]/255,r.y=this._weights[4*i+1]/255,r.z=this._weights[4*i+2]/255,r.w=this._weights[4*i+3]/255,r},n.getWeightAt=function(t,i){var r=this.weightMapSize*this.blockCount[0],n=this.weightMapSize*this.blockCount[1];if(0===r||0===n)return null;var s=t/r,a=i/n,o=Math.floor(s),l=Math.floor(a),h=o+1,u=l+1,_=s-o,f=a-l;if(o<0||o>r-1||l<0||l>n-1)return null;o=e(o,0,r-1),l=e(l,0,n-1),h=e(h,0,r-1),u=e(u,0,n-1);var c=this.getWeight(o,l),d=this.getWeight(h,l),g=this.getWeight(o,u),p=this.getWeight(h,u),b=new y;y.add(b,d,g).multiplyScalar(.5),_+f<=1?(p=new y,y.subtract(p,b,c).add(b)):(c=new y,y.subtract(c,b,p).add(b));var v=new y,M=new y,w=new y;return y.lerp(v,c,d,_),y.lerp(M,g,p,_),y.lerp(w,v,M,f),w},n.getMaxWeightLayerAt=function(t,e){var i=this.weightMapSize*this.blockCount[0],r=this.weightMapSize*this.blockCount[1];if(0===i||0===r)return null;var n=t/i,s=e/r,a=Math.floor(n),o=Math.floor(s);if(a<0||a>i-1||o<0||o>r-1)return null;var l=this.getWeight(a,o),h=Math.floor(t/this.weightMapSize),u=Math.floor(e/this.weightMapSize),_=this.getBlock(h,u),f=0;return l.y>l[f]&&-1!==_.getLayer(1)&&(f=1),l.y>l[f]&&-1!==_.getLayer(2)&&(f=2),l.z>l[f]&&-1!==_.getLayer(3)&&(f=3),f=_.getLayer(f),this.getLayer(f)},n.getBlockLayers=function(t,e){var i=(e*this._blockCount[0]+t)*it;return[this._layerBuffer[i],this._layerBuffer[i+1],this._layerBuffer[i+2],this._layerBuffer[i+3]]},n.getBlockLayer=function(t,e,i){var r=(e*this._blockCount[0]+t)*it;return this._layerBuffer[r+i]},n.setBlockLayer=function(t,e,i,r){var n=(e*this._blockCount[0]+t)*it;this._layerBuffer[n+i]=r},n.getBlock=function(t,e){return this._blocks[e*this._blockCount[0]+t]},n.getBlocks=function(){return this._blocks},n.rayCheck=function(t,e,i,r){void 0===r&&(r=!0);var n=t;r&&u.subtract(n,t,this.node.getWorldPosition());var s=new u;s.set(e),s.multiplyScalar(i);var a=null;if(e.equals(new u(0,1,0))){var o=this.getHeightAt(n.x,n.z);null!=o&&n.y<=o&&(a=new u(n.x,o,n.z))}else if(e.equals(new u(0,-1,0))){var l=this.getHeightAt(n.x,n.z);null!=l&&n.y>=l&&(a=new u(n.x,l,n.z))}else{for(var h=0;h++<2e3;){var _=this.getHeightAt(n.x,n.z);if(null!=_&&n.y<=_)break;n.add(e)}for(;h++<2e3;){var f=this.getHeightAt(n.x,n.z);if(null!=f&&n.y<=f){a=new u(n.x,f,n.z);break}n.add(s)}}return a},n._getSharedIndexBuffer=function(){if(null==this._sharedIndexBuffer){var t=a.director.root.device;this._sharedIndexBuffer=t.createBuffer(new _(f.INDEX|f.TRANSFER_DST,c.DEVICE,Uint16Array.BYTES_PER_ELEMENT*this._lod._indexBuffer.length,Uint16Array.BYTES_PER_ELEMENT)),this._sharedIndexBuffer.update(this._lod._indexBuffer)}return this._sharedIndexBuffer},n._getIndexData=function(t){return this._lod.getIndexData(t)},n._resetLightmap=function(t){if(this._lightmapInfos.length=0,t)for(var e=0;e<this._blockCount[0]*this._blockCount[1];++e)this._lightmapInfos.push(new le)},n._updateLightmap=function(t,e,i,r,n,s){this._lightmapInfos[t].texture=e,this._lightmapInfos[t].UOff=i,this._lightmapInfos[t].VOff=r,this._lightmapInfos[t].UScale=n,this._lightmapInfos[t].VScale=s,this._blocks[t]._updateLightmap(this._lightmapInfos[t])},n._getLightmapInfo=function(t,e){var i=e*this._blockCount[0]+t;return i<this._lightmapInfos.length?this._lightmapInfos[i]:null},n._calcNormal=function(t,e){var i,r,n=1,s=this.getPosition(t,e);t<this.vertexCount[0]-1?i=this.getPosition(t+1,e):(n*=-1,i=this.getPosition(t-1,e)),e<this.vertexCount[1]-1?r=this.getPosition(t,e+1):(n*=-1,r=this.getPosition(t,e-1)),i.subtract(s),r.subtract(s);var a=new u;return a.set(r),a.cross(i),a.multiplyScalar(n),a.normalize(),a},n._buildNormals=function(){for(var t=0,e=0;e<this.vertexCount[1];++e)for(var i=0;i<this.vertexCount[0];++i){var r=this._calcNormal(i,e);this._normals[3*t+0]=r.x,this._normals[3*t+1]=r.y,this._normals[3*t+2]=r.z,t+=1}},n._buildImp=function(t){var e=this;if(void 0===t&&(t=!1),!this.valid){var i=this.__asset;if(this._buitinAsset!=i&&(this._buitinAsset=i),!t&&null!==i){this._tileSize=i.tileSize,this._blockCount=i.blockCount,this._weightMapSize=i.weightMapSize,this._lightMapSize=i.lightMapSize,this._heights=i.heights,this._weights=i.weights,this._layerBuffer=i.layerBuffer;for(var r=0;r<this._layerList.length;++r)this._layerList[r]=null;if(i.version<rt)for(var n=function(t){var r=new ae,n=i.layerBinaryInfos[t];r.tileSize=n.tileSize,a.assetManager.loadAny(n.detailMapId,(function(t,e){r.detailMap=e})),""!==n.normalMapId&&a.assetManager.loadAny(n.normalMapId,(function(t,e){r.normalMap=e})),r.roughness=n.roughness,r.metallic=n.metallic,e._layerList[n.slot]=r},s=0;s<i.layerBinaryInfos.length;++s)n(s);else for(var o=0;o<i.layerInfos.length;++o){var l=new ae,h=i.layerInfos[o];l.tileSize=h.tileSize,l.detailMap=h.detailMap,l.normalMap=h.normalMap,l.roughness=h.roughness,l.metallic=h.metallic,this._layerList[h.slot]=l}}if(0!==this._blockCount[0]&&0!==this._blockCount[1]){var u=this.vertexCount[0]*this.vertexCount[1];if(null===this._heights||this._heights.length!==u){this._heights=new Uint16Array(u),this._normals=new Array(3*u);for(var _=0;_<u;++_)this._heights[_]=tt,this._normals[3*_+0]=0,this._normals[3*_+1]=1,this._normals[3*_+2]=0}else this._normals=new Array(3*u),this._buildNormals();var f=this.blockCount[0]*this.blockCount[1]*it;if(null===this._layerBuffer||this._layerBuffer.length!==f){this._layerBuffer=new Array(f);for(var c=0;c<f;++c)this._layerBuffer[c]=-1}var d=this._weightMapSize*this._blockCount[0],g=this._weightMapSize*this._blockCount[1];if(this._weights.length!==d*g*4){this._weights=new Uint8Array(d*g*4);for(var p=0;p<d*g;++p)this._weights[4*p+0]=255,this._weights[4*p+1]=0,this._weights[4*p+2]=0,this._weights[4*p+3]=0}for(var b=0;b<this._blockCount[1];++b)for(var v=0;v<this._blockCount[0];++v)this._blocks.push(new he(this,v,b));for(var y=0;y<this._blocks.length;++y)this._blocks[y].build()}}},n._rebuildHeights=function(t){if(this.vertexCount[0]===t.vertexCount[0]&&this.vertexCount[1]===t.vertexCount[1])return!1;for(var e=new Uint16Array(t.vertexCount[0]*t.vertexCount[1]),i=0;i<e.length;++i)e[i]=tt;for(var r=Math.min(this.vertexCount[0],t.vertexCount[0]),n=Math.min(this.vertexCount[1],t.vertexCount[1]),s=0;s<n;++s)for(var a=0;a<r;++a){var o=s*t.vertexCount[0]+a,l=s*this.vertexCount[0]+a;e[o]=this._heights[l]}return this._heights=e,!0},n._rebuildLayerBuffer=function(t){if(this.blockCount[0]===t.blockCount[0]&&this.blockCount[1]===t.blockCount[1])return!1;var e=[];e.length=t.blockCount[0]*t.blockCount[1]*it;for(var i=0;i<e.length;++i)e[i]=-1;for(var r=Math.min(this.blockCount[0],t.blockCount[0]),n=Math.min(this.blockCount[1],t.blockCount[1]),s=0;s<n;++s)for(var a=0;a<r;++a)for(var o=s*t.blockCount[0]+a,l=s*this.blockCount[0]+a,h=0;h<it;++h)e[o*it+h]=this._layerBuffer[l*it+h];return this._layerBuffer=e,!0},n._rebuildWeights=function(t){var e=this,i=this._weightMapSize,r=this._weightMapSize*this._blockCount[0],n=this._weightMapSize*this._blockCount[1],s=t.weightMapSize*t.blockCount[0],a=t.weightMapSize*t.blockCount[1];if(s===r&&a===n)return!1;for(var o=new Uint8Array(s*a*4),l=0;l<s*a;++l)o[4*l+0]=255,o[4*l+1]=0,o[4*l+2]=0,o[4*l+3]=0;for(var h=Math.min(t.blockCount[0],this._blockCount[0]),u=Math.min(t.blockCount[1],this._blockCount[1]),_=function(t,e,i){var n=e*r+t,s=new y;return s.x=i[4*n+0]/255,s.y=i[4*n+1]/255,s.z=i[4*n+2]/255,s.w=i[4*n+3]/255,s},f=function(t,i,r,n){var s=Math.floor(t),a=Math.floor(i),o=s+1,l=a+1,h=t-s,u=i-a,f=_(s+r,a+n,e._weights),c=_(o+r,a+n,e._weights),d=_(s+r,l+n,e._weights),g=_(o+r,l+n,e._weights),p=new y;y.add(p,c,d).multiplyScalar(.5),h+u<=1?(g.set(p),g.subtract(f),g.add(p)):(f.set(p),f.subtract(g),f.add(p));var b=new y,v=new y,M=new y;return y.lerp(b,f,c,h),y.lerp(v,d,g,h),y.lerp(M,b,v,u),M},c=0;c<u;++c)for(var d=0;d<h;++d)for(var g=d*i,p=c*i,b=0;b<t.weightMapSize;++b)for(var v=0;v<t.weightMapSize;++v){var M=void 0;M=t.weightMapSize===i?_(v+g,b+p,this._weights):f(v/(t.weightMapSize-1)*(i-1),b/(t.weightMapSize-1)*(i-1),g,p,this._weights);var w=d*t.weightMapSize+v,m=(c*t.weightMapSize+b)*s+w;o[4*m+0]=255*M.x,o[4*m+1]=255*M.y,o[4*m+2]=255*M.z,o[4*m+3]=255*M.w}return this._weights=o,!0},r(i,[{key:"_asset",get:function(){return this.__asset},set:function(t){if(this.__asset=t,this._buitinAsset!==this.__asset){this._buitinAsset=this.__asset;for(var e=0;e<this._blocks.length;++e)this._blocks[e].destroy();if(this._blocks=[],null===this.__asset){this._effectAsset=null,this._lightmapInfos=[],this._receiveShadow=!1,this._useNormalmap=!1,this._usePBR=!1,this._tileSize=1,this._blockCount=[1,1],this._weightMapSize=128,this._lightMapSize=128,this._heights=new Uint16Array,this._weights=new Uint8Array,this._normals=[],this._layerBuffer=[],this._blocks=[],this._layerList=[];for(var i=0;i<nt;++i)this._layerList.push(null)}a.director.root.device&&this._buildImp()}}},{key:"effectAsset",get:function(){return this._effectAsset},set:function(t){if(this._effectAsset!==t){this._effectAsset=t;for(var e=0;e<this._blocks.length;++e)this._blocks[e]._invalidMaterial()}}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t;for(var e=0;e<this._blocks.length;e++)this._blocks[e]._invalidMaterial()}},{key:"useNormalMap",get:function(){return this._useNormalmap},set:function(t){this._useNormalmap=t;for(var e=0;e<this._blocks.length;e++)this._blocks[e]._invalidMaterial()}},{key:"usePBR",get:function(){return this._usePBR},set:function(t){this._usePBR=t;for(var e=0;e<this._blocks.length;e++)this._blocks[e]._invalidMaterial()}},{key:"lodEnable",get:function(){return this._lodEnable},set:function(t){if(this._lodEnable=t,!this._lodEnable)for(var e=0;e<this._blocks.length;e++)this._blocks[e]._resetLod()}},{key:"LodBias",get:function(){return this._lodBias},set:function(t){this._lodBias=t}},{key:"size",get:function(){var t=new R(0,0);return t.width=this.blockCount[0]*Y*this.tileSize,t.height=this.blockCount[1]*Y*this.tileSize,t}},{key:"tileSize",get:function(){return this._tileSize}},{key:"tileCount",get:function(){return[this.blockCount[0]*Y,this.blockCount[1]*Y]}},{key:"vertexCount",get:function(){var t=this.tileCount;return t[0]+=1,t[1]+=1,t}},{key:"blockCount",get:function(){return this._blockCount}},{key:"lightMapSize",get:function(){return this._lightMapSize}},{key:"weightMapSize",get:function(){return this._weightMapSize}},{key:"heights",get:function(){return this._heights}},{key:"weights",get:function(){return this._weights}},{key:"valid",get:function(){return this._blocks.length>0}},{key:"info",get:function(){var t=new se;return t.tileSize=this.tileSize,t.blockCount[0]=this.blockCount[0],t.blockCount[1]=this.blockCount[1],t.weightMapSize=this.weightMapSize,t.lightMapSize=this.lightMapSize,t}}]),i}(V),jt=n((Wt=Jt).prototype,"__asset",[Ct,N,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xt=n(Wt.prototype,"_effectAsset",[At,N,F,Lt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gt=n(Wt.prototype,"_lightmapInfos",[Et,N,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kt=n(Wt.prototype,"_receiveShadow",[Bt,N,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yt=n(Wt.prototype,"_useNormalmap",[Pt,N,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qt=n(Wt.prototype,"_usePBR",[Rt,N,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qt=n(Wt.prototype,"_lodEnable",[Nt,N,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zt=n(Wt.prototype,"_lodBias",[Tt,N,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n(Wt.prototype,"_asset",[Dt,Ut],Object.getOwnPropertyDescriptor(Wt.prototype,"_asset"),Wt.prototype),n(Wt.prototype,"effectAsset",[Ot,Ht],Object.getOwnPropertyDescriptor(Wt.prototype,"effectAsset"),Wt.prototype),n(Wt.prototype,"receiveShadow",[B],Object.getOwnPropertyDescriptor(Wt.prototype,"receiveShadow"),Wt.prototype),n(Wt.prototype,"useNormalMap",[B],Object.getOwnPropertyDescriptor(Wt.prototype,"useNormalMap"),Wt.prototype),n(Wt.prototype,"usePBR",[B],Object.getOwnPropertyDescriptor(Wt.prototype,"usePBR"),Wt.prototype),n(Wt.prototype,"lodEnable",[B],Object.getOwnPropertyDescriptor(Wt.prototype,"lodEnable"),Wt.prototype),n(Wt.prototype,"LodBias",[B],Object.getOwnPropertyDescriptor(Wt.prototype,"LodBias"),Wt.prototype),n(Wt.prototype,"info",[Vt],Object.getOwnPropertyDescriptor(Wt.prototype,"info"),Wt.prototype),Ft=Wt))||Ft)||Ft)||Ft)||Ft))}}}));
