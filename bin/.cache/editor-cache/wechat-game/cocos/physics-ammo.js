System.register(["./json-asset-7bb011fd.js","./base.js","./index-07e0e256.js","./spot-light-44c8b89f.js","./texture-buffer-pool-2b0fe4d4.js","./deprecated-229f0693.js","./renderable-component-0ffd84e0.js","./transform-utils-ec8404a7.js","./mesh-12590811.js","./skeleton-5498f045.js","./index-809e7472.js","./collision-matrix-c53e6e00.js","./capsule-c827c0f3.js","./terrain-asset-0aafabc0.js","./physics-framework.js","./_commonjsHelpers-19d0a8b5.js","./tuple-dictionary-5e20c301.js","./instantiated-464fe45d.js","./array-collision-matrix-ec6af177.js"],(function(){"use strict";var t,i,e,s,o,n,r,a,l,d,h,c,p,_,u,y,f,g,S,m,C,B,T,v;return{setters:[function(p){t=p.ej,i=p.c4,e=p.c8,s=p.a4,o=p.hf,n=p.fU,r=p.e,a=p.ew,l=p.cC,d=p.cD,h=p.d,c=p.w},function(){},function(){},function(){},function(){},function(t){p=t.g,_=t.G},function(){},function(){},function(){},function(){},function(t){u=t.P,y=t.V,f=t.l,g=t.m},function(t){S=t.a,m=t.P,C=t.b},function(){},function(){},function(){},function(){},function(t){B=t.T},function(t){T=t.b},function(t){v=t.A}],execute:function(){var b={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},A={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},E=function(){function i(){this.BT_TRANSFORM_0=T.Transform_new(),this.BT_TRANSFORM_1=T.Transform_new(),this.BT_V3_0=T.Vec3_new(0,0,0),this.BT_V3_1=T.Vec3_new(0,0,0),this.BT_V3_2=T.Vec3_new(0,0,0),this.BT_QUAT_0=T.Quat_new(0,0,0,1)}return i.setWrapper=function(t,i,e){this.ROOT[i]||(this.ROOT[i]={}),this.ROOT[i][t]=e},i.delWrapper=function(t,i){delete this.ROOT[i][t]},i.getWrapper=function(t,i){return this.ROOT[i][t]},i.isNotEmptyShape=function(t){return t!==T.EmptyShape_static()},t(i,null,[{key:"instance",get:function(){return null==i._instance&&(i._instance=new i),i._instance}}]),i}();E._instance=void 0,E.ROOT={};var O,w,I,R,D,M=new i,P=new i,F=new e;function V(t,i){return T.Vec3_set(t,i.x,i.y,i.z),t}function k(t,i){return t.x=T.Vec3_x(i),t.y=T.Vec3_y(i),t.z=T.Vec3_z(i),t}function N(t,i){return T.Quat_set(t,i.x,i.y,i.z,i.w),t}function L(t,i){return t.x=T.Quat_x(i),t.y=T.Quat_y(i),t.z=T.Quat_z(i),t.w=T.Quat_w(i),t}T.CACHE=E,function(t){t[t.BODY_RE_ADD=1]="BODY_RE_ADD",t[t.GHOST_RE_ADD=2]="GHOST_RE_ADD"}(O||(O={})),function(t){t[t.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",t[t.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",t[t.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",t[t.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",t[t.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",t[t.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",t[t.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING"}(w||(w={})),function(t){t[t.CO_COLLISION_OBJECT=1]="CO_COLLISION_OBJECT",t[t.CO_RIGID_BODY=2]="CO_RIGID_BODY",t[t.CO_GHOST_OBJECT=4]="CO_GHOST_OBJECT",t[t.CO_SOFT_BODY=8]="CO_SOFT_BODY",t[t.CO_HF_FLUID=16]="CO_HF_FLUID",t[t.CO_USER_TYPE=32]="CO_USER_TYPE",t[t.CO_FEATHERSTONE_LINK=64]="CO_FEATHERSTONE_LINK"}(I||(I={})),function(t){t[t.ACTIVE_TAG=1]="ACTIVE_TAG",t[t.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",t[t.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",t[t.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",t[t.DISABLE_SIMULATION=5]="DISABLE_SIMULATION"}(R||(R={})),function(t){t[t.BT_DISABLE_WORLD_GRAVITY=1]="BT_DISABLE_WORLD_GRAVITY",t[t.BT_ENABLE_GYROPSCOPIC_FORCE=2]="BT_ENABLE_GYROPSCOPIC_FORCE"}(D||(D={}));var x=M,G=P,W=function(){var e=s.prototype;function s(){this.id=void 0,this._isEnabled=!1,this._isUsingCCD=!1,this.id=s.idCounter++}return e.setMass=function(t){this._rigidBody.isDynamic&&(T.RigidBody_setMass(this.impl,t),this._wakeUpIfSleep(),this._sharedBody.dirty|=O.BODY_RE_ADD)},e.setType=function(t){this._sharedBody.setType(t)},e.setLinearDamping=function(){T.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)},e.setAngularDamping=function(){T.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)},e.useGravity=function(t){if(this._rigidBody.isDynamic){var e=T.RigidBody_getFlags(this.impl);t?e&=~D.BT_DISABLE_WORLD_GRAVITY:(T.RigidBody_setGravity(this.impl,V(E.instance.BT_V3_0,i.ZERO)),e|=D.BT_DISABLE_WORLD_GRAVITY),T.RigidBody_setFlags(this.impl,e),this._wakeUpIfSleep(),this._sharedBody.dirty|=O.BODY_RE_ADD}},e.useCCD=function(t){T.CollisionObject_setCcdMotionThreshold(this.impl,t?.01:0),T.CollisionObject_setCcdSweptSphereRadius(this.impl,t?.1:0),this._isUsingCCD=t},e.isUsingCCD=function(){return this._isUsingCCD},e.setLinearFactor=function(t){T.RigidBody_setLinearFactor(this.impl,V(E.instance.BT_V3_0,t)),this._wakeUpIfSleep()},e.setAngularFactor=function(t){T.RigidBody_setAngularFactor(this.impl,V(E.instance.BT_V3_0,t)),this._wakeUpIfSleep()},e.setAllowSleep=function(t){this._rigidBody.isDynamic&&(t?T.CollisionObject_forceActivationState(this.impl,R.ACTIVE_TAG):T.CollisionObject_forceActivationState(this.impl,R.DISABLE_DEACTIVATION),this._wakeUpIfSleep())},e.clearState=function(){T.RigidBody_clearState(this.impl)},e.clearVelocity=function(){this.setLinearVelocity(i.ZERO),this.setAngularVelocity(i.ZERO)},e.clearForces=function(){T.RigidBody_clearForces(this.impl)},e.initialize=function(t){this._rigidBody=t,this._sharedBody=u.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0},e.onEnable=function(){this._isEnabled=!0,this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.bodyEnabled=!0},e.onDisable=function(){this._isEnabled=!1,this._sharedBody.bodyEnabled=!1},e.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},e.wakeUp=function(t){void 0===t&&(t=!0),T.CollisionObject_activate(this.impl,t)},e.sleep=function(){return T.RigidBody_wantsSleeping(this.impl)},e.setSleepThreshold=function(t){this._wakeUpIfSleep(),T.RigidBody_setSleepingThresholds(this.impl,t,t)},e.getSleepThreshold=function(){return T.RigidBody_getLinearSleepingThreshold(this.impl)},e.getLinearVelocity=function(t){return k(t,T.RigidBody_getLinearVelocity(this.impl))},e.setLinearVelocity=function(t){this._wakeUpIfSleep(),V(T.RigidBody_getLinearVelocity(this.impl),t)},e.getAngularVelocity=function(t){return k(t,T.RigidBody_getAngularVelocity(this.impl))},e.setAngularVelocity=function(t){this._wakeUpIfSleep(),V(T.RigidBody_getAngularVelocity(this.impl),t)},e.applyLocalForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=i.transformQuat(x,t,s),n=e?i.transformQuat(G,e,s):i.ZERO;T.RigidBody_applyForce(this.impl,V(E.instance.BT_V3_0,o),V(E.instance.BT_V3_1,n))},e.applyLocalTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),i.transformQuat(x,t,this._sharedBody.node.worldRotation),T.RigidBody_applyTorque(this.impl,V(E.instance.BT_V3_0,x))},e.applyLocalImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=i.transformQuat(x,t,s),n=e?i.transformQuat(G,e,s):i.ZERO;T.RigidBody_applyImpulse(this.impl,V(E.instance.BT_V3_0,o),V(E.instance.BT_V3_1,n))},e.applyForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=e||i.ZERO;T.RigidBody_applyForce(this.impl,V(E.instance.BT_V3_0,t),V(E.instance.BT_V3_1,s))},e.applyTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),T.RigidBody_applyTorque(this.impl,V(E.instance.BT_V3_0,t))},e.applyImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=e||i.ZERO;T.RigidBody_applyImpulse(this.impl,V(E.instance.BT_V3_0,t),V(E.instance.BT_V3_1,s))},e.getGroup=function(){return this._sharedBody.collisionFilterGroup},e.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},e.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},e.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},e.getMask=function(){return this._sharedBody.collisionFilterMask},e.setMask=function(t){this._sharedBody.collisionFilterMask=t},e.addMask=function(t){this._sharedBody.collisionFilterMask|=t},e.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},e._wakeUpIfSleep=function(){this.isAwake||T.CollisionObject_activate(this.impl,!0)},t(s,[{key:"isAwake",get:function(){var t=T.CollisionObject_getActivationState(this.impl);return t===R.ACTIVE_TAG||t===R.DISABLE_DEACTIVATION}},{key:"isSleepy",get:function(){return T.CollisionObject_getActivationState(this.impl)===R.WANTS_DEACTIVATION}},{key:"isSleeping",get:function(){return T.CollisionObject_getActivationState(this.impl)===R.ISLAND_SLEEPING}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),s}();W.idCounter=0;var j=M,U=F,z=0,J=function(){function i(t,e){this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.wrappedJoints0=[],this.wrappedJoints1=[],this.dirty=0,this._collisionFilterGroup=u.PhysicsGroup.DEFAULT,this._collisionFilterMask=-1,this.ref=0,this.bodyIndex=-1,this.ghostIndex=-1,this._wrappedBody=null,this.id=i.idCounter++,this.wrappedWorld=e,this.node=t}i.getSharedBody=function(t,e,s){var o,n=t.uuid;if(i.sharedBodesMap.has(n))o=i.sharedBodesMap.get(n);else{o=new i(t,e);var r=m.DEFAULT,a=u.instance.collisionMatrix[r];o._collisionFilterGroup=r,o._collisionFilterMask=a,i.sharedBodesMap.set(t.uuid,o)}if(s){o._wrappedBody=s;var l=s.rigidBody.group,d=u.instance.collisionMatrix[l];o._collisionFilterGroup=l,o._collisionFilterMask=d}return o};var e=i.prototype;return e._instantiateBodyStruct=function(){if(!this._bodyStruct){var t=0;this._wrappedBody&&this._wrappedBody.rigidBody.enabled&&this._wrappedBody.rigidBody.isDynamic&&(t=this._wrappedBody.rigidBody.mass);var i=E.instance.BT_TRANSFORM_0,e=E.instance.BT_QUAT_0;V(T.Transform_getOrigin(i),this.node.worldPosition),N(e,this.node.worldRotation),T.Transform_setRotation(i,e);var s=T.ccMotionState_new(this.id,i),o=T.RigidBody_new(t,s),n=u.instance.sleepThreshold;T.RigidBody_setSleepingThresholds(o,n,n),this._bodyStruct={id:z++,body:o,motionState:s,compound:T.ccCompoundShape_new(),wrappedShapes:[],useCompound:!1},E.setWrapper(this.id,T.BODY_CACHE_NAME,this),this._ghostStruct&&T.CollisionObject_setIgnoreCollisionCheck(this.ghost,this.body,!0),this._wrappedBody&&this.setBodyType(this._wrappedBody.rigidBody.type)}},e._instantiateGhostStruct=function(){if(!this._ghostStruct){var t=T.CollisionObject_new(),i=T.ccCompoundShape_new();T.CollisionObject_setCollisionShape(t,i),T.CollisionObject_setCollisionFlags(t,w.CF_STATIC_OBJECT|w.CF_NO_CONTACT_RESPONSE),this._ghostStruct={id:z++,ghost:t,compound:i,wrappedShapes:[]},this._bodyStruct&&T.CollisionObject_setIgnoreCollisionCheck(this.body,this.ghost,!0),this._wrappedBody&&this.setGhostType(this._wrappedBody.rigidBody.type)}},e.setType=function(t){this.setBodyType(t),this.setGhostType(t)},e.setBodyType=function(t){if(this._bodyStruct&&this._wrappedBody){var i=this._bodyStruct.body,e=this._wrappedBody,s=e.rigidBody,o=T.CollisionObject_getCollisionFlags(i),n=E.instance.BT_V3_0;switch(t){case S.DYNAMIC:o&=~w.CF_KINEMATIC_OBJECT,o&=~w.CF_STATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,o),e.setMass(s.mass),e.useGravity(s.useGravity),e.setAllowSleep(s.allowSleep);break;case S.KINEMATIC:T.Vec3_set(n,0,0,0),T.RigidBody_setMassProps(i,0,n),o|=w.CF_KINEMATIC_OBJECT,o&=~w.CF_STATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,o),T.CollisionObject_forceActivationState(i,R.DISABLE_DEACTIVATION);break;case S.STATIC:default:T.Vec3_set(n,0,0,0),T.RigidBody_setMassProps(i,0,n),o|=w.CF_STATIC_OBJECT,o&=~w.CF_KINEMATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,o),T.CollisionObject_forceActivationState(i,R.ISLAND_SLEEPING)}this.dirty|=O.BODY_RE_ADD}},e.setGhostType=function(t){if(this._ghostStruct){var i=this._ghostStruct.ghost,e=T.CollisionObject_getCollisionFlags(i);switch(t){case S.DYNAMIC:case S.KINEMATIC:e&=~w.CF_STATIC_OBJECT,e|=w.CF_KINEMATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,e),T.CollisionObject_forceActivationState(i,R.DISABLE_DEACTIVATION);break;case S.STATIC:default:e&=~w.CF_KINEMATIC_OBJECT,e|=w.CF_STATIC_OBJECT,T.CollisionObject_setCollisionFlags(i,e),T.CollisionObject_forceActivationState(i,R.ISLAND_SLEEPING)}this.dirty|=O.GHOST_RE_ADD}},e.addShape=function(t,i){function e(t,i){T.CollisionObject_setCollisionShape(t.body,i),t.dirty|=O.BODY_RE_ADD,t._wrappedBody&&t._wrappedBody.isEnabled&&t._wrappedBody.setMass(t._wrappedBody.rigidBody.mass)}if(i)this.ghostStruct.wrappedShapes.indexOf(t)<0&&(this.ghostStruct.wrappedShapes.push(t),t.setCompound(this.ghostCompoundShape),this.ghostEnabled=!0);else if(this.bodyStruct.wrappedShapes.indexOf(t)<0){if(this.bodyStruct.wrappedShapes.push(t),this.bodyStruct.useCompound)t.setCompound(this.bodyCompoundShape);else{var s=this.bodyStruct.wrappedShapes.length;if(1!==s||t.needCompound()){this.bodyStruct.useCompound=!0;for(var o=0;o<s;o++)this.bodyStruct.wrappedShapes[o].setCompound(this.bodyCompoundShape);e(this,this.bodyStruct.compound)}else e(this,t.impl)}this.bodyEnabled=!0}},e.removeShape=function(t,i){if(i){var e=this.ghostStruct.wrappedShapes.indexOf(t);e>=0&&(o(this.ghostStruct.wrappedShapes,e),t.setCompound(0),this.ghostEnabled=!1)}else{var s=this.bodyStruct.wrappedShapes.indexOf(t);s>=0&&(this.bodyStruct.useCompound?t.setCompound(0):T.CollisionObject_setCollisionShape(this.body,T.EmptyShape_static()),T.CollisionObject_activate(this.body,!0),this.dirty|=O.BODY_RE_ADD,o(this.bodyStruct.wrappedShapes,s),this.bodyEnabled=!1)}},e.addJoint=function(t,i){i?this.wrappedJoints1.indexOf(t)<0&&this.wrappedJoints1.push(t):this.wrappedJoints0.indexOf(t)<0&&this.wrappedJoints0.push(t)},e.removeJoint=function(t,i){if(i){var e=this.wrappedJoints1.indexOf(t);e>=0&&o(this.wrappedJoints1,e)}else{var s=this.wrappedJoints0.indexOf(t);s>=0&&o(this.wrappedJoints0,s)}},e.updateDirty=function(){this.dirty&&(this.bodyIndex>=0&&this.dirty&O.BODY_RE_ADD&&this.updateBodyByReAdd(),this.ghostIndex>=0&&this.dirty&O.GHOST_RE_ADD&&this.updateGhostByReAdd(),this.dirty=0)},e.syncSceneToPhysics=function(){if(this.node.hasChangedFlags){var t=E.instance.BT_QUAT_0,i=T.CollisionObject_getWorldTransform(this.body);if(N(t,this.node.worldRotation),V(T.Transform_getOrigin(i),this.node.worldPosition),T.Transform_setRotation(i,t),this.node.hasChangedFlags&n.SCALE&&this.syncBodyScale(),T.CollisionObject_isKinematicObject(this.body)){var e=T.RigidBody_getMotionState(this.body);e&&T.MotionState_setWorldTransform(e,i)}else this.isBodySleeping()&&T.CollisionObject_activate(this.body)}},e.syncPhysicsToScene=function(){T.CollisionObject_isStaticOrKinematicObject(this.body)||this.syncPhysicsToGraphics()},e.syncPhysicsToGraphics=function(){if(!this.isBodySleeping()){var t=E.instance.BT_QUAT_0,i=E.instance.BT_TRANSFORM_0;if(T.MotionState_getWorldTransform(T.RigidBody_getMotionState(this.body),i),T.Transform_getRotation(i,t),this.node.worldRotation=L(U,t),this.node.worldPosition=k(j,T.Transform_getOrigin(i)),this._ghostStruct){var e=T.CollisionObject_getWorldTransform(this.ghost);V(T.Transform_getOrigin(e),this.node.worldPosition),N(t,this.node.worldRotation),T.Transform_setRotation(e,t)}}},e.syncSceneToGhost=function(){if(this.node.hasChangedFlags){var t=E.instance.BT_QUAT_0,i=T.CollisionObject_getWorldTransform(this.ghost);V(T.Transform_getOrigin(i),this.node.worldPosition),N(t,this.node.worldRotation),T.Transform_setRotation(i,t),this.node.hasChangedFlags&n.SCALE&&this.syncGhostScale(),T.CollisionObject_activate(this.ghost)}},e.syncInitialBody=function(){var t=E.instance.BT_QUAT_0,i=T.CollisionObject_getWorldTransform(this.body);V(T.Transform_getOrigin(i),this.node.worldPosition),N(t,this.node.worldRotation),T.Transform_setRotation(i,t),this.syncBodyScale(),T.CollisionObject_activate(this.body)},e.syncInitialGhost=function(){var t=E.instance.BT_QUAT_0,i=T.CollisionObject_getWorldTransform(this.ghost);V(T.Transform_getOrigin(i),this.node.worldPosition),N(t,this.node.worldRotation),T.Transform_setRotation(i,t),this.syncGhostScale(),T.CollisionObject_activate(this.body)},e.syncBodyScale=function(){for(var t=0;t<this.bodyStruct.wrappedShapes.length;t++)this.bodyStruct.wrappedShapes[t].updateScale();for(var i=0;i<this.wrappedJoints0.length;i++)this.wrappedJoints0[i].updateScale0();for(var e=0;e<this.wrappedJoints1.length;e++)this.wrappedJoints1[e].updateScale1()},e.syncGhostScale=function(){for(var t=0;t<this.ghostStruct.wrappedShapes.length;t++)this.ghostStruct.wrappedShapes[t].updateScale()},e.updateBodyByReAdd=function(){this.bodyIndex>=0&&(this.wrappedWorld.removeSharedBody(this),this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this))},e.updateGhostByReAdd=function(){this.ghostIndex>=0&&(this.wrappedWorld.removeGhostObject(this),this.ghostIndex=this.wrappedWorld.ghosts.length,this.wrappedWorld.addGhostObject(this))},e.destroy=function(){if(i.sharedBodesMap.delete(this.node.uuid),this.node=null,this.wrappedWorld=null,this._bodyStruct){var t=this._bodyStruct;E.delWrapper(t.body,T.BODY_CACHE_NAME),T.MotionState_del(t.motionState),T.CollisionShape_del(t.compound),T.CollisionObject_del(t.body),this._bodyStruct=null}if(this._ghostStruct){var e=this._ghostStruct;T.CollisionShape_del(e.compound),T.CollisionObject_del(e.ghost),this._ghostStruct=null}},e.isBodySleeping=function(){return T.CollisionObject_getActivationState(this.body)===R.ISLAND_SLEEPING},t(i,[{key:"wrappedBody",get:function(){return this._wrappedBody}},{key:"bodyCompoundShape",get:function(){return this.bodyStruct.compound}},{key:"ghostCompoundShape",get:function(){return this.ghostStruct.compound}},{key:"body",get:function(){return this.bodyStruct.body}},{key:"ghost",get:function(){return this.ghostStruct.ghost}},{key:"collisionFilterGroup",get:function(){return this._collisionFilterGroup},set:function(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this.dirty|=O.BODY_RE_ADD,this.dirty|=O.GHOST_RE_ADD)}},{key:"collisionFilterMask",get:function(){return this._collisionFilterMask},set:function(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this.dirty|=O.BODY_RE_ADD,this.dirty|=O.GHOST_RE_ADD)}},{key:"bodyStruct",get:function(){return this._instantiateBodyStruct(),this._bodyStruct}},{key:"ghostStruct",get:function(){return this._instantiateGhostStruct(),this._ghostStruct}},{key:"bodyEnabled",set:function(t){if(t){if(this.bodyIndex<0){if(0===this.bodyStruct.wrappedShapes.length){if(!this.wrappedBody)return;if(!this.wrappedBody.rigidBody.isDynamic)return}this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitialBody()}}else this.bodyIndex>=0&&(0===this.bodyStruct.wrappedShapes.length&&null==this.wrappedBody||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.rigidBody.enabledInHierarchy)&&(T.RigidBody_clearState(this.body),this.bodyIndex=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"ghostEnabled",set:function(t){t?this.ghostIndex<0&&this.ghostStruct.wrappedShapes.length>0&&(this.ghostIndex=1,this.wrappedWorld.addGhostObject(this),this.syncInitialGhost()):this.ghostIndex>=0&&0===this.ghostStruct.wrappedShapes.length&&this.ghost&&(this.ghostIndex=-1,this.wrappedWorld.removeGhostObject(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),i}();J.idCounter=0,J.sharedBodesMap=new Map;var H=M,Y={},Q=function(){function e(){this.id=e.idCounter++,this._isEnabled=!1,this._isTrigger=!1,this._isInitialized=!1,this._impl=0,this._compound=0,this.quat=T.Quat_new(0,0,0,1),this.transform=T.Transform_new()}var s=e.prototype;return s.updateEventListener=function(){this._sharedBody.wrappedWorld.updateNeedEmitEvents(this.collider.needCollisionEvent||this.collider.needTriggerEvent)},s.setMaterial=function(t){if(!this._isTrigger&&this._isEnabled&&t)if(this._compound){Y[t._uuid]||(Y[t._uuid]=T.ccMaterial_new());var i=Y[t._uuid];T.ccMaterial_set(i,t.restitution,t.friction,t.rollingFriction,t.spinningFriction),T.CollisionShape_setMaterial(this._impl,i)}else T.CollisionObject_setMaterial(this._sharedBody.body,t.restitution,t.friction,t.rollingFriction,t.spinningFriction)},s.setCenter=function(t){i.copy(H,t),H.multiply(this._collider.node.worldScale),V(T.Transform_getOrigin(this.transform),H),this.updateCompoundTransform()},s.setAsTrigger=function(t){this._isTrigger!==t&&(this._isEnabled&&(this._sharedBody.removeShape(this,!t),this._sharedBody.addShape(this,t)),this._isTrigger=t)},s.getAABB=function(t){var e=E.instance.BT_TRANSFORM_0;T.Transform_setIdentity(e),T.Transform_setRotation(e,N(E.instance.BT_QUAT_0,this._collider.node.worldRotation));var s=E.instance.BT_V3_0,o=E.instance.BT_V3_1;T.CollisionShape_getAabb(this._impl,e,s,o),t.halfExtents.x=(T.Vec3_x(o)-T.Vec3_x(s))/2,t.halfExtents.y=(T.Vec3_y(o)-T.Vec3_y(s))/2,t.halfExtents.z=(T.Vec3_z(o)-T.Vec3_z(s))/2,i.add(t.center,this._collider.node.worldPosition,this._collider.center)},s.getBoundingSphere=function(t){t.radius=T.CollisionShape_getLocalBoundingSphere(this._impl),i.add(t.center,this._collider.node.worldPosition,this._collider.center)},s.initialize=function(t){this._collider=t,this._isInitialized=!0,this._sharedBody=u.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),this.setWrapper()},s.setWrapper=function(){E.isNotEmptyShape(this._impl)&&(T.CollisionShape_setUserPointer(this._impl,this._impl),E.setWrapper(this._impl,e.TYPE,this))},s.onLoad=function(){this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},s.onEnable=function(){this._isEnabled=!0,this._sharedBody.addShape(this,this._isTrigger),this.setMaterial(this.collider.sharedMaterial)},s.onDisable=function(){this._isEnabled=!1,this._sharedBody.removeShape(this,this._isTrigger)},s.onDestroy=function(){this._sharedBody.reference=!1,this._collider=null,T.Quat_del(this.quat),T.Transform_del(this.transform),this._compound&&T.CollisionShape_del(this._compound),E.isNotEmptyShape(this._impl)&&(T.CollisionShape_del(this._impl),E.delWrapper(this._impl,e.TYPE))},s.updateByReAdd=function(){this._isEnabled&&(this._sharedBody.removeShape(this,this._isTrigger),this._sharedBody.addShape(this,this._isTrigger))},s.getGroup=function(){return this._sharedBody.collisionFilterGroup},s.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},s.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},s.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},s.getMask=function(){return this._sharedBody.collisionFilterMask},s.setMask=function(t){this._sharedBody.collisionFilterMask=t},s.addMask=function(t){this._sharedBody.collisionFilterMask|=t},s.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},s.setCompound=function(t){this._compound&&T.CompoundShape_removeChildShape(this._compound,this._impl),t&&T.CompoundShape_addChildShape(t,this.transform,this._impl),this._compound=t},s.updateScale=function(){this.setCenter(this._collider.center)},s.updateCompoundTransform=function(){this._compound?T.CompoundShape_updateChildTransform(this._compound,this._impl,this.transform,!0):this._isEnabled&&!this._isTrigger&&this._sharedBody&&!this._sharedBody.bodyStruct.useCompound&&(this._sharedBody.dirty|=O.BODY_RE_ADD)},s.needCompound=function(){return this._collider.type===C.TERRAIN||!this._collider.center.equals(i.ZERO)},t(e,[{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"impl",get:function(){return this._impl}},{key:"collider",get:function(){return this._collider}},{key:"sharedBody",get:function(){return this._sharedBody}}]),e}();Q.TYPE="shape",Q.idCounter=0;var K=function(){function s(t){this.impl=0,this.event=t}var o=s.prototype;return o.getLocalPointOnA=function(t){this.impl&&k(t,T.ManifoldPoint_get_m_localPointA(this.impl))},o.getLocalPointOnB=function(t){this.impl&&k(t,T.ManifoldPoint_get_m_localPointB(this.impl))},o.getWorldPointOnA=function(t){this.impl&&k(t,T.ManifoldPoint_get_m_positionWorldOnA(this.impl))},o.getWorldPointOnB=function(t){this.impl&&k(t,T.ManifoldPoint_get_m_positionWorldOnB(this.impl))},o.getLocalNormalOnA=function(t){if(this.impl){var s=E.instance.BT_QUAT_0,o=T.PersistentManifold_getBody0(this.impl),n=T.CollisionObject_getWorldTransform(o);T.Transform_getRotation(n,s);var r=F;L(r,s),e.conjugate(r,r),k(t,T.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||i.negate(t,t),i.transformQuat(t,t,r)}},o.getLocalNormalOnB=function(t){if(this.impl){var s=E.instance.BT_QUAT_0,o=T.PersistentManifold_getBody1(this.impl),n=T.CollisionObject_getWorldTransform(o);T.Transform_getRotation(n,s);var r=F;L(r,s),e.conjugate(r,r),k(t,T.ManifoldPoint_get_m_normalWorldOnB(this.impl)),i.transformQuat(t,t,r)}},o.getWorldNormalOnA=function(t){this.impl&&(k(t,T.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||i.negate(t,t))},o.getWorldNormalOnB=function(t){this.impl&&k(t,T.ManifoldPoint_get_m_normalWorldOnB(this.impl))},t(s,[{key:"isBodyA",get:function(){return this.event.selfCollider.shape.sharedBody.body===T.PersistentManifold_getBody0(this.impl)}}]),s}(),q=[],Z=M,X=P,$=function(){var e=s.prototype;function s(){this._world=void 0,this._broadphase=void 0,this._solver=void 0,this._dispatcher=void 0,this._needEmitEvents=!1,this._needSyncAfterEvents=!1,this.bodies=[],this.ghosts=[],this.constraints=[],this.triggerArrayMat=new v,this.collisionArrayMat=new v,this.contactsDic=new B,this.oldContactsDic=new B,this._broadphase=T.DbvtBroadphase_new(),this._dispatcher=T.CollisionDispatcher_new(),this._solver=T.SequentialImpulseConstraintSolver_new(),this._world=T.ccDiscreteDynamicsWorld_new(this._dispatcher,this._broadphase,this._solver)}return e.setDefaultMaterial=function(){},e.setAllowSleep=function(t){T.ccDiscreteDynamicsWorld_setAllowSleep(this._world,t)},e.setGravity=function(t){T.DynamicsWorld_setGravity(this._world,V(E.instance.BT_V3_0,t))},e.updateNeedEmitEvents=function(t){if(this.ghosts)if(t)this._needEmitEvents=!0;else{this._needEmitEvents=!1;for(var i=0;i<this.ghosts.length;i++)for(var e=this.ghosts[i].ghostStruct.wrappedShapes,s=0;s<e.length;s++){var o=e[s].collider;if(o.needCollisionEvent||o.needTriggerEvent)return void(this._needEmitEvents=!0)}for(var n=0;n<this.bodies.length;n++)for(var r=this.bodies[n].bodyStruct.wrappedShapes,a=0;a<r.length;a++){var l=r[a].collider;if(l.needCollisionEvent||l.needTriggerEvent)return void(this._needEmitEvents=!0)}}},e.destroy=function(){(this.constraints.length||this.bodies.length)&&r("You should destroy all physics component first."),T.CollisionWorld_del(this._world),T.DbvtBroadphase_del(this._broadphase),T.CollisionDispatcher_del(this._dispatcher),T.SequentialImpulseConstraintSolver_del(this._solver),this.bodies=null,this.ghosts=null,this.constraints=null,this.triggerArrayMat=null,this.collisionArrayMat=null,this.contactsDic=null,this.oldContactsDic=null,q.length=0},e.step=function(t,i,e){void 0===e&&(e=0),(this.bodies.length||this.ghosts.length)&&(void 0===i&&(i=t),T.DynamicsWorld_stepSimulation(this._world,i,e,t))},e.syncSceneToPhysics=function(){for(var t=this.ghosts.length-1;t>=0;t--){var i=this.ghosts[t];i.updateDirty(),i.syncSceneToGhost()}for(var e=this.bodies.length-1;e>=0;e--){var s=this.bodies[e];s.updateDirty(),s.syncSceneToPhysics()}},e.syncAfterEvents=function(){this._needSyncAfterEvents&&this.syncSceneToPhysics()},e.raycast=function(t,e,s,o){t.computeHit(Z,e.maxDistance);var n=V(E.instance.BT_V3_0,Z),r=V(E.instance.BT_V3_1,t.o),a=T.ccAllRayCallback_static();if(T.ccAllRayCallback_reset(a,r,n,e.mask,e.queryTrigger),T.CollisionWorld_rayTest(this._world,r,n,a),T.RayCallback_hasHit(a)){for(var l=T.ccAllRayCallback_getHitPointWorld(a),d=T.ccAllRayCallback_getHitNormalWorld(a),h=T.ccAllRayCallback_getCollisionShapePtrs(a),c=0,p=T.int_array_size(h);c<p;c++){k(Z,T.Vec3_array_at(l,c)),k(X,T.Vec3_array_at(d,c));var _=E.getWrapper(T.int_array_at(h,c),Q.TYPE),u=s.add();o.push(u),u._assign(Z,i.distance(t.o,Z),_.collider,X)}return!0}return!1},e.raycastClosest=function(t,e,s){t.computeHit(Z,e.maxDistance);var o=V(E.instance.BT_V3_0,Z),n=V(E.instance.BT_V3_1,t.o),r=T.ccClosestRayCallback_static();if(T.ccClosestRayCallback_reset(r,n,o,e.mask,e.queryTrigger),T.CollisionWorld_rayTest(this._world,n,o,r),T.RayCallback_hasHit(r)){k(Z,T.ccClosestRayCallback_getHitPointWorld(r)),k(X,T.ccClosestRayCallback_getHitNormalWorld(r));var a=E.getWrapper(T.ccClosestRayCallback_getCollisionShapePtr(r),Q.TYPE);return s._assign(Z,i.distance(t.o,Z),a.collider,X),!0}return!1},e.getSharedBody=function(t,i){return J.getSharedBody(t,this,i)},e.addSharedBody=function(t){this.bodies.indexOf(t)<0&&(this.bodies.push(t),T.DynamicsWorld_addRigidBody(this._world,t.body,t.collisionFilterGroup,t.collisionFilterMask))},e.removeSharedBody=function(t){var i=this.bodies.indexOf(t);i>=0&&(o(this.bodies,i),T.DynamicsWorld_removeRigidBody(this._world,t.body))},e.addGhostObject=function(t){this.ghosts.indexOf(t)<0&&(this.ghosts.push(t),T.CollisionWorld_addCollisionObject(this._world,t.ghost,t.collisionFilterGroup,t.collisionFilterMask))},e.removeGhostObject=function(t){var i=this.ghosts.indexOf(t);i>=0&&(o(this.ghosts,i),T.CollisionWorld_removeCollisionObject(this._world,t.ghost))},e.addConstraint=function(t){var i=this.constraints.indexOf(t);i<0&&(this.constraints.push(t),T.DynamicsWorld_addConstraint(this.impl,t.impl,!t.constraint.enableCollision),t.index=i)},e.removeConstraint=function(t){var i=this.constraints.indexOf(t);i>=0&&(this.constraints.splice(i,1),T.DynamicsWorld_removeConstraint(this.impl,t.impl),t.index=-1)},e.emitEvents=function(){if(this._needSyncAfterEvents=!1,this._needEmitEvents){this.gatherConatactData();for(var t=this.contactsDic.getLength();t--;){q.push.apply(q,A.contacts),A.contacts.length=0;var i=this.contactsDic.getKeyByIndex(t),e=this.contactsDic.getDataByKey(i),s=e.shape0,o=e.shape1;this.oldContactsDic.set(s.id,o.id,e);var n=s.collider,r=o.collider;if(n&&r){if(n.isTrigger||r.isTrigger)this.triggerArrayMat.get(s.id,o.id)?b.type="onTriggerStay":(b.type="onTriggerEnter",this.triggerArrayMat.set(s.id,o.id,!0)),b.impl=e.impl,b.selfCollider=n,b.otherCollider=r,n.emit(b.type,b),b.selfCollider=r,b.otherCollider=n,r.emit(b.type,b),this._needSyncAfterEvents=!0;else{var a=n.attachedRigidBody,l=r.attachedRigidBody;if(a&&l){if(a.isSleeping&&l.isSleeping)continue}else if(!a&&l){if(l.isSleeping)continue}else if(!l&&a&&a.isSleeping)continue;this.collisionArrayMat.get(s.id,o.id)?A.type="onCollisionStay":(A.type="onCollisionEnter",this.collisionArrayMat.set(s.id,o.id,!0));for(var d=0;d<e.contacts.length;d++){var h=e.contacts[d];if(q.length>0){var c=q.pop();c.impl=h,A.contacts.push(c)}else{var p=new K(A);p.impl=h,A.contacts.push(p)}}A.impl=e.impl,A.selfCollider=n,A.otherCollider=r,n.emit(A.type,A),A.selfCollider=r,A.otherCollider=n,r.emit(A.type,A),this._needSyncAfterEvents=!0}null==this.oldContactsDic.get(s.id,o.id)&&this.oldContactsDic.set(s.id,o.id,e)}}for(var _=this.oldContactsDic.getLength();_--;){var u=this.oldContactsDic.getKeyByIndex(_),y=this.oldContactsDic.getDataByKey(u),f=y.shape0,g=y.shape1,S=f.collider,m=g.collider;if(S&&m){var C=S.isTrigger||m.isTrigger;null==this.contactsDic.getDataByKey(u)&&(C?this.triggerArrayMat.get(f.id,g.id)&&(b.type="onTriggerExit",b.selfCollider=S,b.otherCollider=m,S.emit(b.type,b),b.selfCollider=m,b.otherCollider=S,m.emit(b.type,b),this.triggerArrayMat.set(f.id,g.id,!1),this.oldContactsDic.set(f.id,g.id,null),this._needSyncAfterEvents=!0):this.collisionArrayMat.get(f.id,g.id)&&(q.push.apply(q,A.contacts),A.contacts.length=0,A.type="onCollisionExit",A.selfCollider=S,A.otherCollider=m,S.emit(A.type,A),A.selfCollider=m,A.otherCollider=S,m.emit(A.type,A),this.collisionArrayMat.set(f.id,g.id,!1),this.oldContactsDic.set(f.id,g.id,null),this._needSyncAfterEvents=!0))}}this.contactsDic.reset()}},e.gatherConatactData=function(){for(var t=T.Dispatcher_getNumManifolds(this._dispatcher),i=0;i<t;i++)for(var e=T.Dispatcher_getManifoldByIndexInternal(this._dispatcher,i),s=T.PersistentManifold_getNumContacts(e),o=0;o<s;o++){var n=T.PersistentManifold_getContactPoint(e,o),r=T.ManifoldPoint_getShape0(n),a=T.ManifoldPoint_getShape1(n),l=E.getWrapper(r,Q.TYPE),d=E.getWrapper(a,Q.TYPE);if(l.collider.needTriggerEvent||d.collider.needTriggerEvent||l.collider.needCollisionEvent||d.collider.needCollisionEvent){var h=this.contactsDic.get(l.id,d.id);h||(h=this.contactsDic.set(l.id,d.id,{shape0:l,shape1:d,contacts:[],impl:e})),h.contacts.push(n)}}},t(s,[{key:"impl",get:function(){return this._world}}]),s}(),tt=function(i){function e(){return i.apply(this,arguments)||this}a(e,i);var s=e.prototype;return s.updateSize=function(){var t=E.instance.BT_V3_0;V(t,this.getMinUnscaledHalfExtents(y)),T.BoxShape_setUnscaledHalfExtents(this.impl,t),this.updateCompoundTransform()},s.onComponentSet=function(){var t=E.instance.BT_V3_0;V(t,this.getMinUnscaledHalfExtents(y)),this._impl=T.BoxShape_new(t),this.updateScale()},s.updateScale=function(){i.prototype.updateScale.call(this);var t=E.instance.BT_V3_0;T.CollisionShape_setLocalScaling(this._impl,V(t,this.getMinScale(y))),this.updateCompoundTransform()},s.getMinUnscaledHalfExtents=function(t){var i=this.collider.size,e=f(y.set(this._collider.node.worldScale)),s=u.instance.minVolumeSize,o=i.x/2,n=i.y/2,r=i.z/2,a=o*e.x<s?s/e.x:o,l=n*e.y<s?s/e.y:n,d=r*e.z<s?s/e.z:r;return t.set(a,l,d),t},s.getMinScale=function(t){var i=this.collider.size,e=f(y.set(this._collider.node.worldScale)),s=u.instance.minVolumeSize,o=i.x/2,n=i.y/2,r=i.z/2,a=o*e.x<s?s/o:e.x,l=n*e.y<s?s/n:e.y,d=r*e.z<s?s/r:e.z;return t.set(a,l,d),t},t(e,[{key:"collider",get:function(){return this._collider}}]),e}(Q),it=function(i){function e(){return i.apply(this,arguments)||this}a(e,i);var s=e.prototype;return s.updateRadius=function(){T.SphereShape_setUnscaledRadius(this.impl,this.getMinUnscaledRadius()),this.updateCompoundTransform()},s.onComponentSet=function(){this._impl=T.SphereShape_new(this.getMinUnscaledRadius()),this.updateScale()},s.updateScale=function(){i.prototype.updateScale.call(this);var t=this.getMinScale();M.set(t,t,t);var e=E.instance.BT_V3_0;T.CollisionShape_setLocalScaling(this._impl,V(e,M)),this.updateCompoundTransform()},s.getMinUnscaledRadius=function(){var t=this.collider.radius,i=Math.abs(l(this._collider.node.worldScale)),e=u.instance.minVolumeSize;return i*t<e?e/i:t},s.getMinScale=function(){var t=this.collider.radius,i=Math.abs(l(this._collider.node.worldScale)),e=u.instance.minVolumeSize;return i*t<e?e/t:i},t(e,[{key:"collider",get:function(){return this._collider}}]),e}(Q),et=function(i){function e(){return i.apply(this,arguments)||this}a(e,i);var s=e.prototype;return s.setCylinderHeight=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},s.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},s.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},s.onComponentSet=function(){this._impl=T.CapsuleShape_new(.5,1),this.setRadius(this.collider.radius)},s.updateScale=function(){i.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},s.updateProperties=function(t,i,e,s){var o,n,r=s,a=e;1===a?(o=t*Math.abs(d(r.x,r.z)),n=i/2*Math.abs(r.y)):0===a?(o=t*Math.abs(d(r.y,r.z)),n=i/2*Math.abs(r.x)):(o=t*Math.abs(d(r.x,r.y)),n=i/2*Math.abs(r.z)),T.CapsuleShape_updateProp(this._impl,o,n,a),this.updateCompoundTransform()},t(e,[{key:"collider",get:function(){return this._collider}}]),e}(Q),st=function(i){function e(){for(var t,e=arguments.length,s=new Array(e),o=0;o<e;o++)s[o]=arguments[o];return(t=i.call.apply(i,[this].concat(s))||this).refBtTriangleMesh=0,t}a(e,i);var o=e.prototype;return o.setMesh=function(t){if(this._isInitialized)if(this._impl&&E.isNotEmptyShape(this._impl))h(9620);else{var i=t;if(i&&i.renderingSubMeshes.length>0){var e=this._getBtTriangleMesh(i);this.collider.convex?this._impl=T.ConvexTriangleMeshShape_new(e):this._impl=T.BvhTriangleMeshShape_new(e,!0,!0);var s=E.instance.BT_V3_0;V(s,this._collider.node.worldScale),T.CollisionShape_setMargin(this._impl,.01),T.CollisionShape_setLocalScaling(this._impl,s),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=T.EmptyShape_static()}},o.onComponentSet=function(){this.setMesh(this.collider.mesh)},o.onDestroy=function(){this.refBtTriangleMesh&&T.TriangleMesh_del(this.refBtTriangleMesh),i.prototype.onDestroy.call(this)},o.updateScale=function(){i.prototype.updateScale.call(this);var t=E.instance.BT_V3_0;V(t,this._collider.node.worldScale),T.CollisionShape_setLocalScaling(this._impl,t),this.updateCompoundTransform()},o._getBtTriangleMesh=function(t){return this.refBtTriangleMesh=T.TriangleMesh_new(),function(t,i){for(var e=i.renderingSubMeshes.length,o=0;o<e;o++){var n=i.renderingSubMeshes[o],r=n.geometricInfo;if(r){var a=n.primitiveMode,l=r.positions,d=r.indices,h=E.instance.BT_V3_0,c=E.instance.BT_V3_1,p=E.instance.BT_V3_2;if(a===s.TRIANGLE_LIST)for(var _=d.length,u=0;u<_;u+=3){var y=3*d[u],f=3*d[u+1],g=3*d[u+2];T.Vec3_set(h,l[y],l[y+1],l[y+2]),T.Vec3_set(c,l[f],l[f+1],l[f+2]),T.Vec3_set(p,l[g],l[g+1],l[g+2]),T.TriangleMesh_addTriangle(t,h,c,p)}else if(a===s.TRIANGLE_STRIP)for(var S=d.length-2,m=0,C=0;C<S;C+=1){var B=3*d[C-m],v=3*d[C+m+1],b=3*d[C+2];m=~m,T.Vec3_set(h,l[B],l[B+1],l[B+2]),T.Vec3_set(c,l[v],l[v+1],l[v+2]),T.Vec3_set(p,l[b],l[b+1],l[b+2]),T.TriangleMesh_addTriangle(t,h,c,p)}else if(a===s.TRIANGLE_FAN){var A=d.length-1,O=3*d[0];T.Vec3_set(h,l[O],l[O+1],l[O+2]);for(var w=1;w<A;w+=1){var I=3*d[w],R=3*d[w+1];T.Vec3_set(c,l[I],l[I+1],l[I+2]),T.Vec3_set(p,l[R],l[R+1],l[R+2]),T.TriangleMesh_addTriangle(t,h,c,p)}}}}}(this.refBtTriangleMesh,t),this.refBtTriangleMesh},t(e,[{key:"collider",get:function(){return this._collider}}]),e}(Q),ot=function(i){function e(){return i.apply(this,arguments)||this}a(e,i);var s=e.prototype;return s.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},s.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},s.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},s.onComponentSet=function(){var t=E.instance.BT_V3_0;T.Vec3_set(t,.5,1,.5),this._impl=T.CylinderShape_new(t),this.setRadius(this.collider.radius)},s.updateScale=function(){i.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},s.updateProperties=function(t,i,e,s){var o,n,r=s,a=e;1===a?(n=i*Math.abs(r.y),o=t*Math.abs(d(r.x,r.z))):0===a?(n=i*Math.abs(r.x),o=t*Math.abs(d(r.y,r.z))):(n=i*Math.abs(r.z),o=t*Math.abs(d(r.x,r.y))),T.CylinderShape_updateProp(this._impl,o,n/2,a),this.updateCompoundTransform()},t(e,[{key:"collider",get:function(){return this._collider}}]),e}(Q),nt=function(i){function e(){return i.apply(this,arguments)||this}a(e,i);var s=e.prototype;return s.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},s.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},s.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},s.onComponentSet=function(){this._impl=T.ConeShape_new(.5,1),this.setRadius(this.collider.radius)},s.updateScale=function(){i.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},s.updateProperties=function(t,i,e,s){var o,n,r=s,a=e;1===a?(n=i*Math.abs(r.y),o=t*Math.abs(d(r.x,r.z))):0===a?(n=i*Math.abs(r.x),o=t*Math.abs(d(r.y,r.z))):(n=i*Math.abs(r.z),o=t*Math.abs(d(r.x,r.y))),T.ConeShape_setRadius(this._impl,o),T.ConeShape_setHeight(this._impl,n),T.ConeShape_setConeUpIndex(this._impl,a);var l=E.instance.BT_V3_0;T.Vec3_set(l,1,1,1),T.CollisionShape_setLocalScaling(this._impl,l),this.updateCompoundTransform()},t(e,[{key:"impl",get:function(){return this._impl}},{key:"collider",get:function(){return this._collider}}]),e}(Q),rt=function(e){function s(){for(var t,s=arguments.length,o=new Array(s),n=0;n<s;n++)o[n]=arguments[n];return(t=e.call.apply(e,[this].concat(o))||this)._bufPtr=0,t._tileSize=0,t._localOffset=new i,t}a(s,e);var o=s.prototype;return o.setTerrain=function(t){if(this._isInitialized)if(this._impl&&E.isNotEmptyShape(this._impl))c("[Physics][Bullet]: change the terrain asset after initialization is not support.");else{var i=t;if(i){this._tileSize=i.tileSize;var e=i.getVertexCountI(),s=i.getVertexCountJ();this._bufPtr=T._malloc(4*e*s);for(var o=0,n=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,a=0;a<s;a++)for(var l=0;l<e;l++){var d=i.getHeight(l,a);T._write_f32(this._bufPtr+o,d),n>d&&(n=d),d>r&&(r=d),o+=4}r+=.01,n-=.01,this._localOffset.set((e-1)/2*this._tileSize,(r+n)/2,(s-1)/2*this._tileSize),this._impl=T.TerrainShape_new(e,s,this._bufPtr,1,n,r);var h=E.instance.BT_V3_0;T.Vec3_set(h,this._tileSize,1,this._tileSize),T.CollisionShape_setLocalScaling(this._impl,h),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=T.EmptyShape_static()}},o.onComponentSet=function(){this.setTerrain(this.collider.terrain)},o.onDestroy=function(){this._bufPtr&&T._free(this._bufPtr),e.prototype.onDestroy.call(this)},o.setCenter=function(t){i.copy(M,t),M.add(this._localOffset),V(T.Transform_getOrigin(this.transform),M),this.updateCompoundTransform()},t(s,[{key:"collider",get:function(){return this._collider}}]),s}(Q),at=function(i){function e(){return i.apply(this,arguments)||this}a(e,i);var s=e.prototype;return s.setShapeType=function(){},s.setVertices=function(){},s.onComponentSet=function(){this._impl=T.SimplexShape_new();for(var t=this.collider.shapeType,i=this.collider.vertices,e=E.instance.BT_V3_0,s=0;s<t;s++)T.SimplexShape_addVertex(this._impl,V(e,i[s]));T.CollisionShape_setLocalScaling(this._impl,V(e,this._collider.node.worldScale))},s.onLoad=function(){i.prototype.onLoad.call(this),this.collider.updateVertices()},s.updateScale=function(){i.prototype.updateScale.call(this);var t=E.instance.BT_V3_0;T.CollisionShape_setLocalScaling(this._impl,V(t,this._collider.node.worldScale))},t(e,[{key:"collider",get:function(){return this._collider}}]),e}(Q),lt=function(i){function e(){return i.apply(this,arguments)||this}a(e,i);var s=e.prototype;return s.setNormal=function(t){V(T.StaticPlaneShape_getPlaneNormal(this.impl),t),this.updateCompoundTransform()},s.setConstant=function(t){T.StaticPlaneShape_setPlaneConstant(this.impl,t),this.updateCompoundTransform()},s.updateScale=function(){i.prototype.updateScale.call(this);var t=E.instance.BT_V3_0;V(t,this._collider.node.worldScale),T.CollisionShape_setLocalScaling(this._impl,t),this.updateCompoundTransform()},s.onComponentSet=function(){var t=E.instance.BT_V3_0;V(t,this.collider.normal),this._impl=T.StaticPlaneShape_new(t,this.collider.constant),this.updateScale()},t(e,[{key:"collider",get:function(){return this._collider}}]),e}(Q),dt=function(){function i(){this.dirty=0,this.index=-1,this._impl=0,this._collided=!1}var e=i.prototype;return e.setConnectedBody=function(){},e.setEnableCollision=function(t){this._collided!==t&&(this._collided=t,this.updateByReAdd())},e.updateByReAdd=function(){if(this._rigidBody&&this.index>=0){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.wrappedWorld.addConstraint(this)}},e.initialize=function(t){this._com=t,this._rigidBody=t.attachedBody,this._collided=t.enableCollision,this.onComponentSet()},e.onEnable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.addConstraint(this),t.addJoint(this,0);var i=this.constraint.connectedBody;i&&i.body.sharedBody.addJoint(this,1)},e.onDisable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.removeJoint(this,0);var i=this.constraint.connectedBody;i&&i.body.sharedBody.removeJoint(this,1)},e.onDestroy=function(){T.TypedConstraint_del(this._impl),this._com=null,this._rigidBody=null},t(i,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),i}(),ht=function(e){function s(){return e.apply(this,arguments)||this}a(s,e);var o=s.prototype;return o.setPivotA=function(){var t=this.constraint,e=E.instance.BT_V3_0;i.multiply(M,t.node.worldScale,t.pivotA),V(e,M),T.P2PConstraint_setPivotA(this._impl,e),t.connectedBody||this.setPivotB(t.pivotB)},o.setPivotB=function(){var t=this.constraint,e=this._rigidBody.node,s=E.instance.BT_V3_0,o=t.connectedBody;o?(i.multiply(M,o.node.worldScale,t.pivotB),V(s,M)):(i.multiply(M,e.worldScale,t.pivotA),i.add(M,M,e.worldPosition),i.add(M,M,t.pivotB),V(s,M)),T.P2PConstraint_setPivotB(this._impl,s)},o.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t?t.body.impl:T.TypedConstraint_getFixedBody(),s=E.instance.BT_V3_0,o=E.instance.BT_V3_1;this._impl=T.P2PConstraint_new(i,e,s,o),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},o.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},o.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},t(s,[{key:"constraint",get:function(){return this._com}}]),s}(dt),ct=function(s){function o(){return s.apply(this,arguments)||this}a(o,s);var n=o.prototype;return n.setPivotA=function(){this.updateFrames()},n.setPivotB=function(){this.updateFrames()},n.setAxis=function(){this.updateFrames()},n.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t?t.body.impl:T.TypedConstraint_getFixedBody(),s=E.instance.BT_TRANSFORM_0,o=E.instance.BT_TRANSFORM_1;this._impl=T.HingeConstraint_new(i,e,s,o),this.updateFrames()},n.updateFrames=function(){var t=this.constraint,s=t.node,o=M,n=F,r=E.instance.BT_TRANSFORM_0;i.multiply(o,s.worldScale,t.pivotA),V(T.Transform_getOrigin(r),o);var a=E.instance.BT_QUAT_0;e.rotationTo(n,i.UNIT_Z,t.axis),N(a,n),T.Transform_setRotation(r,a);var l=E.instance.BT_TRANSFORM_1,d=this.constraint.connectedBody;d?i.multiply(o,d.node.worldScale,t.pivotB):(i.multiply(o,s.worldScale,t.pivotA),i.add(o,o,s.worldPosition),i.add(o,o,t.pivotB),e.multiply(n,n,s.worldRotation)),V(T.Transform_getOrigin(l),o),N(a,n),T.Transform_setRotation(l,a),T.HingeConstraint_setFrames(this._impl,r,l)},n.updateScale0=function(){this.updateFrames()},n.updateScale1=function(){this.updateFrames()},t(o,[{key:"constraint",get:function(){return this._com}}]),o}(dt);p.once(_.EVENT_ENGINE_INITED,(function(){g.register("bullet",{PhysicsWorld:$,RigidBody:W,BoxShape:tt,SphereShape:it,CapsuleShape:et,TrimeshShape:st,CylinderShape:ot,ConeShape:nt,TerrainShape:rt,SimplexShape:at,PlaneShape:lt,PointToPointConstraint:ht,HingeConstraint:ct})}))}}}));
