System.register(["./json-asset-7bb011fd.js","./spot-light-44c8b89f.js","./texture-buffer-pool-2b0fe4d4.js","./transform-utils-ec8404a7.js","./create-mesh-a2b1066e.js","./mesh-12590811.js","./mesh-renderer-f61cfd03.js","./skeleton-5498f045.js"],(function(t){"use strict";var e,i,n,r,o,s,a,l,u,h,c,p,f,d,_,m,g,y,v,b,k,w,D,S,A,T,x,M,I,R,O,B,N,L,C,P,j,z,E,H,F,U,V,K,W,G,J,q,X,Y,Z,Q,$,tt,et,it,nt,rt,ot,st,at,lt,ut,ht,ct,pt,ft,dt,_t,mt,gt,yt,vt,bt,kt,wt,Dt,St,At,Tt,xt,Mt,It,Rt,Ot,Bt;return{setters:[function(t){e=t.dK,i=t.gt,n=t.gu,r=t.gv,o=t.cb,s=t.cR,a=t.l,l=t.fj,u=t.cI,h=t.c4,c=t.eq,p=t.ej,f=t.er,d=t.ez,_=t.ev,m=t.ew,g=t.gw,y=t.es,v=t.et,b=t.fS,k=t.gx,w=t.ey,D=t.dO,S=t.ci,A=t.gy,T=t.fT,x=t.fV,M=t.fW,I=t.g5,R=t.cq,O=t.cQ,B=t.c8,N=t.aB,L=t.L,C=t.N,P=t.ed,j=t.b8,z=t.F,E=t.x,H=t.au,F=t.z,U=t.G,V=t.gz,K=t.t,W=t.gA,G=t.bQ,J=t.d,q=t.gB,X=t.gC,Y=t.gD,Z=t.dH,Q=t.gg,$=t.aL,tt=t.b7,et=t.dp,it=t.d6,nt=t.dl,rt=t.gE,ot=t.fH,st=t.gF,at=t.c2,lt=t.gG,ut=t.ao,ht=t.T},function(t){ct=t.L,pt=t.h,ft=t.e,dt=t.D,_t=t.k,mt=t.n,gt=t.l,yt=t.M},function(t){vt=t.T},function(t){bt=t.p,kt=t.v,wt=t.t,Dt=t.u,St=t.r,At=t.j,Tt=t.k},function(t){xt=t.r,Mt=t.c},function(t){It=t.M},function(t){Rt=t.M,Ot=t.a},function(t){Bt=t.S}],execute:function(){var Nt,Lt,Ct,Pt,jt,zt,Et,Ht,Ft,Ut,Vt,Kt,Wt,Gt,Jt,qt,Xt,Yt,Zt,Qt,$t,te=Object.freeze({__proto__:null,find:e,toPPM:function(t,e,i){return"P3 "+e+" "+i+" 255\n"+t.filter((function(t,e){return e%4<3})).toString()+"\n"},readMesh:xt,createMesh:Mt,readBuffer:i,writeBuffer:n,mapBuffer:r});function ee(t,e){var i=t.sharedMaterials.length;if(i!==e.sharedMaterials.length)return!1;for(var n=0;n<i;n++)if(t.getRenderMaterial(n)!==e.getRenderMaterial(n))return!1;return!0}t("u",te),t("B",function(){function t(){}return t.batchStaticModel=function(t,e){var i=t.getComponentsInChildren(Rt);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var n=1;n<i.length;n++){if(!i[0].mesh.validateMergingMesh(i[n].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1;if(!ee(i[0],i[n]))return console.error("the materials of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1}var r=new It,s=new o,a=new o;t.getWorldMatrix(a),o.invert(a,a);for(var l=0;l<i.length;l++){var u=i[l];u.node.getWorldMatrix(s),o.multiply(s,a,s),r.merge(i[l].mesh,s),u.enabled=!1}var h=e.addComponent(Rt);return h.mesh=r,h.sharedMaterials=i[0].sharedMaterials,!0},t.unbatchStaticModel=function(t,e){for(var i=t.getComponentsInChildren(Rt),n=0;n<i.length;n++)i[n].enabled=!0;var r=e.getComponent(Rt);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},t}()),s(Rt.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),a.ModelComponent=Rt,l.setClassAlias(Rt,"cc.ModelComponent");var ie,ne,re,oe,se,ae,le,ue,he,ce,pe,fe,de,_e,me,ge,ye,ve,be,ke,we,De,Se,Ae,Te,xe,Me,Ie,Re,Oe,Be,Ne,Le,Ce,Pe,je,ze,Ee,He,Fe,Ue,Ve,Ke,We,Ge,Je,qe,Xe,Ye,Ze=u({LUMINOUS_FLUX:0,LUMINANCE:1}),Qe=new h,$e=c("cc.StaticLightSettings")((Et=function(){function t(){y(this,"_baked",Ct,this),y(this,"_editorOnly",Pt,this),y(this,"_bakeable",jt,this),y(this,"_castShadow",zt,this)}return p(t,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(t){this._editorOnly=t}},{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}}]),t}(),Ct=f((Lt=Et).prototype,"_baked",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pt=f(Lt.prototype,"_editorOnly",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jt=f(Lt.prototype,"_bakeable",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zt=f(Lt.prototype,"_castShadow",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(Lt.prototype,"editorOnly",[d],Object.getOwnPropertyDescriptor(Lt.prototype,"editorOnly"),Lt.prototype),f(Lt.prototype,"bakeable",[d],Object.getOwnPropertyDescriptor(Lt.prototype,"bakeable"),Lt.prototype),f(Lt.prototype,"castShadow",[d],Object.getOwnPropertyDescriptor(Lt.prototype,"castShadow"),Lt.prototype),Nt=Lt))||Nt,ti=t("L",(Ht=c("cc.Light"),Ft=b(),Ut=b(),Vt=k(),Kt=b(),Wt=_($e),Ht(($t=Qt=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_color",qt,w(e)),y(e,"_useColorTemperature",Xt,w(e)),y(e,"_colorTemperature",Yt,w(e)),y(e,"_staticSettings",Zt,w(e)),e._type=ct.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=pt,e}m(e,t);var i=e.prototype;return i.onLoad=function(){this._createLight()},i.onEnable=function(){this._attachToScene()},i.onDisable=function(){this._detachFromScene()},i.onDestroy=function(){this._destroyLight()},i._createLight=function(){this._light||(this._light=a.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},i._destroyLight=function(){this._light&&(a.director.root.destroyLight(this),this._light=null)},i._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var t=this._getRenderScene();switch(this._type){case ct.DIRECTIONAL:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case ct.SPHERE:t.addSphereLight(this._light);break;case ct.SPOT:t.addSpotLight(this._light)}}},i._detachFromScene=function(){if(this._light&&this._light.scene){var t=this._light.scene;switch(this._type){case ct.DIRECTIONAL:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case ct.SPHERE:t.removeSphereLight(this._light);break;case ct.SPOT:t.removeSpotLight(this._light)}}},p(e,[{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._light&&(Qe.x=t.r/255,Qe.y=t.g/255,Qe.z=t.b/255,this._light.color=Qe)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(t){this._staticSettings=t}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}}]),e}(D),Qt.Type=ct,Qt.PhotometricTerm=Ze,qt=f((Jt=$t).prototype,"_color",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S.WHITE.clone()}}),Xt=f(Jt.prototype,"_useColorTemperature",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yt=f(Jt.prototype,"_colorTemperature",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),Zt=f(Jt.prototype,"_staticSettings",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $e}}),f(Jt.prototype,"color",[Ft],Object.getOwnPropertyDescriptor(Jt.prototype,"color"),Jt.prototype),f(Jt.prototype,"useColorTemperature",[Ut],Object.getOwnPropertyDescriptor(Jt.prototype,"useColorTemperature"),Jt.prototype),f(Jt.prototype,"colorTemperature",[g,Vt,Kt],Object.getOwnPropertyDescriptor(Jt.prototype,"colorTemperature"),Jt.prototype),f(Jt.prototype,"staticSettings",[Wt],Object.getOwnPropertyDescriptor(Jt.prototype,"staticSettings"),Jt.prototype),Gt=Jt))||Gt)),ei=t("D",(ie=c("cc.DirectionalLight"),ne=x(),re=M(),oe=A("_illuminance"),se=b(),ie(ae=ne(ae=re(ae=T((ce=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_illuminanceHDR",ue,w(e)),y(e,"_illuminanceLDR",he,w(e)),e._type=ct.DIRECTIONAL,e._light=null,e._lightType=dt,e}return m(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*ft.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},p(e,[{key:"illuminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){a.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=t,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=t,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),e}(ti),ue=f((le=ce).prototype,"_illuminanceHDR",[I,oe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),he=f(le.prototype,"_illuminanceLDR",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),f(le.prototype,"illuminance",[se],Object.getOwnPropertyDescriptor(le.prototype,"illuminance"),le.prototype),ae=le))||ae)||ae)||ae)||ae)),ii=t("S",(pe=c("cc.SphereLight"),fe=x(),de=M(),_e=A("_luminance"),me=b(),ge=b(),ye=_(Ze),ve=b(),be=b(),ke=b(),pe(we=fe(we=de(we=T((Ie=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_size",Se,w(e)),y(e,"_luminanceHDR",Ae,w(e)),y(e,"_luminanceLDR",Te,w(e)),y(e,"_term",xe,w(e)),y(e,"_range",Me,w(e)),e._type=ct.SPHERE,e._light=null,e._lightType=_t,e}return m(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*ft.standardExposureValue*ft.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/ft.standardExposureValue/ft.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},p(e,[{key:"luminousFlux",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*mt(this._size):this._luminanceLDR},set:function(t){var e=0;a.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/mt(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){a.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}}]),e}(ti),Se=f((De=Ie).prototype,"_size",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),Ae=f(De.prototype,"_luminanceHDR",[v,_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/mt(.15)}}),Te=f(De.prototype,"_luminanceLDR",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),xe=f(De.prototype,"_term",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ze.LUMINOUS_FLUX}}),Me=f(De.prototype,"_range",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),f(De.prototype,"luminousFlux",[me],Object.getOwnPropertyDescriptor(De.prototype,"luminousFlux"),De.prototype),f(De.prototype,"luminance",[ge],Object.getOwnPropertyDescriptor(De.prototype,"luminance"),De.prototype),f(De.prototype,"term",[ye,ve],Object.getOwnPropertyDescriptor(De.prototype,"term"),De.prototype),f(De.prototype,"size",[be],Object.getOwnPropertyDescriptor(De.prototype,"size"),De.prototype),f(De.prototype,"range",[ke],Object.getOwnPropertyDescriptor(De.prototype,"range"),De.prototype),we=De))||we)||we)||we)||we)),ni=t("a",(Re=c("cc.SpotLight"),Oe=x(),Be=M(),Ne=A("_luminance"),Le=b(),Ce=b(),Pe=_(Ze),je=b(),ze=b(),Ee=b(),He=k(),Fe=b(),Re(Ue=Oe(Ue=Be(Ue=T((Ye=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_size",Ke,w(e)),y(e,"_luminanceHDR",We,w(e)),y(e,"_luminanceLDR",Ge,w(e)),y(e,"_term",Je,w(e)),y(e,"_range",qe,w(e)),y(e,"_spotAngle",Xe,w(e)),e._type=ct.SPOT,e._light=null,e._lightType=gt,e}return m(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*ft.standardExposureValue*ft.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/ft.standardExposureValue/ft.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},p(e,[{key:"luminousFlux",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*mt(this._size):this._luminanceLDR},set:function(t){var e=0;a.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/mt(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){a.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._spotAngle=t,this._light&&(this._light.spotAngle=R(t))}}]),e}(ti),Ke=f((Ve=Ye).prototype,"_size",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),We=f(Ve.prototype,"_luminanceHDR",[v,Ne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/mt(.15)}}),Ge=f(Ve.prototype,"_luminanceLDR",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Je=f(Ve.prototype,"_term",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ze.LUMINOUS_FLUX}}),qe=f(Ve.prototype,"_range",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Xe=f(Ve.prototype,"_spotAngle",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),f(Ve.prototype,"luminousFlux",[Le],Object.getOwnPropertyDescriptor(Ve.prototype,"luminousFlux"),Ve.prototype),f(Ve.prototype,"luminance",[Ce],Object.getOwnPropertyDescriptor(Ve.prototype,"luminance"),Ve.prototype),f(Ve.prototype,"term",[Pe,je],Object.getOwnPropertyDescriptor(Ve.prototype,"term"),Ve.prototype),f(Ve.prototype,"size",[ze],Object.getOwnPropertyDescriptor(Ve.prototype,"size"),Ve.prototype),f(Ve.prototype,"range",[Ee],Object.getOwnPropertyDescriptor(Ve.prototype,"range"),Ve.prototype),f(Ve.prototype,"spotAngle",[g,He,Fe],Object.getOwnPropertyDescriptor(Ve.prototype,"spotAngle"),Ve.prototype),Ue=Ve))||Ue)||Ue)||Ue)||Ue));a.LightComponent=ti,l.setClassAlias(ti,"cc.LightComponent"),a.DirectionalLightComponent=ei,l.setClassAlias(ei,"cc.DirectionalLightComponent"),a.SphereLightComponent=ii,l.setClassAlias(ii,"cc.SphereLightComponent"),a.SpotLightComponent=ni,l.setClassAlias(ni,"cc.SpotLightComponent"),O(ni.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),O(ii.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),O(ti.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var ri=function(t,e,i){t[e+0]=i.m00,t[e+1]=i.m01,t[e+2]=i.m02,t[e+3]=i.m12,t[e+4]=i.m04,t[e+5]=i.m05,t[e+6]=i.m06,t[e+7]=i.m13,t[e+8]=i.m08,t[e+9]=i.m09,t[e+10]=i.m10,t[e+11]=i.m14};function oi(t,e){var i=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*i,t)/12)}new B,new B,new h,new B,new h;var si=new N(L.POINT,L.POINT,L.NONE,C.CLAMP,C.CLAMP,C.CLAMP),ai=new h,li=new h,ui=new h,hi=new h,ci=new o,pi=new o,fi=new P,di=Number.MAX_SAFE_INTEGER,_i=function(){function t(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var e=function(t){return t.hasFeature(z.TEXTURE_FLOAT)?E.RGBA32F:E.RGBA8}(this._device);this._formatSize=j[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new vt(t),this._pool.initialize({format:e,roundUpFn:oi}),this._customPool=new vt(t),this._customPool.initialize({format:e,roundUpFn:oi})}var e=t.prototype;return e.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},e.registerCustomTextureLayouts=function(t){for(var e=0;e<t.length;e++)for(var i=t[e],n=this._customPool.createChunk(i.textureLength),r=0;r<i.contents.length;r++){var o=i.contents[r],s=o.skeleton;this._chunkIdxMap.set(s,n);for(var a=0;a<o.clips.length;a++){var l=o.clips[a];this._chunkIdxMap.set(s^l,n)}}},e.getDefaultPoseTexture=function(t,e,i){var n=0^t.hash,r=this._textureBuffers.get(n)||null;if(r&&r.bounds.has(e.hash))return r.refCount++,r;var s=t.joints,a=t.bindposes,l=null,u=!1,c=s.length;if(r)r.refCount++;else{var p=12*c,f=this._chunkIdxMap.get(n),d=void 0!==f?this._customPool.alloc(p*Float32Array.BYTES_PER_ELEMENT,f):this._pool.alloc(p*Float32Array.BYTES_PER_ELEMENT);if(!d)return r;r={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:d},l=new Float32Array(p),u=!0}h.set(ui,di,di,di),h.set(hi,-di,-di,-di);for(var _=e.getBoneSpaceBounds(t),m=0,g=0;m<c;m++,g+=12){var y=i.getChildByPath(s[m]),v=y?bt(y,i,ci):t.inverseBindposes[m],b=_[m];b&&(P.transform(fi,b,v),fi.getBoundary(ai,li),h.min(ui,ui,ai),h.max(hi,hi,li)),u&&(y&&o.multiply(v,v,a[m]),ri(l,g,y?v:o.IDENTITY))}var k=[new P];return r.bounds.set(e.hash,k),P.fromPoints(k[0],ui,hi),u&&(this._pool.update(r.handle,l.buffer),this._textureBuffers.set(n,r)),r},e.getSequencePoseTexture=function(t,e,i,n){var r=t.hash^e.hash,s=this._textureBuffers.get(r)||null;if(s&&s.bounds.has(i.hash))return s.refCount++,s;var a=t.joints,l=t.bindposes,u=kt.getOrExtract(e).frames,c=null,p=!1,f=a.length;if(s)s.refCount++;else{var d=12*f*u,_=this._chunkIdxMap.get(r),m=void 0!==_?this._customPool.alloc(d*Float32Array.BYTES_PER_ELEMENT,_):this._pool.alloc(d*Float32Array.BYTES_PER_ELEMENT);if(!m)return null;var g=this._createAnimInfos(t,e,n);s={pixelOffset:m.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:m,animInfos:g},c=new Float32Array(d),p=!0}var y=i.getBoneSpaceBounds(t),v=[];s.bounds.set(i.hash,v);for(var b=0;b<u;b++)v.push(new P(di,di,di,-di,-di,-di));for(var k=0,w=0;k<u;k++){for(var D=v[k],S=0;S<f;S++,w+=12){var A=s.animInfos[S],T=A.curveData,x=A.downstream,M=A.bindposeIdx,I=A.bindposeCorrection,R=void 0,O=!0;T&&x?R=o.multiply(ci,T[k],x):T?R=T[k]:x?R=x:(R=t.inverseBindposes[M],O=!1);var B=y[S];if(B){var N=I?o.multiply(pi,R,I):R;P.transform(fi,B,N),fi.getBoundary(ai,li),h.min(D.center,D.center,ai),h.max(D.halfExtents,D.halfExtents,li)}p&&(O&&o.multiply(ci,R,l[M]),ri(c,w,O?ci:o.IDENTITY))}P.fromPoints(D,D.center,D.halfExtents)}return p&&(this._pool.update(s.handle,c.buffer),this._textureBuffers.set(r,s)),s},e.releaseHandle=function(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){var e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}},e.releaseSkeleton=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.skeletonHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e.releaseAnimationClip=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.clipHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e._createAnimInfos=function(t,e,i){for(var n=[],r=t.joints,s=t.bindposes,a=r.length,l=kt.getOrExtract(e),u=0;u<a;u++){for(var h=r[u],c=l.joints[h],p=i.getChildByPath(h),f=void 0,d=void 0;!c;){var _=h.lastIndexOf("/");if(h=h.substring(0,_),c=l.joints[h],p?(f||(f=new o),o.fromRTS(ci,p.rotation,p.position,p.scale),o.multiply(f,ci,f),p=p.parent):d=h,_<0)break}var m=u,g=void 0;if(void 0!==d&&c){m=u-1;for(var y=0;y<a;y++)if(r[y]===d){m=y,g=new o,o.multiply(g,s[y],t.inverseBindposes[u]);break}}n.push({curveData:c&&c.transforms,downstream:f,bindposeIdx:m,bindposeCorrection:g})}return n},p(t,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),t}(),mi=function(){function t(t){this._pool=new Map,this._device=void 0,this._device=t}var e=t.prototype;return e.getData=function(t){void 0===t&&(t="-1");var e=this._pool.get(t);if(e)return e;var i=this._device.createBuffer(new H(F.UNIFORM|F.TRANSFER_DST,U.HOST|U.DEVICE,V.SIZE,V.SIZE)),n=new Float32Array([0,0,0,0]);i.update(n);var r={buffer:i,data:n,dirty:!1};return this._setAnimInfoDirty(r,!1),this._pool.set(t,r),r},e.destroy=function(t){var e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))},e._setAnimInfoDirty=function(t,e){t.dirty=e},e.switchClip=function(t){return t.data[0]=0,t.buffer.update(t.data),this._setAnimInfoDirty(t,!1),t},e.clear=function(){for(var t,e=K(this._pool.values());!(t=e()).done;)t.value.buffer.destroy();this._pool.clear()},t}(),gi=function(){function t(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new _i(t),this.jointAnimationInfo=new mi(t)}var e=t.prototype;return e.releaseSkeleton=function(t){this.jointTexturePool.releaseSkeleton(t)},e.releaseAnimationClip=function(t){this.jointTexturePool.releaseAnimationClip(t)},e.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},t}();a.internal.DataPoolManager=gi;var yi=[{name:"CC_USE_SKINNING",value:!0}];function vi(t,e,i,n){for(var r=0;r<i.length;r++){for(var o=i[r],s=-1,a=0;a<o.length;a++)if(o[a]===n){s=a;break}s>=0&&(e.push(r),t.push(s))}}var bi,ki,wi,Di,Si,Ai,Ti,xi,Mi,Ii,Ri,Oi,Bi,Ni,Li,Ci,Pi,ji,zi,Ei,Hi,Fi,Ui,Vi,Ki,Wi,Gi,Ji,qi,Xi,Yi,Zi,Qi,$i,tn,en,nn,rn,on,sn,an,ln,un,hn,cn,pn=new h,fn=new h,dn=new h,_n=new h,mn=new o,gn=new P,yn=function(t){function e(){var e;return(e=t.call(this)||this).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=yt.SKINNING,e}m(e,t);var i=e.prototype;return i._init=function(){},i.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}t.prototype.destroy.call(this)},i.bindSkeleton=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null);for(var n=0;n<this._joints.length;n++)wt(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,t&&e&&i){this.transform=e;var r=i.getBoneSpaceBounds(t),o=i.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=i.jointBufferIndices;for(var s=0;s<t.joints.length;s++){var a=r[s],l=e.getChildByPath(t.joints[s]);if(a&&l){var u=Dt(l,e),h=t.bindposes[s],c=[],p=[];o?vi(c,p,o,s):(c.push(s),p.push(0)),this._joints.push({indices:c,buffers:p,bound:a,target:l,bindpose:h,transform:u})}}}},i.updateTransform=function(t){var e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._localDataUpdated=!0),h.set(pn,1/0,1/0,1/0),h.set(fn,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.bound,o=n.transform,s=St(o,t);P.transform(gn,r,s),gn.getBoundary(dn,_n),h.min(pn,pn,dn),h.max(fn,fn,_n)}var a=this._worldBounds;this._modelBounds&&a&&(P.fromPoints(this._modelBounds,pn,fn),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds),this._updateNativeBounds())},i.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.indices,s=n.buffers,a=n.transform,l=n.bindpose;o.multiply(mn,a.world,l);for(var u=0;u<s.length;u++)ri(this._dataArray[s[u]],12*r[u],mn)}for(var h=0;h<this._buffers.length;h++)this._buffers[h].update(this._dataArray[h]);return!0},i.initSubModel=function(e,i,n){var r=i.vertexBuffers,o=i.iaInfo;o.vertexBuffers=i.jointMappedBuffers,t.prototype.initSubModel.call(this,e,i,n),o.vertexBuffers=r},i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?yi.concat(i):yi},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._buffers[this._bufferIndices[e]];n&&i.bindBuffer(W.BINDING,n)},i._updateInstancedAttributes=function(e,i){i.batchingScheme!==G.NONE&&J(3936,this.node.name),t.prototype._updateInstancedAttributes.call(this,e,i)},i._ensureEnoughBuffers=function(t){for(var e=0;e<t;e++)this._buffers[e]||(this._buffers[e]=this._device.createBuffer(new H(F.UNIFORM|F.TRANSFER_DST,U.HOST|U.DEVICE,W.SIZE,W.SIZE))),this._dataArray[e]||(this._dataArray[e]=new Float32Array(W.COUNT))},e}(Ot),vn=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],bn=function(t){function e(){var e;(e=t.call(this)||this).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=yt.BAKED_SKINNING,e._dataPoolManager=a.director.root.dataPoolManager;var i=new Float32Array(4),n=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:i,animInfo:n,texture:null,boundsInfo:null},e}m(e,t);var i=e.prototype;return i._init=function(){},i.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),t.prototype.destroy.call(this)},i.bindSkeleton=function(t,e,i){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),this._skeleton=t,this._mesh=i,t&&e&&i){this.transform=e;var n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new H(F.UNIFORM|F.TRANSFER_DST,U.DEVICE,q.SIZE,q.SIZE)))}},i.updateTransform=function(e){if(t.prototype.updateTransform.call(this,e),this.uploadedAnim){var i=this._jointsMedium,n=i.animInfo,r=i.boundsInfo[n.data[0]],o=this._worldBounds;if(o&&r){var s=this.transform;r.transform(s._mat,s._pos,s._rot,s._scale,o)}}},i.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);var i=this._jointsMedium.animInfo,n=this._instAnimInfoIdx;return n>=0?this.instancedAttributes.views[n][0]=i.data[0]:i.dirty&&(i.buffer.update(i.data),i.dirty=!1),!0},i._applyNativeJointMedium=function(){},i._updateModelBounds=function(t){this._modelBounds=t},i.uploadAnimation=function(t){if(this._skeleton&&this._mesh&&this.uploadedAnim!==t){this.uploadedAnim=t;var e=this._dataPoolManager,i=null;t?(i=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(i=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(i&&i.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(i),this._applyNativeJointMedium()}},i._applyJointTexture=function(t){void 0===t&&(t=null);var e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,t){var i=this._jointsMedium,n=i.buffer,r=i.jointTextureInfo;r[0]=t.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=t.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),n&&n.update(r);for(var o=t.handle.texture,s=0;s<this._subModels.length;++s)this._subModels[s].descriptorSet.bindTexture(X,o)}},i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?i.concat(vn):vn},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._jointsMedium,r=n.buffer,o=n.texture,s=n.animInfo;if(i.bindBuffer(q.BINDING,r),i.bindBuffer(V.BINDING,s.buffer),o){var a=this._device.getSampler(si);i.bindTexture(X,o.handle.texture),i.bindSampler(X,a)}},i._setInstAnimInfoIdx=function(t){this._instAnimInfoIdx=t},i._updateInstancedAttributes=function(e,i){t.prototype._updateInstancedAttributes.call(this,e,i),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(Y)),this.updateInstancedJointTextureInfo()},i.updateInstancedJointTextureInfo=function(){var t=this._jointsMedium,e=t.jointTextureInfo,i=t.animInfo,n=this._instAnimInfoIdx;if(n>=0){var r=this.instancedAttributes.views[n];r[0]=i.data[0],r[1]=e[1],r[2]=e[2]}},e}(Ot),kn=t("b",(bi=c("cc.SkinnedMeshRenderer"),ki=x(),wi=Q(100),Di=M(),Si=_(Bt),Ai=_(Z),Ti=_(Bt),xi=_(Z),Mi=b(),bi(Ii=ki(Ii=wi(Ii=T(Ii=Di((Ni=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_skeleton",Oi,w(e)),y(e,"_skinningRoot",Bi,w(e)),e._clip=null,e._modelType=bn,e}m(e,t);var i=e.prototype;return i.__preload=function(){this._updateModelType()},i.uploadAnimation=function(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)},i.setUseBakedAnimation=function(t,e){void 0===t&&(t=!0),void 0===e&&(e=!1);var i=t?bn:yn;(e||this._modelType!==i)&&(this._modelType=i,this._model&&(a.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},i.setMaterial=function(e,i){t.prototype.setMaterial.call(this,e,i),this._modelType===yn&&this.getMaterialInstance(i)},i._updateModelParams=function(){this._update(),t.prototype._updateModelParams.call(this)},i._updateModelType=function(){if(this._skinningRoot){var t=this._skinningRoot.getComponent("cc.SkeletalAnimation");t?this.setUseBakedAnimation(t.useBakedAnimation):this.setUseBakedAnimation(!1)}},i._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},p(e,[{key:"skeleton",get:function(){return this._skeleton},set:function(t){t!==this._skeleton&&(this._skeleton=t,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(t){t!==this._skinningRoot&&(this._skinningRoot=t,this._updateModelType(),this._update())}},{key:"model",get:function(){return this._model}}]),e}(Rt),Oi=f((Ri=Ni).prototype,"_skeleton",[Si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bi=f(Ri.prototype,"_skinningRoot",[Ai],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(Ri.prototype,"skeleton",[Ti],Object.getOwnPropertyDescriptor(Ri.prototype,"skeleton"),Ri.prototype),f(Ri.prototype,"skinningRoot",[xi,Mi],Object.getOwnPropertyDescriptor(Ri.prototype,"skinningRoot"),Ri.prototype),Ii=Ri))||Ii)||Ii)||Ii)||Ii)||Ii)),wn=new $(tt.ATTR_BATCH_ID,E.R32F),Dn=new $(tt.ATTR_BATCH_UV,E.RG32F),Sn=j[wn.format].size+j[Dn.format].size,An=t("d",(Li=c("cc.SkinnedMeshUnit"),Ci=_(It),Pi=_(Bt),ji=_(et),zi=_(kn),Li((Ji=function(){function t(){y(this,"mesh",Fi,this),y(this,"skeleton",Ui,this),y(this,"material",Vi,this),y(this,"_localTransform",Ki,this),y(this,"_offset",Wi,this),y(this,"_size",Gi,this)}return p(t,[{key:"offset",get:function(){return this._offset},set:function(t){at.copy(this._offset,t)}},{key:"size",get:function(){return this._size},set:function(t){at.copy(this._size,t)}},{key:"copyFrom",get:function(){return null},set:function(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&bt(t.node,t.skinningRoot,this._localTransform))}}]),t}(),Fi=f((Hi=Ji).prototype,"mesh",[Ci],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ui=f(Hi.prototype,"skeleton",[Pi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vi=f(Hi.prototype,"material",[ji],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ki=f(Hi.prototype,"_localTransform",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),Wi=f(Hi.prototype,"_offset",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new at(0,0)}}),Gi=f(Hi.prototype,"_size",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new at(1,1)}}),f(Hi.prototype,"offset",[d],Object.getOwnPropertyDescriptor(Hi.prototype,"offset"),Hi.prototype),f(Hi.prototype,"size",[d],Object.getOwnPropertyDescriptor(Hi.prototype,"size"),Hi.prototype),f(Hi.prototype,"copyFrom",[zi],Object.getOwnPropertyDescriptor(Hi.prototype,"copyFrom"),Hi.prototype),Ei=Hi))||Ei)),Tn=new o,xn=(new o,new h),Mn=t("c",(qi=c("cc.SkinnedMeshBatchRenderer"),Xi=x(),Yi=Q(100),Zi=M(),Qi=b(),$i=_([it]),tn=b(),en=_([An]),nn=b(),rn=lt(),on=lt(),qi(sn=Xi(sn=Yi(sn=T(sn=Zi((cn=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return e=t.call.apply(t,[this].concat(n))||this,y(e,"atlasSize",ln,w(e)),y(e,"batchableTextureNames",un,w(e)),y(e,"units",hn,w(e)),e._textures={},e._batchMaterial=null,e}m(e,t);var s=e.prototype;return s.onLoad=function(){t.prototype.onLoad.call(this),this.cook()},s.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),t.prototype.onDestroy.call(this)},s._onMaterialModified=function(e){this.cookMaterials(),t.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},s.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},s.cookMaterials=function(){var t=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var e=this.getMaterialInstance(0);if(e&&this._batchMaterial&&this._batchMaterial.effectAsset){e.copy(this._batchMaterial),this.resizeAtlases();for(var i=e.effectAsset.techniques[e.technique],n=function(n){var r=i.passes[n];if(!r.properties)return"continue";var o=function(i){if(r.properties[i].type>=ht.SAMPLER1D){var o=null;t.batchableTextureNames.find((function(t){return t===i}))?((o=t._textures[i])||(o=t.createTexture(i)),t.cookTextures(o,i,n)):t.units.some((function(t){return o=t.material&&t.material.getProperty(i,n)})),o&&e.setProperty(i,o,n)}else{for(var s=[],a=0;a<t.units.length;a++){var l=t.units[a];l.material&&s.push(l.material.getProperty(i.slice(0,-3),n))}e.setProperty(i,s,n)}};for(var s in r.properties)o(s)},r=0;r<i.passes.length;r++)n(r)}else console.warn("incomplete batch material!")},s.cookSkeletons=function(){if(this._skinningRoot){for(var t=[],e=[],i=0;i<this.units.length;i++){var n=this.units[i];if(n&&n.skeleton){var r=n.skeleton;o.invert(Tn,n._localTransform);for(var s=function(i){var n=r.joints[i];if(t.findIndex((function(t){return t===n}))>=0)return"continue";t.push(n),e.push(o.multiply(new o,r.bindposes[i]||o.IDENTITY,Tn))},a=0;a<r.joints.length;a++)s(a)}}var l=Array.from(Array(t.length).keys()).sort((function(e,i){return t[e]>t[i]?1:t[e]<t[i]?-1:0})),u=new Bt;u.joints=t.map((function(t,e,i){return i[l[e]]})),u.bindposes=e.map((function(t,e,i){return i[l[e]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=u}else console.warn("no skinning root specified!")},s.cookMeshes=function(){for(var t=this,e=!1,s=0;s<this.units.length;s++)if(this.units[s].mesh){e=!0;break}if(e&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new It;for(var a=0,l=E.UNKNOWN,u=0,c=E.UNKNOWN,p=0,f=E.UNKNOWN,d=0,_=E.UNKNOWN,m=0,g=E.UNKNOWN,y=new Array(this.units.length),v=this.units.length,b=0;b<v;b++){var k=this.units[b];k&&k.skeleton&&(y[b]=k.skeleton.joints.map((function(e){return t._skeleton.joints.findIndex((function(t){return e===t}))})))}for(var w=function(e){var s=t.units[e];if(!s||!s.mesh||!s.mesh.data)return"continue";var v=t._createUnitMesh(e,s.mesh),b=new DataView(v.data.buffer);o.inverseTranspose(Tn,s._localTransform);for(var k=s.offset,w=s.size,D=function(t){var o=v.struct.vertexBundles[t];a=o.view.offset,l=E.UNKNOWN;for(var D=0;D<o.attributes.length;D++){var S=o.attributes[D];if(S.name===tt.ATTR_POSITION){l=S.format;break}a+=j[S.format].size}if(l){for(var A=i(b,l,a,o.view.length,o.view.stride),T=0;T<A.length;T+=3)h.fromArray(xn,A,T),h.transformMat4(xn,xn,s._localTransform),h.toArray(A,xn,T);n(b,A,l,a,o.view.stride)}u=o.view.offset,c=E.UNKNOWN;for(var x=0;x<o.attributes.length;x++){var M=o.attributes[x];if(M.name===tt.ATTR_NORMAL){c=M.format;break}u+=j[M.format].size}if(c){for(var I=i(b,c,u,o.view.length,o.view.stride),R=0;R<I.length;R+=3)h.fromArray(xn,I,R),h.transformMat4Normal(xn,xn,Tn),h.toArray(I,xn,R);n(b,I,c,u,o.view.stride)}p=o.view.offset,f=E.UNKNOWN;for(var O=0;O<o.attributes.length;O++){var B=o.attributes[O];if(B.name===tt.ATTR_TANGENT){f=B.format;break}p+=j[B.format].size}if(f){for(var N=i(b,f,p,o.view.length,o.view.stride),L=0;L<N.length;L+=3)h.fromArray(xn,N,L),h.transformMat4Normal(xn,xn,Tn),h.toArray(N,xn,L);n(b,N,f,p,o.view.stride)}d=o.view.offset,_=E.UNKNOWN;for(var C=0;C<o.attributes.length;C++){var P=o.attributes[C];if(P.name===tt.ATTR_BATCH_UV){_=P.format;break}d+=j[P.format].size}_&&r(b,(function(t,e){var i,n=0===e?"x":"y";return(t=(i=t)-Math.floor(i))*w[n]+k[n]}),_,d,o.view.length,o.view.stride,b);var z=y[e];if(!z)return"continue";m=o.view.offset,g=E.UNKNOWN;for(var H=0;H<o.attributes.length;H++){var F=o.attributes[H];if(F.name===tt.ATTR_JOINTS){g=F.format;break}m+=j[F.format].size}g&&r(b,(function(t){return z[t]}),g,m,o.view.length,o.view.stride,b)},S=0;S<v.struct.vertexBundles.length;S++)D(S);t._mesh.merge(v)},D=0;D<v;D++)w(D);this._onMeshChanged(this._mesh),this._updateModels()}},s.cookTextures=function(t,e,i){for(var n=[],r=[],o=[],s=[],l=0;l<this.units.length;l++){var u=this.units[l];if(u.material){var h=u.material.getProperty(e,i);if(h&&h.image&&h.image.data){var c=new ut;c.texOffset.x=u.offset.x*this.atlasSize,c.texOffset.y=u.offset.y*this.atlasSize,c.texExtent.width=u.size.x*this.atlasSize,c.texExtent.height=u.size.y*this.atlasSize;var p=h.image.data;ArrayBuffer.isView(p)?(o.push(p),s.push(c)):(n.push(p),r.push(c))}}}var f=t.getGFXTexture(),d=a.director.root.device;o.length>0&&d.copyBuffersToTexture(o,f,s),n.length>0&&d.copyTexImagesToTexture(n,f,r)},s.createTexture=function(t){var e=new nt;return e.setFilters(rt.LINEAR,rt.LINEAR),e.setMipFilter(rt.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:ot.RGBA8888}),this._textures[t]=e,e},s.resizeAtlases=function(){for(var t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:ot.RGBA8888})},s._createUnitMesh=function(t,e){for(var n=JSON.parse(JSON.stringify(e.struct)),r={},o=0;o<e.struct.primitives.length;o++){for(var s=e.struct.primitives[o],l=0,u=E.UNKNOWN,h=0;h<s.vertexBundelIndices.length;h++){var c=e.struct.vertexBundles[s.vertexBundelIndices[h]];l=c.view.offset,u=E.UNKNOWN;for(var p=0;p<c.attributes.length;p++){var f=c.attributes[p];if(f.name===tt.ATTR_TEX_COORD){u=f.format;break}l+=j[f.format].size}if(u)break}if(void 0===r[h]){r[h]=[u,l];var d=n.vertexBundles[h];d.attributes.push(wn),d.attributes.push(Dn),d.view.offset=0,d.view.length+=d.view.count*Sn,d.view.stride+=Sn}}for(var _=0,m=0;m<n.vertexBundles.length;m++)_+=n.vertexBundles[m].view.length;for(var g=0;g<n.primitives.length;g++){var y=n.primitives[g];y.indexView&&(y.indexView.offset=_,_+=y.indexView.length)}var v=new Uint8Array(_),b=e.data,k=new DataView(v.buffer),w=new DataView(b.buffer),D=a.sys.isLittleEndian;for(var S in r)for(var A=n.vertexBundles[S],T=e.struct.vertexBundles[S],x=r[S],M=x[0],I=x[1],R=i(w,M,I,T.view.length,T.view.stride),O=T.view,B=A.view,N=O.stride,L=B.stride,C=O.offset,P=B.offset,z=0;z<B.count;z++){var H=b.subarray(C,C+N);v.set(H,P),k.setFloat32(P+N,t),k.setFloat32(P+N+4,R[2*z],D),k.setFloat32(P+N+8,R[2*z+1],D),P+=L,C+=N}for(var F=0;F<n.primitives.length;F++){var U=e.struct.primitives[F],V=n.primitives[F];if(U.indexView&&V.indexView)for(var K=U.indexView.stride,W=V.indexView.stride,G=U.indexView.offset,J=V.indexView.offset,q=0;q<V.indexView.count;q++){var X=b.subarray(G,G+K);v.set(X,J),J+=W,G+=K}}var Y=new It;return Y.reset({struct:n,data:v}),Y},p(e,[{key:"mesh",get:function(){return t.prototype.mesh},set:function(t){this.mesh=t}},{key:"skeleton",get:function(){return t.prototype.skeleton},set:function(t){this.skeleton=t}}]),e}(kn),ln=f((an=cn).prototype,"atlasSize",[v,Qi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),un=f(an.prototype,"batchableTextureNames",[$i,v,tn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hn=f(an.prototype,"units",[en,v,nn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),f(an.prototype,"mesh",[st,rn],Object.getOwnPropertyDescriptor(an.prototype,"mesh"),an.prototype),f(an.prototype,"skeleton",[st,on],Object.getOwnPropertyDescriptor(an.prototype,"skeleton"),an.prototype),sn=an))||sn)||sn)||sn)||sn)||sn));a.SkinningModelComponent=kn,l.setClassAlias(kn,"cc.SkinningModelComponent"),a.SkinningModelUnit=An,l.setClassAlias(An,"cc.SkinningModelUnit"),a.BatchedSkinningModelComponent=Mn,l.setClassAlias(Mn,"cc.BatchedSkinningModelComponent");var In,Rn,On,Bn,Nn,Ln,Cn,Pn,jn,zn,En,Hn,Fn,Un,Vn,Kn,Wn,Gn,Jn,qn,Xn=new o,Yn=new o,Zn=t("e",function(t){function e(e,i){var n;return void 0===i&&(i=""),(n=t.call(this,e,i)||this)._frames=1,n._bakedDuration=0,n._animInfo=null,n._sockets=[],n._animInfoMgr=void 0,n._comps=[],n._parent=null,n._curvesInited=!1,n._animInfoMgr=a.director.root.dataPoolManager.jointAnimationInfo,n}m(e,t);var i=e.prototype;return i.initialize=function(e){if(!this._curveLoaded){this._comps.length=0;for(var i=e.getComponentsInChildren(kn),n=0;n<i.length;++n){var r=i[n];r.skinningRoot===e&&this._comps.push(r)}this._parent=e.getComponent("cc.SkeletalAnimation");var o=this._parent.useBakedAnimation;this._doNotCreateEval=o,t.prototype.initialize.call(this,e),this._curvesInited=!o;var s=kt.getOrExtract(this.clip),a=s.frames,l=s.samples;this._frames=a-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/l}},i.onPlay=function(){if(t.prototype.onPlay.call(this),this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this.clip);for(var e=0;e<this._comps.length;++e)this._comps[e].uploadAnimation(this.clip)}else this._sampleCurves=t.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,t.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0)},i.rebuildSocketCurves=function(t){if(this._sockets.length=0,this._targetNode)for(var e=this._targetNode,i=0;i<t.length;++i){var n=t[i],r=e.getChildByPath(n.path);if(n.target){for(var s=kt.getOrExtract(this.clip),a=n.path,l=s.joints[a],u=r,c=void 0;!l;){var p=a.lastIndexOf("/");if(a=a.substring(0,p),l=s.joints[a],u&&(c||(c=o.identity(Yn)),o.fromRTS(Xn,u.rotation,u.position,u.scale),o.multiply(c,Xn,c),u=u.parent),p<0)break}for(var f=l&&l.transforms,d=s.frames,_=[],m=0;m<d;m++){var g;g=f&&c?o.multiply(Xn,f[m],c):f?f[m]:c||new o;var y={pos:new h,rot:new B,scale:new h};o.toRTS(g,y.rot,y.pos,y.scale),_.push(y)}this._sockets.push({target:n.target,frames:_})}}},i._setAnimInfoDirty=function(t,e){t.dirty=e},i._sampleCurvesBaked=function(t){var e=t/this.duration,i=this._animInfo,n=e*this._frames+.5|0;if(n!==i.data[0]){i.data[0]=n,this._setAnimInfoDirty(i,!0);for(var r=0;r<this._sockets.length;++r){var o=this._sockets[r],s=o.target,a=o.frames[n],l=a.pos,u=a.rot,h=a.scale;s.setRTS(u,l,h)}}},e}(At)),Qn=t("f",(In=c("cc.SkeletalAnimation.Socket"),Rn=_(Z),In((Nn=f((Bn=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),y(this,"path",Nn,this),y(this,"target",Ln,this),this.path=t,this.target=e}).prototype,"path",[v,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ln=f(Bn.prototype,"target",[Rn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),On=Bn))||On));l.setClassAlias(Qn,"cc.SkeletalAnimationComponent.Socket");var $n=new o,tr=new o;function er(t,e,i){void 0===e&&(e=""),void 0===i&&(i=[]);for(var n=0;n<t.children.length;n++){var r=t.children[n];if(r){var o=e?e+"/"+r.name:r.name;i.push(o),er(r,o,i)}}return i}var ir=t("g",(Cn=c("cc.SkeletalAnimation"),Pn=x(),jn=Q(99),zn=M(),En=_([Qn]),Hn=b(),Fn=b(),Un=_([Qn]),Cn(Vn=Pn(Vn=jn(Vn=T(Vn=zn((qn=Jn=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return e=t.call.apply(t,[this].concat(n))||this,y(e,"_useBakedAnimation",Wn,w(e)),y(e,"_sockets",Gn,w(e)),e}m(e,t);var i=e.prototype;return i.onDestroy=function(){t.prototype.onDestroy.call(this),a.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),a.director.getAnimationManager().removeSockets(this.node,this._sockets)},i.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,t.prototype.start.call(this)},i.querySockets=function(){var t=this._defaultClip&&Object.keys(kt.getOrExtract(this._defaultClip).joints).sort().reduce((function(t,e){return e.startsWith(t[t.length-1])||t.push(e),t}),[])||[];if(!t.length)return["please specify a valid default animation clip first"];for(var e=[],i=0;i<t.length;i++){var n=t[i],r=this.node.getChildByPath(n);r&&(e.push(n),er(r,n,e))}return e},i.rebuildSocketAnimations=function(){for(var t,e=K(this._sockets);!(t=e()).done;){var i=t.value,n=this.node.getChildByPath(i.path),r=i.target;n&&r&&(r.name=i.path.substring(i.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,bt(n,this.node,$n),o.fromRTS(tr,r.rotation,r.position,r.scale),o.equals(tr,$n)||(r.matrix=$n))}for(var s=0,a=Object.keys(this._nameToState);s<a.length;s++){var l=a[s];this._nameToState[l].rebuildSocketCurves(this._sockets)}},i.createSocket=function(t){var e=this._sockets.find((function(e){return e.path===t}));if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var i=new Z;return i.parent=this.node,this._sockets.push(new Qn(t,i)),this.rebuildSocketAnimations(),i},i._createState=function(t,e){return new Zn(t,e)},i._doCreateState=function(e,i){var n=t.prototype._doCreateState.call(this,e,i);return n.rebuildSocketCurves(this._sockets),n},p(e,[{key:"sockets",get:function(){return this._sockets},set:function(t){if(!this._useBakedAnimation){var e=a.director.getAnimationManager();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(t){this._useBakedAnimation=t;for(var e=this.node.getComponentsInChildren(kn),i=0;i<e.length;++i){var n=e[i];n.skinningRoot===this.node&&n.setUseBakedAnimation(this._useBakedAnimation,!0)}this._useBakedAnimation?a.director.getAnimationManager().removeSockets(this.node,this._sockets):a.director.getAnimationManager().addSockets(this.node,this._sockets)}}]),e}(Tt),Jn.Socket=Qn,f((Kn=qn).prototype,"sockets",[En,Hn],Object.getOwnPropertyDescriptor(Kn.prototype,"sockets"),Kn.prototype),f(Kn.prototype,"useBakedAnimation",[Fn],Object.getOwnPropertyDescriptor(Kn.prototype,"useBakedAnimation"),Kn.prototype),Wn=f(Kn.prototype,"_useBakedAnimation",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Gn=f(Kn.prototype,"_sockets",[Un],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vn=Kn))||Vn)||Vn)||Vn)||Vn)||Vn));a.SkeletalAnimationComponent=ir,l.setClassAlias(ir,"cc.SkeletalAnimationComponent"),a.utils=te}}}));
