System.register(["./json-asset-7bb011fd.js","./spot-light-44c8b89f.js","./deprecated-229f0693.js"],(function(e){"use strict";var t,r,s,a,n,i,u,_,l,c,f,o,R,S,A,E,h,T,d,g,C,p,B,m,P,b,x,G,O,M,I,F,D,L,v,y,N,U,w,H,k,X,V,K,W,z,Y,q,Z,j,Q,$,J,ee,te,re,se,ae,ne,ie,ue,_e,le,ce,fe,oe,Re,Se;return{setters:[function(e){t=e.ew,r=e.b9,s=e.ba,a=e.ej,n=e.D,i=e.ai,u=e.b5,_=e.aw,l=e.G,c=e.z,f=e.H,o=e.f,R=e.b8,S=e.be,A=e.K,E=e.du,h=e.e,T=e.aE,d=e.T,g=e.x,C=e.$,p=e.Y,B=e.a7,m=e.a8,P=e.J,b=e.L,x=e.Z,G=e.C,O=e.gr,M=e.B,I=e.a9,F=e.ad,D=e.u,L=e.bk,v=e.bl,y=e.bb,N=e.bm,U=e.bn,w=e.bt,H=e.bu,k=e.bv,X=e.bw,V=e.bx,K=e.ap,W=e.bo,z=e.bp,Y=e.br,q=e.bd,Z=e.bf,j=e.az,Q=e.I,$=e.by,J=e.d,ee=e.w,te=e.dB,re=e.eN,se=e.ao,ae=e.bj,ne=e.A,ie=e.b0,ue=e.ab,_e=e.a$,le=e.t,ce=e.F,fe=e.bz,oe=e.bA,Re=e.bi,Se=e.l},function(){},function(){}],execute:function(){var Ae,Ee=function(e){function n(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSet=null,t}t(n,e);var i=n.prototype;return i.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorIndices,a=t.descriptorCount;this._buffers=Array(a).fill(null),this._textures=Array(a).fill(null),this._samplers=Array(a).fill(null);var n=[];this._gpuDescriptorSet={gpuDescriptors:n,descriptorIndices:s};for(var i=0;i<r.length;++i)for(var u=r[i],_=0;_<u.count;_++)n.push({type:u.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},i.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},i.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&r?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&s&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},a(n,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),n}(n);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(Ae||(Ae={}));var he=function(){function e(){}return e.setInstance=function(t){e._instance=t},a(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();he._instance=null;var Te=[10497,33648,33071,33071],de=new Float32Array(4);function ge(e,t){switch(e){case g.R8:return t.UNSIGNED_BYTE;case g.R8SN:return t.BYTE;case g.R8UI:return t.UNSIGNED_BYTE;case g.R8I:return t.BYTE;case g.R16F:return t.HALF_FLOAT;case g.R16UI:return t.UNSIGNED_SHORT;case g.R16I:return t.SHORT;case g.R32F:return t.FLOAT;case g.R32UI:return t.UNSIGNED_INT;case g.R32I:return t.INT;case g.RG8:return t.UNSIGNED_BYTE;case g.RG8SN:return t.BYTE;case g.RG8UI:return t.UNSIGNED_BYTE;case g.RG8I:return t.BYTE;case g.RG16F:return t.HALF_FLOAT;case g.RG16UI:return t.UNSIGNED_SHORT;case g.RG16I:return t.SHORT;case g.RG32F:return t.FLOAT;case g.RG32UI:return t.UNSIGNED_INT;case g.RG32I:return t.INT;case g.RGB8:case g.SRGB8:return t.UNSIGNED_BYTE;case g.RGB8SN:return t.BYTE;case g.RGB8UI:return t.UNSIGNED_BYTE;case g.RGB8I:return t.BYTE;case g.RGB16F:return t.HALF_FLOAT;case g.RGB16UI:return t.UNSIGNED_SHORT;case g.RGB16I:return t.SHORT;case g.RGB32F:return t.FLOAT;case g.RGB32UI:return t.UNSIGNED_INT;case g.RGB32I:return t.INT;case g.BGRA8:case g.RGBA8:case g.SRGB8_A8:return t.UNSIGNED_BYTE;case g.RGBA8SN:return t.BYTE;case g.RGBA8UI:return t.UNSIGNED_BYTE;case g.RGBA8I:return t.BYTE;case g.RGBA16F:return t.HALF_FLOAT;case g.RGBA16UI:return t.UNSIGNED_SHORT;case g.RGBA16I:return t.SHORT;case g.RGBA32F:return t.FLOAT;case g.RGBA32UI:return t.UNSIGNED_INT;case g.RGBA32I:return t.INT;case g.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case g.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case g.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case g.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case g.RGB10A2:case g.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case g.RGB9E5:case g.DEPTH:return t.FLOAT;case g.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case g.BC1:case g.BC1_SRGB:case g.BC2:case g.BC2_SRGB:case g.BC3:case g.BC3_SRGB:case g.BC4:return t.UNSIGNED_BYTE;case g.BC4_SNORM:return t.BYTE;case g.BC5:return t.UNSIGNED_BYTE;case g.BC5_SNORM:return t.BYTE;case g.BC6H_SF16:case g.BC6H_UF16:return t.FLOAT;case g.BC7:case g.BC7_SRGB:case g.ETC_RGB8:case g.ETC2_RGB8:case g.ETC2_SRGB8:case g.ETC2_RGB8_A1:case g.ETC2_SRGB8_A1:case g.EAC_R11:return t.UNSIGNED_BYTE;case g.EAC_R11SN:return t.BYTE;case g.EAC_RG11:return t.UNSIGNED_BYTE;case g.EAC_RG11SN:return t.BYTE;case g.PVRTC_RGB2:case g.PVRTC_RGBA2:case g.PVRTC_RGB4:case g.PVRTC_RGBA4:case g.PVRTC2_2BPP:case g.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case g.ASTC_RGBA_4X4:case g.ASTC_RGBA_5X4:case g.ASTC_RGBA_5X5:case g.ASTC_RGBA_6X5:case g.ASTC_RGBA_6X6:case g.ASTC_RGBA_8X5:case g.ASTC_RGBA_8X6:case g.ASTC_RGBA_8X8:case g.ASTC_RGBA_10X5:case g.ASTC_RGBA_10X6:case g.ASTC_RGBA_10X8:case g.ASTC_RGBA_10X10:case g.ASTC_RGBA_12X10:case g.ASTC_RGBA_12X12:case g.ASTC_SRGBA_4X4:case g.ASTC_SRGBA_5X4:case g.ASTC_SRGBA_5X5:case g.ASTC_SRGBA_6X5:case g.ASTC_SRGBA_6X6:case g.ASTC_SRGBA_8X5:case g.ASTC_SRGBA_8X6:case g.ASTC_SRGBA_8X8:case g.ASTC_SRGBA_10X5:case g.ASTC_SRGBA_10X6:case g.ASTC_SRGBA_10X8:case g.ASTC_SRGBA_10X10:case g.ASTC_SRGBA_12X10:case g.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function Ce(e,t){switch(e){case d.BOOL:return t.BOOL;case d.BOOL2:return t.BOOL_VEC2;case d.BOOL3:return t.BOOL_VEC3;case d.BOOL4:return t.BOOL_VEC4;case d.INT:return t.INT;case d.INT2:return t.INT_VEC2;case d.INT3:return t.INT_VEC3;case d.INT4:return t.INT_VEC4;case d.UINT:return t.UNSIGNED_INT;case d.FLOAT:return t.FLOAT;case d.FLOAT2:return t.FLOAT_VEC2;case d.FLOAT3:return t.FLOAT_VEC3;case d.FLOAT4:return t.FLOAT_VEC4;case d.MAT2:return t.FLOAT_MAT2;case d.MAT2X3:return t.FLOAT_MAT2x3;case d.MAT2X4:return t.FLOAT_MAT2x4;case d.MAT3X2:return t.FLOAT_MAT3x2;case d.MAT3:return t.FLOAT_MAT3;case d.MAT3X4:return t.FLOAT_MAT3x4;case d.MAT4X2:return t.FLOAT_MAT4x2;case d.MAT4X3:return t.FLOAT_MAT4x3;case d.MAT4:return t.FLOAT_MAT4;case d.SAMPLER2D:return t.SAMPLER_2D;case d.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case d.SAMPLER3D:return t.SAMPLER_3D;case d.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),d.UNKNOWN}}function pe(e,t){switch(e){case t.BOOL:return d.BOOL;case t.BOOL_VEC2:return d.BOOL2;case t.BOOL_VEC3:return d.BOOL3;case t.BOOL_VEC4:return d.BOOL4;case t.INT:return d.INT;case t.INT_VEC2:return d.INT2;case t.INT_VEC3:return d.INT3;case t.INT_VEC4:return d.INT4;case t.UNSIGNED_INT:return d.UINT;case t.UNSIGNED_INT_VEC2:return d.UINT2;case t.UNSIGNED_INT_VEC3:return d.UINT3;case t.UNSIGNED_INT_VEC4:return d.UINT4;case t.FLOAT:return d.FLOAT;case t.FLOAT_VEC2:return d.FLOAT2;case t.FLOAT_VEC3:return d.FLOAT3;case t.FLOAT_VEC4:return d.FLOAT4;case t.FLOAT_MAT2:return d.MAT2;case t.FLOAT_MAT2x3:return d.MAT2X3;case t.FLOAT_MAT2x4:return d.MAT2X4;case t.FLOAT_MAT3x2:return d.MAT3X2;case t.FLOAT_MAT3:return d.MAT3;case t.FLOAT_MAT3x4:return d.MAT3X4;case t.FLOAT_MAT4x2:return d.MAT4X2;case t.FLOAT_MAT4x3:return d.MAT4X3;case t.FLOAT_MAT4:return d.MAT4;case t.SAMPLER_2D:return d.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return d.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return d.SAMPLER3D;case t.SAMPLER_CUBE:return d.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),d.UNKNOWN}}function Be(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function me(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var Pe,be=[512,513,514,515,516,517,518,519],xe=[0,7680,7681,7682,7683,5386,34055,34056],Ge=[32774,32778,32779,32775,32776],Oe=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(Pe||(Pe={}));var Me=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},Ie=function(e){function r(){var t;return(t=e.call(this,Pe.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new i,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return t(r,e),r.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},r}(Me),Fe=function(e){function r(){var t;return(t=e.call(this,Pe.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new u,t}return t(r,e),r.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},r}(Me),De=function(e){function r(){var t;return(t=e.call(this,Pe.DRAW)||this).drawInfo=new _,t}return t(r,e),r.prototype.clear=function(){},r}(Me),Le=function(e){function r(){var t;return(t=e.call(this,Pe.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return t(r,e),r.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},r}(Me),ve=function(e){function r(){var t;return(t=e.call(this,Pe.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return t(r,e),r.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},r}(Me),ye=function(){function e(){this.cmds=new G(1),this.beginRenderPassCmds=new G(1),this.bindStatesCmds=new G(1),this.drawCmds=new G(1),this.updateBufferCmds=new G(1),this.copyBufferToTextureCmds=new G(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function Ne(e,t,r,s,a){if(t.usage&c.INDIRECT){t.indirects.clearDraws();for(var n=r.drawInfos,i=0;i<n.length;++i)t.indirects.setDrawInfo(s+i,n[i])}else{var u=r,_=e.gl,l=e.stateCache;switch(t.glTarget){case _.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(_.bindVertexArray(null),l.glVAO=null),He.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(_.bindBuffer(_.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),a===u.byteLength?_.bufferSubData(t.glTarget,s,u):_.bufferSubData(t.glTarget,s,u.slice(0,a));break;case _.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(_.bindVertexArray(null),l.glVAO=null),He.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),a===u.byteLength?_.bufferSubData(t.glTarget,s,u):_.bufferSubData(t.glTarget,s,u.slice(0,a));break;case _.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(_.bindBuffer(_.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),a===u.byteLength?_.bufferSubData(t.glTarget,s,u):_.bufferSubData(t.glTarget,s,new Float32Array(u,0,a/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function Ue(e,t){var r=e.gl;t.glInternalFmt=function(e,t){switch(e){case g.A8:return t.ALPHA;case g.L8:return t.LUMINANCE;case g.LA8:return t.LUMINANCE_ALPHA;case g.R8:return t.R8;case g.R8SN:return t.R8_SNORM;case g.R8UI:return t.R8UI;case g.R8I:return t.R8I;case g.RG8:return t.RG8;case g.RG8SN:return t.RG8_SNORM;case g.RG8UI:return t.RG8UI;case g.RG8I:return t.RG8I;case g.RGB8:return t.RGB8;case g.RGB8SN:return t.RGB8_SNORM;case g.RGB8UI:return t.RGB8UI;case g.RGB8I:return t.RGB8I;case g.BGRA8:case g.RGBA8:return t.RGBA8;case g.RGBA8SN:return t.RGBA8_SNORM;case g.RGBA8UI:return t.RGBA8UI;case g.RGBA8I:return t.RGBA8I;case g.R16I:return t.R16I;case g.R16UI:return t.R16UI;case g.R16F:return t.R16F;case g.RG16I:return t.RG16I;case g.RG16UI:return t.RG16UI;case g.RG16F:return t.RG16F;case g.RGB16I:return t.RGB16I;case g.RGB16UI:return t.RGB16UI;case g.RGB16F:return t.RGB16F;case g.RGBA16I:return t.RGBA16I;case g.RGBA16UI:return t.RGBA16UI;case g.RGBA16F:return t.RGBA16F;case g.R32I:return t.R32I;case g.R32UI:return t.R32UI;case g.R32F:return t.R32F;case g.RG32I:return t.RG32I;case g.RG32UI:return t.RG32UI;case g.RG32F:return t.RG32F;case g.RGB32I:return t.RGB32I;case g.RGB32UI:return t.RGB32UI;case g.RGB32F:return t.RGB32F;case g.RGBA32I:return t.RGBA32I;case g.RGBA32UI:return t.RGBA32UI;case g.RGBA32F:return t.RGBA32F;case g.R5G6B5:return t.RGB565;case g.RGB5A1:return t.RGB5_A1;case g.RGBA4:return t.RGBA4;case g.SRGB8:return t.SRGB8;case g.SRGB8_A8:return t.SRGB8_ALPHA8;case g.RGB10A2:return t.RGB10_A2;case g.RGB10A2UI:return t.RGB10_A2UI;case g.R11G11B10F:return t.R11F_G11F_B10F;case g.DEPTH:return t.DEPTH_COMPONENT32F;case g.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case g.BC1:return Ae.COMPRESSED_RGB_S3TC_DXT1_EXT;case g.BC1_ALPHA:return Ae.COMPRESSED_RGBA_S3TC_DXT1_EXT;case g.BC1_SRGB:return Ae.COMPRESSED_SRGB_S3TC_DXT1_EXT;case g.BC1_SRGB_ALPHA:return Ae.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case g.BC2:return Ae.COMPRESSED_RGBA_S3TC_DXT3_EXT;case g.BC2_SRGB:return Ae.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case g.BC3:return Ae.COMPRESSED_RGBA_S3TC_DXT5_EXT;case g.BC3_SRGB:return Ae.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case g.ETC_RGB8:return Ae.COMPRESSED_RGB_ETC1_WEBGL;case g.ETC2_RGB8:return Ae.COMPRESSED_RGB8_ETC2;case g.ETC2_SRGB8:return Ae.COMPRESSED_SRGB8_ETC2;case g.ETC2_RGB8_A1:return Ae.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case g.ETC2_SRGB8_A1:return Ae.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case g.ETC2_RGBA8:return Ae.COMPRESSED_RGBA8_ETC2_EAC;case g.ETC2_SRGB8_A8:return Ae.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case g.EAC_R11:return Ae.COMPRESSED_R11_EAC;case g.EAC_R11SN:return Ae.COMPRESSED_SIGNED_R11_EAC;case g.EAC_RG11:return Ae.COMPRESSED_RG11_EAC;case g.EAC_RG11SN:return Ae.COMPRESSED_SIGNED_RG11_EAC;case g.PVRTC_RGB2:return Ae.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case g.PVRTC_RGBA2:return Ae.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case g.PVRTC_RGB4:return Ae.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case g.PVRTC_RGBA4:return Ae.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case g.ASTC_RGBA_4X4:return Ae.COMPRESSED_RGBA_ASTC_4x4_KHR;case g.ASTC_RGBA_5X4:return Ae.COMPRESSED_RGBA_ASTC_5x4_KHR;case g.ASTC_RGBA_5X5:return Ae.COMPRESSED_RGBA_ASTC_5x5_KHR;case g.ASTC_RGBA_6X5:return Ae.COMPRESSED_RGBA_ASTC_6x5_KHR;case g.ASTC_RGBA_6X6:return Ae.COMPRESSED_RGBA_ASTC_6x6_KHR;case g.ASTC_RGBA_8X5:return Ae.COMPRESSED_RGBA_ASTC_8x5_KHR;case g.ASTC_RGBA_8X6:return Ae.COMPRESSED_RGBA_ASTC_8x6_KHR;case g.ASTC_RGBA_8X8:return Ae.COMPRESSED_RGBA_ASTC_8x8_KHR;case g.ASTC_RGBA_10X5:return Ae.COMPRESSED_RGBA_ASTC_10x5_KHR;case g.ASTC_RGBA_10X6:return Ae.COMPRESSED_RGBA_ASTC_10x6_KHR;case g.ASTC_RGBA_10X8:return Ae.COMPRESSED_RGBA_ASTC_10x8_KHR;case g.ASTC_RGBA_10X10:return Ae.COMPRESSED_RGBA_ASTC_10x10_KHR;case g.ASTC_RGBA_12X10:return Ae.COMPRESSED_RGBA_ASTC_12x10_KHR;case g.ASTC_RGBA_12X12:return Ae.COMPRESSED_RGBA_ASTC_12x12_KHR;case g.ASTC_SRGBA_4X4:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case g.ASTC_SRGBA_5X4:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case g.ASTC_SRGBA_5X5:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case g.ASTC_SRGBA_6X5:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case g.ASTC_SRGBA_6X6:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case g.ASTC_SRGBA_8X5:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case g.ASTC_SRGBA_8X6:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case g.ASTC_SRGBA_8X8:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case g.ASTC_SRGBA_10X5:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case g.ASTC_SRGBA_10X6:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case g.ASTC_SRGBA_10X8:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case g.ASTC_SRGBA_10X10:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case g.ASTC_SRGBA_12X10:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case g.ASTC_SRGBA_12X12:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,r),t.glFormat=function(e,t){switch(e){case g.A8:return t.ALPHA;case g.L8:return t.LUMINANCE;case g.LA8:return t.LUMINANCE_ALPHA;case g.R8:case g.R8SN:return t.RED;case g.R8UI:case g.R8I:return t.RED;case g.RG8:case g.RG8SN:case g.RG8UI:case g.RG8I:return t.RG;case g.RGB8:case g.RGB8SN:case g.RGB8UI:case g.RGB8I:return t.RGB;case g.BGRA8:case g.RGBA8:case g.RGBA8SN:case g.RGBA8UI:case g.RGBA8I:return t.RGBA;case g.R16UI:case g.R16I:case g.R16F:return t.RED;case g.RG16UI:case g.RG16I:case g.RG16F:return t.RG;case g.RGB16UI:case g.RGB16I:case g.RGB16F:return t.RGB;case g.RGBA16UI:case g.RGBA16I:case g.RGBA16F:return t.RGBA;case g.R32UI:case g.R32I:case g.R32F:return t.RED;case g.RG32UI:case g.RG32I:case g.RG32F:return t.RG;case g.RGB32UI:case g.RGB32I:case g.RGB32F:return t.RGB;case g.RGBA32UI:case g.RGBA32I:case g.RGBA32F:case g.RGB10A2:return t.RGBA;case g.R11G11B10F:case g.R5G6B5:return t.RGB;case g.RGB5A1:case g.RGBA4:return t.RGBA;case g.SRGB8:return t.RGB;case g.SRGB8_A8:return t.RGBA;case g.DEPTH:return t.DEPTH_COMPONENT;case g.DEPTH_STENCIL:return t.DEPTH_STENCIL;case g.BC1:return Ae.COMPRESSED_RGB_S3TC_DXT1_EXT;case g.BC1_ALPHA:return Ae.COMPRESSED_RGBA_S3TC_DXT1_EXT;case g.BC1_SRGB:return Ae.COMPRESSED_SRGB_S3TC_DXT1_EXT;case g.BC1_SRGB_ALPHA:return Ae.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case g.BC2:return Ae.COMPRESSED_RGBA_S3TC_DXT3_EXT;case g.BC2_SRGB:return Ae.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case g.BC3:return Ae.COMPRESSED_RGBA_S3TC_DXT5_EXT;case g.BC3_SRGB:return Ae.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case g.ETC_RGB8:return Ae.COMPRESSED_RGB_ETC1_WEBGL;case g.ETC2_RGB8:return Ae.COMPRESSED_RGB8_ETC2;case g.ETC2_SRGB8:return Ae.COMPRESSED_SRGB8_ETC2;case g.ETC2_RGB8_A1:return Ae.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case g.ETC2_SRGB8_A1:return Ae.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case g.ETC2_RGBA8:return Ae.COMPRESSED_RGBA8_ETC2_EAC;case g.ETC2_SRGB8_A8:return Ae.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case g.EAC_R11:return Ae.COMPRESSED_R11_EAC;case g.EAC_R11SN:return Ae.COMPRESSED_SIGNED_R11_EAC;case g.EAC_RG11:return Ae.COMPRESSED_RG11_EAC;case g.EAC_RG11SN:return Ae.COMPRESSED_SIGNED_RG11_EAC;case g.PVRTC_RGB2:return Ae.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case g.PVRTC_RGBA2:return Ae.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case g.PVRTC_RGB4:return Ae.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case g.PVRTC_RGBA4:return Ae.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case g.ASTC_RGBA_4X4:return Ae.COMPRESSED_RGBA_ASTC_4x4_KHR;case g.ASTC_RGBA_5X4:return Ae.COMPRESSED_RGBA_ASTC_5x4_KHR;case g.ASTC_RGBA_5X5:return Ae.COMPRESSED_RGBA_ASTC_5x5_KHR;case g.ASTC_RGBA_6X5:return Ae.COMPRESSED_RGBA_ASTC_6x5_KHR;case g.ASTC_RGBA_6X6:return Ae.COMPRESSED_RGBA_ASTC_6x6_KHR;case g.ASTC_RGBA_8X5:return Ae.COMPRESSED_RGBA_ASTC_8x5_KHR;case g.ASTC_RGBA_8X6:return Ae.COMPRESSED_RGBA_ASTC_8x6_KHR;case g.ASTC_RGBA_8X8:return Ae.COMPRESSED_RGBA_ASTC_8x8_KHR;case g.ASTC_RGBA_10X5:return Ae.COMPRESSED_RGBA_ASTC_10x5_KHR;case g.ASTC_RGBA_10X6:return Ae.COMPRESSED_RGBA_ASTC_10x6_KHR;case g.ASTC_RGBA_10X8:return Ae.COMPRESSED_RGBA_ASTC_10x8_KHR;case g.ASTC_RGBA_10X10:return Ae.COMPRESSED_RGBA_ASTC_10x10_KHR;case g.ASTC_RGBA_12X10:return Ae.COMPRESSED_RGBA_ASTC_12x10_KHR;case g.ASTC_RGBA_12X12:return Ae.COMPRESSED_RGBA_ASTC_12x12_KHR;case g.ASTC_SRGBA_4X4:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case g.ASTC_SRGBA_5X4:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case g.ASTC_SRGBA_5X5:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case g.ASTC_SRGBA_6X5:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case g.ASTC_SRGBA_6X6:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case g.ASTC_SRGBA_8X5:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case g.ASTC_SRGBA_8X6:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case g.ASTC_SRGBA_8X8:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case g.ASTC_SRGBA_10X5:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case g.ASTC_SRGBA_10X6:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case g.ASTC_SRGBA_10X8:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case g.ASTC_SRGBA_10X10:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case g.ASTC_SRGBA_12X10:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case g.ASTC_SRGBA_12X12:return Ae.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,r),t.glType=ge(t.format,r);var s=t.width,a=t.height;switch(t.type){case f.TEX2D:if(t.glTarget=r.TEXTURE_2D,t.isSwapchainTexture)break;var n=Math.max(s,a);if(n>e.capabilities.maxTextureSize&&o(9100,n,e.capabilities.maxTextureSize),t.samples===A.ONE){if(t.glTexture=r.createTexture(),t.size>0){var i=e.stateCache.glTexUnits[e.stateCache.texUnit];if(i.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),i.glTexture=t.glTexture),R[t.format].isCompressed)for(var u=0;u<t.mipLevel;++u){var _=S(t.format,s,a,1),l=new Uint8Array(_);r.compressedTexImage2D(r.TEXTURE_2D,u,t.glInternalFmt,s,a,0,l),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}else r.texStorage2D(r.TEXTURE_2D,t.mipLevel,t.glInternalFmt,s,a)}}else t.glRenderbuffer=r.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case f.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var c=Math.max(s,a);if(c>e.capabilities.maxCubeMapTextureSize&&o(9100,c,e.capabilities.maxTextureSize),t.glTexture=r.createTexture(),t.size>0){var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),E.glTexture=t.glTexture),R[t.format].isCompressed)for(var h=0;h<t.mipLevel;++h){for(var T=S(t.format,s,a,1),d=new Uint8Array(T),C=0;C<6;++C)r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+C,h,t.glInternalFmt,s,a,0,d);s=Math.max(1,s>>1),a=Math.max(1,a>>1)}else r.texStorage2D(r.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,s,a)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=f.TEX2D,t.glTarget=r.TEXTURE_2D}}function we(e,t){t.glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null)}var He={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function ke(e,t,r,s,a,n,i){var u=e.gl,_=e.stateCache,l=0;if(r&&t){_.glFramebuffer!==r.glFramebuffer&&(u.bindFramebuffer(u.FRAMEBUFFER,r.glFramebuffer),_.glFramebuffer=r.glFramebuffer),_.viewport.left===s.x&&_.viewport.top===s.y&&_.viewport.width===s.width&&_.viewport.height===s.height||(u.viewport(s.x,s.y,s.width,s.height),_.viewport.left=s.x,_.viewport.top=s.y,_.viewport.width=s.width,_.viewport.height=s.height),_.scissorRect.x===s.x&&_.scissorRect.y===s.y&&_.scissorRect.width===s.width&&_.scissorRect.height===s.height||(u.scissor(s.x,s.y,s.width,s.height),_.scissorRect.x=s.x,_.scissorRect.y=s.y,_.scissorRect.width=s.width,_.scissorRect.height=s.height),He.invalidateAttachments.length=0;for(var c=0;c<a.length;++c){var f=t.colorAttachments[c];if(f.format!==g.UNKNOWN)switch(f.loadOp){case C.LOAD:break;case C.CLEAR:if(_.bs.targets[0].blendColorMask!==p.ALL&&u.colorMask(!0,!0,!0,!0),r.isOffscreen)de[0]=a[c].x,de[1]=a[c].y,de[2]=a[c].z,de[3]=a[c].w,u.clearBufferfv(u.COLOR,c,de);else{var o=a[0];u.clearColor(o.x,o.y,o.z,o.w),l|=u.COLOR_BUFFER_BIT}break;case C.DISCARD:He.invalidateAttachments.push(u.COLOR_ATTACHMENT0+c)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==g.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case C.LOAD:break;case C.CLEAR:_.dss.depthWrite||u.depthMask(!0),u.clearDepth(n),l|=u.DEPTH_BUFFER_BIT;break;case C.DISCARD:He.invalidateAttachments.push(u.DEPTH_ATTACHMENT)}if(R[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case C.LOAD:break;case C.CLEAR:_.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,65535),_.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,65535),u.clearStencil(i),l|=u.STENCIL_BUFFER_BIT;break;case C.DISCARD:He.invalidateAttachments.push(u.STENCIL_ATTACHMENT)}}if(r.glFramebuffer&&He.invalidateAttachments.length&&u.invalidateFramebuffer(u.FRAMEBUFFER,He.invalidateAttachments),l&&u.clear(l),l&u.COLOR_BUFFER_BIT){var S=_.bs.targets[0].blendColorMask;if(S!==p.ALL){var A=(S&p.R)!==p.NONE,E=(S&p.G)!==p.NONE,h=(S&p.B)!==p.NONE,T=(S&p.A)!==p.NONE;u.colorMask(A,E,h,T)}}l&u.DEPTH_BUFFER_BIT&&!_.dss.depthWrite&&u.depthMask(!1),l&u.STENCIL_BUFFER_BIT&&(_.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,0),_.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,0))}}function Xe(e,t,r,s,a,n){var i=e.gl,u=e.stateCache,_=t&&t.gpuShader,l=!1;if(t&&He.gpuPipelineState!==t){if(He.gpuPipelineState=t,He.glPrimitive=t.glPrimitive,_){var c=_.glProgram;u.glProgram!==c&&(i.useProgram(c),u.glProgram=c,l=!0)}var f=t.rs;if(f){if(u.rs.cullMode!==f.cullMode){switch(f.cullMode){case B.NONE:i.disable(i.CULL_FACE);break;case B.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case B.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}e.stateCache.rs.cullMode=f.cullMode}var o=f.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==o&&(i.frontFace(o?i.CCW:i.CW),e.stateCache.rs.isFrontFaceCCW=o),e.stateCache.rs.depthBias===f.depthBias&&e.stateCache.rs.depthBiasSlop===f.depthBiasSlop||(i.polygonOffset(f.depthBias,f.depthBiasSlop),e.stateCache.rs.depthBias=f.depthBias,e.stateCache.rs.depthBiasSlop=f.depthBiasSlop),e.stateCache.rs.lineWidth!==f.lineWidth&&(i.lineWidth(f.lineWidth),e.stateCache.rs.lineWidth=f.lineWidth)}var R=t.dss;R&&(u.dss.depthTest!==R.depthTest&&(R.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),u.dss.depthTest=R.depthTest),u.dss.depthWrite!==R.depthWrite&&(i.depthMask(R.depthWrite),u.dss.depthWrite=R.depthWrite),u.dss.depthFunc!==R.depthFunc&&(i.depthFunc(be[R.depthFunc]),u.dss.depthFunc=R.depthFunc),u.dss.stencilTestFront===R.stencilTestFront&&u.dss.stencilTestBack===R.stencilTestBack||(R.stencilTestFront||R.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),u.dss.stencilTestFront=R.stencilTestFront,u.dss.stencilTestBack=R.stencilTestBack),u.dss.stencilFuncFront===R.stencilFuncFront&&u.dss.stencilRefFront===R.stencilRefFront&&u.dss.stencilReadMaskFront===R.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,be[R.stencilFuncFront],R.stencilRefFront,R.stencilReadMaskFront),u.dss.stencilFuncFront=R.stencilFuncFront,u.dss.stencilRefFront=R.stencilRefFront,u.dss.stencilReadMaskFront=R.stencilReadMaskFront),u.dss.stencilFailOpFront===R.stencilFailOpFront&&u.dss.stencilZFailOpFront===R.stencilZFailOpFront&&u.dss.stencilPassOpFront===R.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,xe[R.stencilFailOpFront],xe[R.stencilZFailOpFront],xe[R.stencilPassOpFront]),u.dss.stencilFailOpFront=R.stencilFailOpFront,u.dss.stencilZFailOpFront=R.stencilZFailOpFront,u.dss.stencilPassOpFront=R.stencilPassOpFront),u.dss.stencilWriteMaskFront!==R.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,R.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=R.stencilWriteMaskFront),u.dss.stencilFuncBack===R.stencilFuncBack&&u.dss.stencilRefBack===R.stencilRefBack&&u.dss.stencilReadMaskBack===R.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,be[R.stencilFuncBack],R.stencilRefBack,R.stencilReadMaskBack),u.dss.stencilFuncBack=R.stencilFuncBack,u.dss.stencilRefBack=R.stencilRefBack,u.dss.stencilReadMaskBack=R.stencilReadMaskBack),u.dss.stencilFailOpBack===R.stencilFailOpBack&&u.dss.stencilZFailOpBack===R.stencilZFailOpBack&&u.dss.stencilPassOpBack===R.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,xe[R.stencilFailOpBack],xe[R.stencilZFailOpBack],xe[R.stencilPassOpBack]),u.dss.stencilFailOpBack=R.stencilFailOpBack,u.dss.stencilZFailOpBack=R.stencilZFailOpBack,u.dss.stencilPassOpBack=R.stencilPassOpBack),u.dss.stencilWriteMaskBack!==R.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,R.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=R.stencilWriteMaskBack));var S=t.bs;if(S){u.bs.isA2C!==S.isA2C&&(S.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=S.isA2C),u.bs.blendColor.x===S.blendColor.x&&u.bs.blendColor.y===S.blendColor.y&&u.bs.blendColor.z===S.blendColor.z&&u.bs.blendColor.w===S.blendColor.w||(i.blendColor(S.blendColor.x,S.blendColor.y,S.blendColor.z,S.blendColor.w),u.bs.blendColor.x=S.blendColor.x,u.bs.blendColor.y=S.blendColor.y,u.bs.blendColor.z=S.blendColor.z,u.bs.blendColor.w=S.blendColor.w);var A=S.targets[0],E=u.bs.targets[0];E.blend!==A.blend&&(A.blend?i.enable(i.BLEND):i.disable(i.BLEND),E.blend=A.blend),E.blendEq===A.blendEq&&E.blendAlphaEq===A.blendAlphaEq||(i.blendEquationSeparate(Ge[A.blendEq],Ge[A.blendAlphaEq]),E.blendEq=A.blendEq,E.blendAlphaEq=A.blendAlphaEq),E.blendSrc===A.blendSrc&&E.blendDst===A.blendDst&&E.blendSrcAlpha===A.blendSrcAlpha&&E.blendDstAlpha===A.blendDstAlpha||(i.blendFuncSeparate(Oe[A.blendSrc],Oe[A.blendDst],Oe[A.blendSrcAlpha],Oe[A.blendDstAlpha]),E.blendSrc=A.blendSrc,E.blendDst=A.blendDst,E.blendSrcAlpha=A.blendSrcAlpha,E.blendDstAlpha=A.blendDstAlpha),E.blendColorMask!==A.blendColorMask&&(i.colorMask((A.blendColorMask&p.R)!==p.NONE,(A.blendColorMask&p.G)!==p.NONE,(A.blendColorMask&p.B)!==p.NONE,(A.blendColorMask&p.A)!==p.NONE),E.blendColorMask=A.blendColorMask)}}if(t&&t.gpuPipelineLayout&&_){for(var T=_.glBlocks.length,d=t.gpuPipelineLayout.dynamicOffsetIndices,g=0;g<T;g++){var C=_.glBlocks[g],P=s[C.set],b=P&&P.descriptorIndices[C.binding],x=b>=0&&P.gpuDescriptors[b];if(x&&x.gpuBuffer){var G=d[C.set],O=G&&G[C.binding],M=x.gpuBuffer.glOffset;O>=0&&(M+=a[O]),u.glBindUBOs[C.glBinding]===x.gpuBuffer.glBuffer&&u.glBindUBOOffsets[C.glBinding]===M||(M?i.bindBufferRange(i.UNIFORM_BUFFER,C.glBinding,x.gpuBuffer.glBuffer,M,x.gpuBuffer.size):i.bindBufferBase(i.UNIFORM_BUFFER,C.glBinding,x.gpuBuffer.glBuffer),u.glUniformBuffer=u.glBindUBOs[C.glBinding]=x.gpuBuffer.glBuffer,u.glBindUBOOffsets[C.glBinding]=M)}else h("Buffer binding '"+C.name+"' at set "+C.set+" binding "+C.binding+" is not bounded")}for(var I=_.glSamplerTextures.length,F=0;F<I;F++)for(var D=_.glSamplerTextures[F],L=s[D.set],v=L&&L.descriptorIndices[D.binding],y=v>=0&&L.gpuDescriptors[v],N=0;N<D.units.length;N++){var U=D.units[N],w=u.glTexUnits[U];if(y&&y.gpuTexture&&y.gpuSampler){if(y.gpuTexture&&y.gpuTexture.size>0){var H=y.gpuTexture;w.glTexture!==H.glTexture&&(u.texUnit!==U&&(i.activeTexture(i.TEXTURE0+U),u.texUnit=U),H.glTexture?i.bindTexture(H.glTarget,H.glTexture):i.bindTexture(H.glTarget,e.nullTex2D.gpuTexture.glTexture),w.glTexture=H.glTexture);var k=y.gpuSampler;u.glSamplerUnits[U]!==k.glSampler&&(i.bindSampler(U,k.glSampler),u.glSamplerUnits[U]=k.glSampler)}y=L.gpuDescriptors[++v]}else h("Sampler binding '"+D.name+"' at set "+D.set+" binding "+D.binding+" index "+N+" is not bounded")}}if(r&&_&&(l||He.gpuInputAssembler!==r))if(He.gpuInputAssembler=r,e.extensions.useVAO){var X=r.glVAOs.get(_.glProgram);if(!X){var V;X=i.createVertexArray(),r.glVAOs.set(_.glProgram,X),i.bindVertexArray(X),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var K=0;K<_.glInputs.length;K++){var W=_.glInputs[K];V=null;for(var z=0;z<r.glAttribs.length;z++){var Y=r.glAttribs[z];if(Y.name===W.name){V=Y;break}}if(V){u.glArrayBuffer!==V.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,V.glBuffer),u.glArrayBuffer=V.glBuffer);for(var q=0;q<V.componentCount;++q){var Z=W.glLoc+q,j=V.offset+V.size*q;i.enableVertexAttribArray(Z),u.glCurrentAttribLocs[Z]=!0,i.vertexAttribPointer(Z,V.count,V.glType,V.isNormalized,V.stride,j),i.vertexAttribDivisor(Z,V.isInstanced?1:0)}}}var Q=r.gpuIndexBuffer;Q&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,Q.glBuffer),i.bindVertexArray(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==X&&(i.bindVertexArray(X),u.glVAO=X)}else{for(var $=0;$<e.capabilities.maxVertexAttributes;++$)u.glCurrentAttribLocs[$]=!1;for(var J=0;J<_.glInputs.length;J++){for(var ee=_.glInputs[J],te=null,re=0;re<r.glAttribs.length;re++){var se=r.glAttribs[re];if(se.name===ee.name){te=se;break}}if(te){u.glArrayBuffer!==te.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,te.glBuffer),u.glArrayBuffer=te.glBuffer);for(var ae=0;ae<te.componentCount;++ae){var ne=ee.glLoc+ae,ie=te.offset+te.size*ae;!u.glEnabledAttribLocs[ne]&&ne>=0&&(i.enableVertexAttribArray(ne),u.glEnabledAttribLocs[ne]=!0),u.glCurrentAttribLocs[ne]=!0,i.vertexAttribPointer(ne,te.count,te.glType,te.isNormalized,te.stride,ie),i.vertexAttribDivisor(ne,te.isInstanced?1:0)}}}var ue=r.gpuIndexBuffer;ue&&u.glElementArrayBuffer!==ue.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,ue.glBuffer),u.glElementArrayBuffer=ue.glBuffer);for(var _e=0;_e<e.capabilities.maxVertexAttributes;++_e)u.glEnabledAttribLocs[_e]!==u.glCurrentAttribLocs[_e]&&(i.disableVertexAttribArray(_e),u.glEnabledAttribLocs[_e]=!1)}if(t&&t.dynamicStates.length)for(var le=t.dynamicStates.length,ce=0;ce<le;ce++)switch(t.dynamicStates[ce]){case m.LINE_WIDTH:u.rs.lineWidth!==n.lineWidth&&(i.lineWidth(n.lineWidth),u.rs.lineWidth=n.lineWidth);break;case m.DEPTH_BIAS:u.rs.depthBias===n.depthBiasConstant&&u.rs.depthBiasSlop===n.depthBiasSlope||(i.polygonOffset(n.depthBiasConstant,n.depthBiasSlope),u.rs.depthBias=n.depthBiasConstant,u.rs.depthBiasSlop=n.depthBiasSlope);break;case m.BLEND_CONSTANTS:var fe=n.blendConstant;u.bs.blendColor.x===fe.x&&u.bs.blendColor.y===fe.y&&u.bs.blendColor.z===fe.z&&u.bs.blendColor.w===fe.w||(i.blendColor(fe.x,fe.y,fe.z,fe.w),u.bs.blendColor.copy(fe));break;case m.STENCIL_WRITE_MASK:var oe=n.stencilStatesFront,Re=n.stencilStatesBack;u.dss.stencilWriteMaskFront!==oe.writeMask&&(i.stencilMaskSeparate(i.FRONT,oe.writeMask),u.dss.stencilWriteMaskFront=oe.writeMask),u.dss.stencilWriteMaskBack!==Re.writeMask&&(i.stencilMaskSeparate(i.BACK,Re.writeMask),u.dss.stencilWriteMaskBack=Re.writeMask);break;case m.STENCIL_COMPARE_MASK:var Se=n.stencilStatesFront,Ae=n.stencilStatesBack;u.dss.stencilRefFront===Se.reference&&u.dss.stencilReadMaskFront===Se.compareMask||(i.stencilFuncSeparate(i.FRONT,be[u.dss.stencilFuncFront],Se.reference,Se.compareMask),u.dss.stencilRefFront=Se.reference,u.dss.stencilReadMaskFront=Se.compareMask),u.dss.stencilRefBack===Ae.reference&&u.dss.stencilReadMaskBack===Ae.compareMask||(i.stencilFuncSeparate(i.BACK,be[u.dss.stencilFuncBack],Ae.reference,Ae.compareMask),u.dss.stencilRefBack=Ae.reference,u.dss.stencilReadMaskBack=Ae.compareMask)}}function Ve(e,t){var r=e.gl,s=He.gpuInputAssembler,a=He.glPrimitive,n=e.extensions.WEBGL_multi_draw;if(s){var i=s.gpuIndexBuffer;if(s.gpuIndirectBuffer){var u=s.gpuIndirectBuffer.indirects;if(u.drawByIndex){for(var _=0;_<u.drawCount;_++)u.byteOffsets[_]=u.offsets[_]*i.stride;if(n)u.instancedDraw?n.multiDrawElementsInstancedWEBGL(a,u.counts,0,s.glIndexType,u.byteOffsets,0,u.instances,0,u.drawCount):n.multiDrawElementsWEBGL(a,u.counts,0,s.glIndexType,u.byteOffsets,0,u.drawCount);else for(var l=0;l<u.drawCount;l++)u.instances[l]?r.drawElementsInstanced(a,u.counts[l],s.glIndexType,u.byteOffsets[l],u.instances[l]):r.drawElements(a,u.counts[l],s.glIndexType,u.byteOffsets[l])}else if(n)u.instancedDraw?n.multiDrawArraysInstancedWEBGL(a,u.offsets,0,u.counts,0,u.instances,0,u.drawCount):n.multiDrawArraysWEBGL(a,u.offsets,0,u.counts,0,u.drawCount);else for(var c=0;c<u.drawCount;c++)u.instances[c]?r.drawArraysInstanced(a,u.offsets[c],u.counts[c],u.instances[c]):r.drawArrays(a,u.offsets[c],u.counts[c])}else if(t.instanceCount)if(i){if(t.indexCount>0){var f=t.firstIndex*i.stride;r.drawElementsInstanced(a,t.indexCount,s.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstanced(a,t.firstVertex,t.vertexCount,t.instanceCount);else if(i){if(t.indexCount>0){var o=t.firstIndex*i.stride;r.drawElements(a,t.indexCount,s.glIndexType,o)}}else t.vertexCount>0&&r.drawArrays(a,t.firstVertex,t.vertexCount)}}var Ke=new Array(Pe.COUNT);function We(e,t){Ke.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],a=Ke[s]++;switch(s){case Pe.BEGIN_RENDER_PASS:var n=t.beginRenderPassCmds.array[a];ke(e,n.gpuRenderPass,n.gpuFramebuffer,n.renderArea,n.clearColors,n.clearDepth,n.clearStencil);break;case Pe.BIND_STATES:var i=t.bindStatesCmds.array[a];Xe(e,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.dynamicStates);break;case Pe.DRAW:Ve(e,t.drawCmds.array[a].drawInfo);break;case Pe.UPDATE_BUFFER:var u=t.updateBufferCmds.array[a];Ne(e,u.gpuBuffer,u.buffer,u.offset,u.size);break;case Pe.COPY_BUFFER_TO_TEXTURE:var _=t.copyBufferToTextureCmds.array[a];ze(e,_.buffers,_.gpuTexture,_.regions)}}}function ze(e,t,r,s){var a=e.gl,n=e.stateCache.glTexUnits[e.stateCache.texUnit];n.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),n.glTexture=r.glTexture);var i=0,u=1,_=1,l=0,c=R[r.format].isCompressed;switch(r.glTarget){case a.TEXTURE_2D:for(var f=0;f<s.length;f++){var o=s[f];u=o.texExtent.width,_=o.texExtent.height;var S=t[i++];c?r.glInternalFmt!==Ae.COMPRESSED_RGB_ETC1_WEBGL?a.compressedTexSubImage2D(a.TEXTURE_2D,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,u,_,r.glFormat,S):a.compressedTexImage2D(a.TEXTURE_2D,o.texSubres.mipLevel,r.glInternalFmt,u,_,0,S):a.texSubImage2D(a.TEXTURE_2D,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,u,_,r.glFormat,r.glType,S)}break;case a.TEXTURE_CUBE_MAP:for(var A=0;A<s.length;A++){var E=s[A],h=E.texSubres.baseArrayLayer+E.texSubres.layerCount;for(l=E.texSubres.baseArrayLayer;l<h;++l){u=E.texExtent.width,_=E.texExtent.height;var T=t[i++];c?r.glInternalFmt!==Ae.COMPRESSED_RGB_ETC1_WEBGL?a.compressedTexSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+l,E.texSubres.mipLevel,E.texOffset.x,E.texOffset.y,u,_,r.glFormat,T):a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+l,E.texSubres.mipLevel,r.glInternalFmt,u,_,0,T):a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+l,E.texSubres.mipLevel,E.texOffset.x,E.texOffset.y,u,_,r.glFormat,r.glType,T)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&P.GEN_MIPMAP&&a.generateMipmap(r.glTarget)}var Ye=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=O(e);var t=new Int32Array(this._capacity),r=new Int32Array(this._capacity),s=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),r.set(this.offsets),s.set(this.instances),this.counts=t,this.offsets=r,this.instances=s}},e}(),qe=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuBuffer=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new Ye,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var r=e.gl,s=e.stateCache,a=t.memUsage&l.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&c.VERTEX){t.glTarget=r.ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),s.glVAO=null),He.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&c.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var i=r.createBuffer();i&&(t.glBuffer=i,t.size>0&&(e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),s.glVAO=null),He.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&c.UNIFORM){t.glTarget=r.UNIFORM_BUFFER;var u=r.createBuffer();u&&t.size>0&&(t.glBuffer=u,e.stateCache.glUniformBuffer!==t.glBuffer&&(r.bindBuffer(r.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),r.bufferData(r.UNIFORM_BUFFER,t.size,a),r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&c.INDIRECT||t.usage&c.TRANSFER_DST||t.usage&c.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=r.NONE}(he.instance,this._gpuBuffer),he.instance.memoryStatus.bufferSize+=this._size},s.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var r=e.gl,s=e.stateCache;if(t.glBuffer){switch(t.glTarget){case r.ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=null),He.gpuInputAssembler=null,r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case r.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=null),He.gpuInputAssembler=null,r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case r.UNIFORM_BUFFER:r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}r.deleteBuffer(t.glBuffer),t.glBuffer=null}}(he.instance,this._gpuBuffer),he.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},s.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t,r,s,a,n,i=this._size;i!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(t=he.instance,r=this._gpuBuffer,s=t.gl,a=t.stateCache,n=r.memUsage&l.HOST?s.DYNAMIC_DRAW:s.STATIC_DRAW,r.usage&c.VERTEX?(t.extensions.useVAO&&a.glVAO&&(s.bindVertexArray(null),a.glVAO=null),He.gpuInputAssembler=null,a.glArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ARRAY_BUFFER,r.buffer,n):s.bufferData(s.ARRAY_BUFFER,r.size,n),s.bindBuffer(s.ARRAY_BUFFER,null),a.glArrayBuffer=null):r.usage&c.INDEX?(t.extensions.useVAO&&a.glVAO&&(s.bindVertexArray(null),a.glVAO=null),He.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.buffer,n):s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.size,n),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):r.usage&c.UNIFORM?(t.stateCache.glUniformBuffer!==r.glBuffer&&s.bindBuffer(s.UNIFORM_BUFFER,r.glBuffer),s.bufferData(s.UNIFORM_BUFFER,r.size,n),s.bindBuffer(s.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(r.usage&c.INDIRECT||r.usage&c.TRANSFER_DST||r.usage&c.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),r.glTarget=s.NONE),he.instance.memoryStatus.bufferSize-=i,he.instance.memoryStatus.bufferSize+=e)))}},s.update=function(e,t){var r;this._isBufferView?console.warn("cannot update through buffer views!"):(r=void 0!==t?t:this._usage&c.INDIRECT?0:e.byteLength,Ne(he.instance,this._gpuBuffer,e,0,r))},a(r,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),r}(M),Ze=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new G(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,a=0;a<s;++a)this._frees[a]=new e;for(var n=s,i=0;n<t;++n,++i)this._frees[n]=r[i];this._freeIdx+=s}var u=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++u.refCount,u},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),je=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new Ze(Ie,1),this.bindStatesCmdPool=new Ze(Fe,1),this.drawCmdPool=new Ze(De,1),this.updateBufferCmdPool=new Ze(Le,1),this.copyBufferToTextureCmdPool=new Ze(ve,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),Qe=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).cmdPackage=new ye,t._cmdAllocator=new je,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new u,t._isStateInvalied=!1,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=he.instance.bindingMappingInfo.bufferOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null)},s.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},s.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},s.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},s.beginRenderPass=function(e,t,r,s,a,n){var i=this._cmdAllocator.beginRenderPassCmdPool.alloc(Ie);i.gpuRenderPass=e.gpuRenderPass,i.gpuFramebuffer=t.gpuFramebuffer,i.renderArea=r;for(var u=0;u<s.length;++u)i.clearColors[u]=s[u];i.clearDepth=a,i.clearStencil=n,this.cmdPackage.beginRenderPassCmds.push(i),this.cmdPackage.cmds.push(Pe.BEGIN_RENDER_PASS),this._isInRenderPass=!0},s.endRenderPass=function(){this._isInRenderPass=!1},s.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},s.bindDescriptorSet=function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){var a,n=null===(a=this._curGPUPipelineState)||void 0===a?void 0:a.gpuPipelineLayout;if(n){for(var i=this._curDynamicOffsets,u=n.dynamicOffsetOffsets[e],_=0;_<r.length;_++)i[u+_]=r[_];this._isStateInvalied=!0}}},s.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},s.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},s.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},s.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},s.setDepthBias=function(e,t,r){var s=this._curDynamicStates;s.depthBiasConstant===e&&s.depthBiasClamp===t&&s.depthBiasSlope===r||(s.depthBiasConstant=e,s.depthBiasClamp=t,s.depthBiasSlope=r,this._isStateInvalied=!0)},s.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},s.setDepthBound=function(e,t){var r=this._curDynamicStates;r.depthMinBounds===e&&r.depthMaxBounds===t||(r.depthMinBounds=e,r.depthMaxBounds=t,this._isStateInvalied=!0)},s.setStencilWriteMask=function(e,t){var r=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;e&I.FRONT&&r.writeMask!==t&&(r.writeMask=t,this._isStateInvalied=!0),e&I.BACK&&s.writeMask!==t&&(s.writeMask=t,this._isStateInvalied=!0)},s.setStencilCompareMask=function(e,t,r){var s=this._curDynamicStates.stencilStatesFront,a=this._curDynamicStates.stencilStatesBack;e&I.FRONT&&(s.compareMask===r&&s.reference===t||(s.reference=t,s.compareMask=r,this._isStateInvalied=!0)),e&I.BACK&&(a.compareMask===r&&a.reference===t||(a.reference=t,a.compareMask=r,this._isStateInvalied=!0))},s.draw=function(e){if(this._type===F.PRIMARY&&this._isInRenderPass||this._type===F.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,r=this._cmdAllocator.drawCmdPool.alloc(De);r.drawInfo.copy(t),this.cmdPackage.drawCmds.push(r),this.cmdPackage.cmds.push(Pe.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var s=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=s/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(s-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._type===F.PRIMARY&&!this._isInRenderPass||this._type===F.SECONDARY){var s=e.gpuBuffer;if(s){var a,n=this._cmdAllocator.updateBufferCmdPool.alloc(Le),i=0;e.usage&c.INDIRECT||(i=void 0!==r?r:t.byteLength),a=t,n.gpuBuffer=s,n.buffer=a,n.offset=0,n.size=i,this.cmdPackage.updateBufferCmds.push(n),this.cmdPackage.cmds.push(Pe.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},s.copyBuffersToTexture=function(e,t,r){if(this._type===F.PRIMARY&&!this._isInRenderPass||this._type===F.SECONDARY){var s=t.gpuTexture;if(s){var a=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(ve);a.gpuTexture=s,a.regions=r,a.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(Pe.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},s.execute=function(e,t){for(var r=0;r<t;++r){for(var s=e[r],a=0;a<s.cmdPackage.beginRenderPassCmds.length;++a){var n=s.cmdPackage.beginRenderPassCmds.array[a];++n.refCount,this.cmdPackage.beginRenderPassCmds.push(n)}for(var i=0;i<s.cmdPackage.bindStatesCmds.length;++i){var u=s.cmdPackage.bindStatesCmds.array[i];++u.refCount,this.cmdPackage.bindStatesCmds.push(u)}for(var _=0;_<s.cmdPackage.drawCmds.length;++_){var l=s.cmdPackage.drawCmds.array[_];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var c=0;c<s.cmdPackage.updateBufferCmds.length;++c){var f=s.cmdPackage.updateBufferCmds.array[c];++f.refCount,this.cmdPackage.updateBufferCmds.push(f)}for(var o=0;o<s.cmdPackage.copyBufferToTextureCmds.length;++o){var R=s.cmdPackage.copyBufferToTextureCmds.array[o];++R.refCount,this.cmdPackage.copyBufferToTextureCmds.push(R)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.pipelineBarrier=function(){},s.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(Fe);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(Pe.BIND_STATES),this._isStateInvalied=!1},r}(D),$e=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuFramebuffer=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],r=0;r<e.colorTextures.length;r++){var s=e.colorTextures[r];s&&t.push(s.gpuTexture)}var a=null;e.depthStencilTexture&&(a=e.depthStencilTexture.gpuTexture);var n=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:a,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?n:this.gpuColorTextures[0].width},set width(e){n=e},get height(){return this.isOffscreen?i:this.gpuColorTextures[0].height},set height(e){i=e}},function(e,t){for(var r=0;r<t.gpuColorTextures.length;++r)if(t.gpuColorTextures[r].isSwapchainTexture)return void(t.isOffscreen=!1);var s=e.gl,a=[],n=s.createFramebuffer();if(n){t.glFramebuffer=n,e.stateCache.glFramebuffer!==t.glFramebuffer&&s.bindFramebuffer(s.FRAMEBUFFER,t.glFramebuffer);for(var i=0;i<t.gpuColorTextures.length;++i){var u=t.gpuColorTextures[i];u&&(u.glTexture?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+i,u.glTarget,u.glTexture,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+i,s.RENDERBUFFER,u.glRenderbuffer),a.push(s.COLOR_ATTACHMENT0+i),t.width=Math.min(t.width,u.width),t.height=Math.min(t.height,u.height))}var _=t.gpuDepthStencilTexture;if(_){var l=R[_.format].hasStencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;_.glTexture?s.framebufferTexture2D(s.FRAMEBUFFER,l,_.glTarget,_.glTexture,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,l,s.RENDERBUFFER,_.glRenderbuffer),t.width=Math.min(t.width,_.width),t.height=Math.min(t.height,_.height)}s.drawBuffers(a);var c=s.checkFramebufferStatus(s.FRAMEBUFFER);if(c!==s.FRAMEBUFFER_COMPLETE)switch(c){case s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case s.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&s.bindFramebuffer(s.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(he.instance,this._gpuFramebuffer)},s.destroy=function(){var e,t;this._gpuFramebuffer&&(e=he.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},a(r,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),r}(L),Je=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuInputAssembler=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var a=e.vertexBuffers[s];a.gpuBuffer&&(r[s]=a.gpuBuffer)}var n=null,i=0;if(e.indexBuffer&&(n=e.indexBuffer.gpuBuffer))switch(n.stride){case 1:i=5121;break;case 2:i=5123;break;case 4:i=5125;break;default:console.error("Illegal index buffer stride.")}var u=null;e.indirectBuffer&&(u=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:n,gpuIndirectBuffer:u,glAttribs:[],glIndexType:i,glVAOs:new Map},function(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],a=0;a<t.attributes.length;++a){var n=t.attributes[a],i=void 0!==n.stream?n.stream:0,u=t.gpuVertexBuffers[i],_=ge(n.format,r),l=R[n.format].size;t.glAttribs[a]={name:n.name,glBuffer:u.glBuffer,glType:_,size:l,count:R[n.format].count,stride:u.stride,componentCount:me(_,r),isNormalized:void 0!==n.isNormalized&&n.isNormalized,isInstanced:void 0!==n.isInstanced&&n.isInstanced,offset:s[i]},s[i]+=l}}(he.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},s.destroy=function(){var e=he.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var r=t.glVAOs.values(),s=r.next();!s.done;)e.gl.deleteVertexArray(s.value),s=r.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},a(r,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),r}(v),et=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSetLayout=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=-1,s=[],a=0;a<this._bindings.length;a++){var n=this._bindings[a];s.push(t),t+=n.count,n.binding>r&&(r=n.binding)}this._bindingIndices=Array(r+1).fill(-1);for(var i=this._descriptorIndices=Array(r+1).fill(-1),u=0;u<this._bindings.length;u++){var _=this._bindings[u];this._bindingIndices[_.binding]=u,i[_.binding]=s[u]}for(var l=[],c=0;c<this._bindings.length;c++){var f=this._bindings[c];if(f.descriptorType&y)for(var o=0;o<f.count;o++)l.push(f.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:i,descriptorCount:t}},s.destroy=function(){this._bindings.length=0},a(r,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),r}(N),tt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineLayout=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=0,a=[],n=0;n<this._setLayouts.length;n++){for(var i=this._setLayouts[n],u=i.gpuDescriptorSetLayout.dynamicBindings,_=Array(i.bindingIndices.length).fill(-1),l=0;l<u.length;l++){var c=u[l];_[c]<0&&(_[c]=s+l)}r.push(i.gpuDescriptorSetLayout),t.push(_),a.push(s),s+=u.length}this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetIndices:t,dynamicOffsetCount:s,dynamicOffsetOffsets:a}},s.destroy=function(){this._setLayouts.length=0},a(r,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),r}(U),rt=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],st=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineState=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var r=e.blendState,s=r.targets;s&&s.forEach((function(e,r){t.setTarget(r,e)})),void 0!==r.isA2C&&(t.isA2C=r.isA2C),void 0!==r.isIndepend&&(t.isIndepend=r.isIndepend),void 0!==r.blendColor&&(t.blendColor=r.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var a=[],n=0;n<31;n++)this._dynamicStates&1<<n&&a.push(1<<n);this._gpuPipelineState={glPrimitive:rt[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:a}},s.destroy=function(){this._gpuPipelineState=null},a(r,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),r}(w),at=function(e){function r(){return e.apply(this,arguments)||this}t(r,e);var s=r.prototype;return s.beginRenderPass=function(e,t,r,s,a,n){ke(he.instance,e.gpuRenderPass,t.gpuFramebuffer,r,s,a,n),this._isInRenderPass=!0},s.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;Ve(he.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var r=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.setViewport=function(e){var t=he.instance,r=t.stateCache,s=t.gl;r.viewport.left===e.left&&r.viewport.top===e.top&&r.viewport.width===e.width&&r.viewport.height===e.height||(s.viewport(e.left,e.top,e.width,e.height),r.viewport.left=e.left,r.viewport.top=e.top,r.viewport.width=e.width,r.viewport.height=e.height)},s.setScissor=function(e){var t=he.instance,r=t.stateCache,s=t.gl;r.scissorRect.x===e.x&&r.scissorRect.y===e.y&&r.scissorRect.width===e.width&&r.scissorRect.height===e.height||(s.scissor(e.x,e.y,e.width,e.height),r.scissorRect.x=e.x,r.scissorRect.y=e.y,r.scissorRect.width=e.width,r.scissorRect.height=e.height)},s.updateBuffer=function(e,t,r){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var s,a=e.gpuBuffer;a&&(s=void 0!==r?r:e.usage&c.INDIRECT?0:t.byteLength,Ne(he.instance,a,t,0,s))}},s.copyBuffersToTexture=function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&ze(he.instance,e,s,r)}},s.execute=function(e,t){for(var r=0;r<t;++r){var s=e[r];We(he.instance,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.bindStates=function(){Xe(he.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},r}(Qe),nt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type},s.destroy=function(){},s.submit=function(e){for(var t=0;t<e.length;t++){var r=e[t];this.numDrawCalls+=r.numDrawCalls,this.numInstances+=r.numInstances,this.numTris+=r.numTris}},s.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},r}(H),it=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuRenderPass=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},s.destroy=function(){this._gpuRenderPass=null},a(r,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),r}(k),ut=function(e){function r(t,r){var s,a,n,i,u;return(s=e.call(this,t,r)||this)._gpuSampler=null,s._gpuSampler={glSampler:null,minFilter:s._info.minFilter,magFilter:s._info.magFilter,mipFilter:s._info.mipFilter,addressU:s._info.addressU,addressV:s._info.addressV,addressW:s._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},a=he.instance,n=s._gpuSampler,(u=(i=a.gl).createSampler())&&(n.minFilter===b.LINEAR||n.minFilter===b.ANISOTROPIC?n.mipFilter===b.LINEAR||n.mipFilter===b.ANISOTROPIC?n.glMinFilter=i.LINEAR_MIPMAP_LINEAR:n.mipFilter===b.POINT?n.glMinFilter=i.LINEAR_MIPMAP_NEAREST:n.glMinFilter=i.LINEAR:n.mipFilter===b.LINEAR||n.mipFilter===b.ANISOTROPIC?n.glMinFilter=i.NEAREST_MIPMAP_LINEAR:n.mipFilter===b.POINT?n.glMinFilter=i.NEAREST_MIPMAP_NEAREST:n.glMinFilter=i.NEAREST,n.magFilter===b.LINEAR||n.magFilter===b.ANISOTROPIC?n.glMagFilter=i.LINEAR:n.glMagFilter=i.NEAREST,n.glWrapS=Te[n.addressU],n.glWrapT=Te[n.addressV],n.glWrapR=Te[n.addressW],n.glSampler=u,i.samplerParameteri(u,i.TEXTURE_MIN_FILTER,n.glMinFilter),i.samplerParameteri(u,i.TEXTURE_MAG_FILTER,n.glMagFilter),i.samplerParameteri(u,i.TEXTURE_WRAP_S,n.glWrapS),i.samplerParameteri(u,i.TEXTURE_WRAP_T,n.glWrapT),i.samplerParameteri(u,i.TEXTURE_WRAP_R,n.glWrapR),i.samplerParameterf(u,i.TEXTURE_MIN_LOD,0),i.samplerParameterf(u,i.TEXTURE_MAX_LOD,1e3)),s}return t(r,e),r.prototype.destroy=function(){var e,t;this._gpuSampler&&(e=he.instance,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null)},a(r,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),r}(X),_t=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuShader=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}!function(e,t){for(var r=e.gl,s=function(e){var s=t.gpuStages[e],a=0,n="",i=1;switch(s.type){case x.VERTEX:n="VertexShader",a=r.VERTEX_SHADER;break;case x.FRAGMENT:n="FragmentShader",a=r.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var u=r.createShader(a);if(u&&(s.glShader=u,r.shaderSource(s.glShader,"#version 300 es\n"+s.source),r.compileShader(s.glShader),!r.getShaderParameter(s.glShader,r.COMPILE_STATUS))){console.error(n+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",s.source.replace(/^|\n/g,(function(){return"\n"+i+++" "}))),console.error(r.getShaderInfoLog(s.glShader));for(var _=0;_<t.gpuStages.length;_++){var l=t.gpuStages[e];l.glShader&&(r.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},a=0;a<t.gpuStages.length;a++){var n=s(a);if("object"==typeof n)return n.v}var i=r.createProgram();if(i){t.glProgram=i;for(var u=0;u<t.gpuStages.length;u++){var _=t.gpuStages[u];r.attachShader(t.glProgram,_.glShader)}r.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var c=t.gpuStages[l];c.glShader&&(r.detachShader(t.glProgram,c.glShader),r.deleteShader(c.glShader),c.glShader=null)}if(!r.getProgramParameter(t.glProgram,r.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(r.getProgramInfoLog(t.glProgram));E("Shader '"+t.name+"' compilation succeeded.");var f=r.getProgramParameter(t.glProgram,r.ACTIVE_ATTRIBUTES);t.glInputs=new Array(f);for(var o=0;o<f;++o){var R=r.getActiveAttrib(t.glProgram,o);if(R){var S,A=R.name.indexOf("[");S=-1!==A?R.name.substr(0,A):R.name;var g=r.getAttribLocation(t.glProgram,S),C=pe(R.type,r),p=Be(R.type,r);t.glInputs[o]={name:S,type:C,stride:p,count:R.size,size:p*R.size,glType:R.type,glLoc:g}}}var B,m,P,b,G=r.getProgramParameter(t.glProgram,r.ACTIVE_UNIFORM_BLOCKS);if(G){t.glBlocks=new Array(G);for(var O=0;O<G;++O){var M=(B=r.getActiveUniformBlockName(t.glProgram,O)).indexOf("[");-1!==M&&(B=B.substr(0,M)),b=null;for(var I=0;I<t.blocks.length;I++)if(t.blocks[I].name===B){b=t.blocks[I];break}if(b){m=O,P=r.getActiveUniformBlockParameter(t.glProgram,m,r.UNIFORM_BLOCK_DATA_SIZE);var F=b.binding+(e.bindingMappingInfo.bufferOffsets[b.set]||0);r.uniformBlockBinding(t.glProgram,m,F),t.glBlocks[O]={set:b.set,binding:b.binding,idx:m,name:B,size:P,glBinding:F}}else h("Block '"+B+"' does not bound")}}for(var D=0;D<t.subpassInputs.length;++D){var L=t.subpassInputs[D];t.samplerTextures.push(new T(L.set,L.binding,L.name,d.SAMPLER2D,L.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var v=0;v<t.samplerTextures.length;++v){var y=t.samplerTextures[v];t.glSamplerTextures[v]={set:y.set,binding:y.binding,name:y.name,type:y.type,count:y.count,units:[],glUnits:null,glType:Ce(y.type,r),glLoc:null}}}for(var N=[],U=[],w=e.stateCache.texUnitCacheMap,H=0,k=0;k<t.blocks.length;++k)t.blocks[k].set===e.bindingMappingInfo.flexibleSet&&H++;for(var X=0,V=0;V<t.samplerTextures.length;++V){var K=t.samplerTextures[V],W=r.getUniformLocation(t.glProgram,K.name);if(W&&-1!==W.id&&(N.push(t.glSamplerTextures[V]),U.push(W)),void 0===w[K.name]){var z=K.binding+e.bindingMappingInfo.samplerOffsets[K.set]+X;K.set===e.bindingMappingInfo.flexibleSet&&(z-=H),w[K.name]=z%e.capabilities.maxTextureUnits,X+=K.count-1}}if(N.length){for(var Y=[],q=0;q<N.length;++q){var Z=N[q],j=w[Z.name];if(void 0!==j){Z.glLoc=U[q];for(var Q=0;Q<Z.count;++Q){for(;Y[j];)j=(j+1)%e.capabilities.maxTextureUnits;Z.units.push(j),Y[j]=!0}}}for(var $=0,J=0;J<N.length;++J){var ee=N[J];if(!ee.glLoc){for(ee.glLoc=U[J];Y[$];)$++;for(var te=0;te<ee.count;++te){for(;Y[$];)$=($+1)%e.capabilities.maxTextureUnits;void 0===w[ee.name]&&(w[ee.name]=$),ee.units.push($),Y[$]=!0}}}e.stateCache.glProgram!==t.glProgram&&r.useProgram(t.glProgram);for(var re=0;re<N.length;re++){var se=N[re];se.glUnits=new Int32Array(se.units),r.uniform1iv(se.glLoc,se.glUnits)}e.stateCache.glProgram!==t.glProgram&&r.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=N}}(he.instance,this._gpuShader)},s.destroy=function(){var e,t;this._gpuShader&&(e=he.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null)},a(r,[{key:"gpuShader",get:function(){return this._gpuShader}}]),r}(V),lt=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new K,this.scissorRect=new i(0,0,0,0),this.rs=new W,this.dss=new z,this.bs=new Y,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,r){for(var s=0;s<e;++s)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=r,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=r,this.glCurrentAttribLocs.fill(!1)},e}(),ct=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuTexture=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e,t){"texture"in e?console.log("WebGL2 does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=q(this._width)&&q(this._height),this._size=Z(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},Ue(he.instance,this._gpuTexture),he.instance.memoryStatus.textureSize+=this._size)},s.destroy=function(){this._gpuTexture&&(we(he.instance,this._gpuTexture),he.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},s.resize=function(e,t){var r=this._size;this._width=e,this._height=t,this._size=Z(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var r=e.gl,s=t.width,a=t.height;switch(t.type){case f.TEX2D:t.glTarget=r.TEXTURE_2D;var n=Math.max(s,a);if(n>e.capabilities.maxTextureSize&&o(9100,n,e.capabilities.maxTextureSize),t.samples===A.ONE){var i=e.stateCache.glTexUnits[e.stateCache.texUnit];if(i.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),i.glTexture=t.glTexture),R[t.format].isCompressed)for(var u=0;u<t.mipLevel;++u){var _=S(t.format,s,a,1),l=new Uint8Array(_);r.compressedTexImage2D(r.TEXTURE_2D,u,t.glInternalFmt,s,a,0,l),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}else we(e,t),Ue(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case f.CUBE:t.type=f.CUBE,t.glTarget=r.TEXTURE_CUBE_MAP;var c=Math.max(s,a);c>e.capabilities.maxCubeMapTextureSize&&o(9100,c,e.capabilities.maxTextureSize);var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),E.glTexture=t.glTexture),R[t.format].isCompressed)for(var h=0;h<6;++h){s=t.width,a=t.height;for(var T=0;T<t.mipLevel;++T){var d=S(t.format,s,a,1),g=new Uint8Array(d);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+h,T,t.glInternalFmt,s,a,0,g),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}else we(e,t),Ue(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=f.TEX2D,t.glTarget=r.TEXTURE_2D}}}(he.instance,this._gpuTexture),he.instance.memoryStatus.textureSize-=r,he.instance.memoryStatus.textureSize+=this._size)},s.initAsSwapchainTexture=function(e){var t=new j;t.format=e.format,t.usage=R[e.format].hasDepth?Q.DEPTH_STENCIL_ATTACHMENT:Q.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},a(r,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),r}($),ft="webglcontextlost";function ot(e,t){for(var r=["","WEBKIT_","MOZ_"],s=0;s<r.length;++s){var a=e.getExtension(r[s]+t);if(a)return a}return null}function Rt(e){return{EXT_texture_filter_anisotropic:ot(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:ot(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:ot(e,"EXT_color_buffer_float"),WEBGL_multi_draw:ot(e,"WEBGL_multi_draw"),WEBGL_compressed_texture_etc1:ot(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:ot(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:ot(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:ot(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:ot(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:ot(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:ot(e,"WEBGL_debug_shaders"),WEBGL_lose_context:ot(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:ot(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:ot(e,"OES_texture_half_float_linear"),OES_texture_float_linear:ot(e,"OES_texture_float_linear"),useVAO:!0}}var St=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).stateCache=new lt,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(ft,this._onWebGLContextLost);var t=he.instance.gl;this.stateCache.initialize(he.instance.capabilities.maxTextureUnits,he.instance.capabilities.maxUniformBufferBindings,he.instance.capabilities.maxVertexAttributes),this._extensions=Rt(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var r=g.RGBA8,s=g.DEPTH_STENCIL,a=t.getParameter(t.DEPTH_BITS),n=t.getParameter(t.STENCIL_BITS);a&&n?s=g.DEPTH_STENCIL:a&&(s=g.DEPTH),this._colorTexture=new ct,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:r,width:e.width,height:e.height}),this._depthStencilTexture=new ct,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:s,width:e.width,height:e.height}),this.nullTex2D=he.instance.createTexture(new j(f.TEX2D,Q.SAMPLED,g.RGBA8,2,2,P.NONE)),this.nullTexCube=he.instance.createTexture(new j(f.CUBE,Q.SAMPLED,g.RGBA8,2,2,P.NONE,6));var i=new se;i.texExtent.width=2,i.texExtent.height=2;var u=new Uint8Array(this.nullTex2D.size);u.fill(0),he.instance.copyBuffersToTexture([u],this.nullTex2D,[i]),i.texSubres.layerCount=6,he.instance.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[i])},s.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(ft,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},s.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(E("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},s._onWebGLContextLost=function(e){J(11e3),ee(e)},a(r,[{key:"extensions",get:function(){return this._extensions}}]),r}(ae),At=e("WebGL2Device",function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._swapchain=null,t._context=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){he.setInstance(this),this._gfxAPI=ne.WEBGL2,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var r={alpha:te.ENABLE_TRANSPARENT_CANVAS,antialias:re||te.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",r)}catch(e){return null}return t}(Re.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new ie(ue.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new _e(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var r=t.getSupportedExtensions(),s="";if(r)for(var a,n=le(r);!(a=n()).done;)s+=a.value+" ";var i=Rt(t);i.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(i.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(i.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var u=t.getParameter(t.VERSION);this._features.fill(!1),this._features[ce.TEXTURE_FLOAT]=!0,this._features[ce.TEXTURE_HALF_FLOAT]=!0,this._features[ce.FORMAT_R11G11B10F]=!0,this._features[ce.FORMAT_SRGB]=!0,this._features[ce.FORMAT_RGB8]=!0,this._features[ce.ELEMENT_INDEX_UINT]=!0,this._features[ce.INSTANCED_ARRAYS]=!0,this._features[ce.MULTIPLE_RENDER_TARGETS]=!0,this._features[ce.BLEND_MINMAX]=!0,i.EXT_color_buffer_float&&(this._features[ce.COLOR_FLOAT]=!0,this._features[ce.COLOR_HALF_FLOAT]=!0),i.OES_texture_float_linear&&(this._features[ce.TEXTURE_FLOAT_LINEAR]=!0),i.OES_texture_half_float_linear&&(this._features[ce.TEXTURE_HALF_FLOAT_LINEAR]=!0);var _="";return i.WEBGL_compressed_texture_etc1&&(this._features[ce.FORMAT_ETC1]=!0,_+="etc1 "),i.WEBGL_compressed_texture_etc&&(this._features[ce.FORMAT_ETC2]=!0,_+="etc2 "),i.WEBGL_compressed_texture_s3tc&&(this._features[ce.FORMAT_DXT]=!0,_+="dxt "),i.WEBGL_compressed_texture_pvrtc&&(this._features[ce.FORMAT_PVRTC]=!0,_+="pvrtc "),i.WEBGL_compressed_texture_astc&&(this._features[ce.FORMAT_ASTC]=!0,_+="astc "),E("WebGL2 device initialized."),E("RENDERER: "+this._renderer),E("VENDOR: "+this._vendor),E("VERSION: "+u),E("COMPRESSED_FORMAT: "+_),E("EXTENSIONS: "+s),!0},s.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},s.flushCommands=function(){},s.acquire=function(){},s.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},s.createCommandBuffer=function(e){var t=new(e.type===F.PRIMARY?at:Qe);return t.initialize(e),t},s.createSwapchain=function(e){var t=new St;return this._swapchain=t,t.initialize(e),t},s.createBuffer=function(e){var t=new qe;return t.initialize(e),t},s.createTexture=function(e){var t=new ct;return t.initialize(e),t},s.createDescriptorSet=function(e){var t=new Ee;return t.initialize(e),t},s.createShader=function(e){var t=new _t;return t.initialize(e),t},s.createInputAssembler=function(e){var t=new Je;return t.initialize(e),t},s.createRenderPass=function(e){var t=new it;return t.initialize(e),t},s.createFramebuffer=function(e){var t=new $e;return t.initialize(e),t},s.createDescriptorSetLayout=function(e){var t=new et;return t.initialize(e),t},s.createPipelineLayout=function(e){var t=new tt;return t.initialize(e),t},s.createPipelineState=function(e){var t=new st;return t.initialize(e),t},s.createQueue=function(e){var t=new nt;return t.initialize(e),t},s.getSampler=function(e){var t=X.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new ut(e,t)),this._samplers.get(t)},s.getGlobalBarrier=function(e){var t=fe.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new fe(e,t)),this._globalBarriers.get(t)},s.getTextureBarrier=function(e){var t=oe.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new oe(e,t)),this._textureBarriers.get(t)},s.copyBuffersToTexture=function(e,t,r){ze(this,e,t.gpuTexture,r)},s.copyTextureToBuffers=function(e,t,r){!function(e,t,r,s){var a=e.gl,n=e.stateCache,i=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,i);var u=0,_=0,l=1,c=1;switch(t.glTarget){case a.TEXTURE_2D:for(var f=0;f<s.length;f++){var o=s[f];a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,o.texSubres.mipLevel),u=o.texOffset.x,_=o.texOffset.y,l=o.texExtent.width,c=o.texExtent.height,a.readPixels(u,_,l,c,t.glFormat,t.glType,r[f])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}a.bindFramebuffer(a.FRAMEBUFFER,null),n.glFramebuffer=null,a.deleteFramebuffer(i)}(this,e.gpuTexture,t,r)},s.copyTexImagesToTexture=function(e,t,r){!function(e,t,r,s){var a=e.gl,n=e.stateCache.glTexUnits[e.stateCache.texUnit];n.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),n.glTexture=r.glTexture);var i=0,u=0;switch(r.glTarget){case a.TEXTURE_2D:for(var _=0;_<s.length;_++){var l=s[_];a.texSubImage2D(a.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,r.glFormat,r.glType,t[i++])}break;case a.TEXTURE_CUBE_MAP:for(var c=0;c<s.length;c++){var f=s[c],o=f.texSubres.baseArrayLayer+f.texSubres.layerCount;for(u=f.texSubres.baseArrayLayer;u<o;++u)a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,r.glFormat,r.glType,t[i++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&P.GEN_MIPMAP&&a.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)},a(r,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),r}(Re));Se.WebGL2Device=At}}}));
