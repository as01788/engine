System.register(["./json-asset-7bb011fd.js","./spot-light-44c8b89f.js"],(function(e){"use strict";var t,i,r,n,a,s,o,u,l,h,d,c,_,p,f,S,g,m,O,E,A,T,w,v,b,I,R,F,y,D,N,B,P,C,L,M,x,H,U,z,G,W,Q,V,q,k,X,Y,K,J,Z,j,$,ee,te,ie,re,ne,ae,se,oe,ue,le,he,de,ce,_e,pe,fe,Se,ge,me,Oe,Ee,Ae,Te,we,ve,be,Ie,Re,Fe,ye,De,Ne,Be,Pe,Ce,Le,Me,xe,He,Ue,ze,Ge,We,Qe,Ve,qe,ke,Xe,Ye,Ke,Je,Ze,je,$e,et,tt,it,rt,nt,at,st,ot,ut,lt,ht,dt;return{setters:[function(e){t=e.c4,i=e.cb,r=e.ed,n=e.ee,a=e.ef,s=e.c2,o=e.P,u=e.eg,l=e.eh,h=e.bD,d=e.aB,c=e.L,_=e.N,p=e.aY,f=e.ei,S=e.au,g=e.z,m=e.G,O=e.ej,E=e.aX,A=e.ek,T=e.c6,w=e.el,v=e.em,b=e.en,I=e.dQ,R=e.eo,F=e.ci,y=e.l,D=e.ep,N=e.eq,B=e.er,P=e.es,C=e.et,L=e.eu,M=e.ev,x=e.ew,H=e.db,U=e.aO,z=e.aP,G=e.a0,W=e.ae,Q=e.$,V=e.a1,q=e.aS,k=e.aV,X=e.ex,Y=e.v,K=e.aL,J=e.x,Z=e.aN,j=e.F,$=e.az,ee=e.H,te=e.I,ie=e.dd,re=e.ai,ne=e.ap,ae=e.ey,se=e.cJ,oe=e.dq,ue=e.dp,le=e.d6,he=e.ez,de=e.dF,ce=e.R,_e=e.C,pe=e.dE,fe=e.eA,Se=e.eB,ge=e.av,me=e.bQ,Oe=e.cy,Ee=e.dJ,Ae=e.eC,Te=e.aq,we=e.eD,ve=e.eE,be=e.eF,Ie=e.bB,Re=e.bF,Fe=e.f,ye=e.eG,De=e.eH,Ne=e.eI,Be=e.dB,Pe=e.eJ,Ce=e.e8,Le=e.eK,Me=e.eL,xe=e.eM,He=e.dz,Ue=e.d,ze=e.a,Ge=e.c0,We=e.eN,Qe=e.dw,Ve=e.dy,qe=e.eO,ke=e.dx,Xe=e.dA,Ye=e.eP,Ke=e.bi,Je=e.at,Ze=e.eQ,je=e.e,$e=e.as,et=e.w,tt=e.ce,it=e.eR,rt=e.eS,nt=e.cg,at=e.cR,st=e.cS,ot=e.cQ},function(e){ut=e.S,lt=e.L,ht=e.j,dt=e.O}],execute:function(){e("j",void 0);var ct=new t,_t=(new t,new t,new t),pt=new i,ft=new r,St=new r,gt=!1,mt=n.create(0,0,0,1),Ot=new n,Et=new a;Et.accurate=!0;var At=new a;At.accurate=!0;var Tt=new a,wt=new i,vt=new i,bt=new i,It=new i,Rt=new i,Ft=new i,yt=new i,Dt=new t,Nt=new s,Bt=new t,Pt=new t,Ct=new t(0,0,0),Lt=new r,Mt=new o((function(){return{model:null,depth:0}}),128),xt=new o((function(){return{model:null,depth:0}}),128),Ht=new o((function(){return{model:null,depth:0}}),128);function Ut(e,i){var r=0;e.node&&(t.subtract(ct,e.node.worldPosition,i.position),r=t.dot(ct,i.forward));var n=Mt.alloc();return n.model=e,n.depth=r,n}function zt(e,i){var r=0;e.node&&(t.subtract(ct,e.node.worldPosition,i.position),r=t.dot(ct,i.forward));var n=xt.alloc();return n.model=e,n.depth=r,n}function Gt(e,i){var r=0;e.node&&(t.subtract(ct,e.node.worldPosition,i.position),r=t.dot(ct,i.forward));var n=Ht.alloc();return n.model=e,n.depth=r,n}function Wt(e,r,n){var a=r.direction,s=e.normal,o=e.distance+.001,u=1/t.dot(s,a),h=a.x*u,d=a.y*u,c=a.z*u,_=s.x,p=s.y,f=s.z,S=e.matLight;S.m00=1-_*h,S.m01=-_*d,S.m02=-_*c,S.m03=0,S.m04=-p*h,S.m05=1-p*d,S.m06=-p*c,S.m07=0,S.m08=-f*h,S.m09=-f*d,S.m10=1-f*c,S.m11=0,S.m12=h*o,S.m13=d*o,S.m14=c*o,S.m15=1,i.toArray(n,S,l.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Qt(e,t){var i=e.pipelineSceneData.validPunctualLights;i.length=0;for(var r=t.scene.spotLights,a=0;a<r.length;a++){var s=r[a];s.baked||(n.set(mt,s.position.x,s.position.y,s.position.z,s.range),u.sphereFrustum(mt,t.frustum)&&i.push(s))}for(var o=t.scene.sphereLights,l=0;l<o.length;l++){var h=o[l];h.baked||(n.set(mt,h.position.x,h.position.y,h.position.z,h.range),u.sphereFrustum(mt,t.frustum)&&i.push(h))}}function Vt(e,n){var s=n.scene,o=s.mainLight,d=e.pipelineSceneData,c=d.shadows,_=d.skybox,p=d.renderObjects;Mt.freeArray(p),p.length=0;var f=d.castShadowObjects;Ht.freeArray(f),f.length=0,gt=!1;var S=null;if(c.enabled&&(e.pipelineUBO.updateShadowUBORange(l.SHADOW_COLOR_OFFSET,c.shadowColor),c.type===h.ShadowMap))if(S=e.pipelineSceneData.dirShadowObjects,xt.freeArray(S),S.length=0,o&&o.node)!function(e,n,s,o,u){var l=n.device,h=u.invisibleOcclusionRange,d=u.size.x;!function(e,t){if(t.node){var r=t.node,n=r.getWorldPosition(),a=r.getWorldRotation();i.fromRT(e,a,n),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(pt,o),a.split(Et,o,pt,.1,u.shadowDistance),At=a.clone(Et),i.fromRT(wt,s.node.rotation,Ct),i.invert(vt,wt),i.invert(bt,vt);var c=vt.clone();At.transform(vt),r.fromPoints(ft,new t(1e7,1e7,1e7),new t(-1e7,-1e7,-1e7)),ft.mergeFrustum(At);var _=2*ft.halfExtents.z;_t.set(ft.center.x,ft.center.y,ft.center.z+ft.halfExtents.z+h),t.transformMat4(_t,_t,bt),i.fromRT(wt,s.node.rotation,_t),i.invert(vt,wt),i.invert(bt,vt);var p=t.distance(Et.vertices[0],Et.vertices[6]);Ot.center.set(0,0,0),Ot.radius=-1,Ot.mergePoints(Et.vertices);var f=.8*p+.4*Ot.radius;u.shadowCameraFar=_+h;var S=.5*f;if(i.ortho(It,-S,S,-S,S,.1,u.shadowCameraFar,l.capabilities.clipSpaceMinZ,l.capabilities.clipSpaceSignY),d>0){i.multiply(Ft,It,c),t.transformMat4(Dt,_t,Ft);var g=2/d;Nt.set(g,g);var m=Dt.x%Nt.x,O=Dt.y%Nt.y;Bt.set(Dt.x-m,Dt.y-O,Dt.z),i.invert(yt,Ft),t.transformMat4(Pt,Bt,yt),i.fromRT(wt,s.node.rotation,Pt),i.invert(vt,wt),i.invert(bt,vt),a.createOrtho(e,f,f,.1,u.shadowCameraFar,bt)}else{for(var E=0;E<8;E++)e.vertices[E].set(0,0,0);e.updatePlanes()}i.multiply(Rt,It,vt),u.matShadowView=vt,u.matShadowProj=It,u.matShadowViewProj=Rt}(Tt,e,o,n,c);else{for(var g=0;g<8;g++)Tt.vertices[g].set(0,0,0);Tt.updatePlanes()}o&&c.type===h.Planar&&function(e,i){var r=e.pipelineSceneData.shadows,n=i.direction,a=r.normal,s=r.distance+.001,o=1/t.dot(a,n),u=n.x*o,h=n.y*o,d=n.z*o,c=a.x,_=a.y,p=a.z,f=r.matLight;f.m00=1-c*u,f.m01=-c*h,f.m02=-c*d,f.m03=0,f.m04=-_*u,f.m05=1-_*h,f.m06=-_*d,f.m07=0,f.m08=-p*u,f.m09=-p*h,f.m10=1-p*d,f.m11=0,f.m12=u*s,f.m13=h*s,f.m14=d*s,f.m15=1,e.pipelineUBO.updateShadowUBORange(l.MAT_LIGHT_PLANE_PROJ_OFFSET,r.matLight)}(e,o),_.enabled&&_.model&&n.clearFlag&ut&&p.push(Ut(_.model,n));for(var m=s.models,O=n.visibility,E=0;E<m.length;E++){var A=m[E];if(A.enabled&&(A.castShadow&&f.push(Gt(A,n)),c.firstSetCSM&&A.worldBounds&&(gt||(St.copy(A.worldBounds),gt=!0),r.merge(St,St,A.worldBounds)),A.node&&(O&A.node.layer)===A.node.layer||O&A.visFlags)){if(null!=S&&A.castShadow&&A.worldBounds&&(c.fixedArea?(r.transform(Lt,A.worldBounds,c.matLight),u.aabbFrustum(Lt,n.frustum)&&S.push(zt(A,n))):u.aabbFrustum(A.worldBounds,Tt)&&S.push(zt(A,n))),A.worldBounds&&!u.aabbFrustum(A.worldBounds,n.frustum))continue;p.push(Ut(A,n))}}c.firstSetCSM&&(c.shadowDistance=2*St.halfExtents.length(),c.firstSetCSM=!1)}var qt,kt,Xt,Yt,Kt,Jt,Zt,jt,$t,ei,ti=new d(c.LINEAR,c.LINEAR,c.NONE,_.CLAMP,_.CLAMP,_.CLAMP),ii=new d(c.POINT,c.POINT,c.NONE,_.CLAMP,_.CLAMP,_.CLAMP),ri=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(ti),this._pointSampler=this._device.getSampler(ii);var t=new E(A.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new p(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindBuffer(e,t),r=i.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindSampler(e,t),r=i.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindTexture(e,t),r=i.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var i=this._globalDescriptorSet,r=t.createDescriptorSet(new p(this._descriptorSetLayout));this._descriptorSetMap.set(e,r);for(var n=f.UBO_GLOBAL;n<f.COUNT;n++)r.bindBuffer(n,i.getBuffer(n)),r.bindSampler(n,i.getSampler(n)),r.bindTexture(n,i.getTexture(n));var a=t.createBuffer(new S(g.UNIFORM|g.TRANSFER_DST,m.HOST|m.DEVICE,l.SIZE,l.SIZE));r.bindBuffer(l.BINDING,a),r.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},O(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),ni=new i,ai=new i,si=new i,oi=new T,ui=function(){function e(){this._globalUBO=new Float32Array(w.COUNT),this._cameraUBO=new Float32Array(v.COUNT),this._shadowUBO=new Float32Array(l.COUNT)}e.updateGlobalUBOView=function(e,t){var i=y.director.root,r=t,n=Math.floor(e.width),a=Math.floor(e.height);r[w.TIME_OFFSET]=i.cumulativeTime,r[w.TIME_OFFSET+1]=i.frameTime,r[w.TIME_OFFSET+2]=y.director.getTotalFrames(),r[w.SCREEN_SIZE_OFFSET]=n,r[w.SCREEN_SIZE_OFFSET+1]=a,r[w.SCREEN_SIZE_OFFSET+2]=1/n,r[w.SCREEN_SIZE_OFFSET+3]=1/a,r[w.NATIVE_SIZE_OFFSET]=n,r[w.NATIVE_SIZE_OFFSET+1]=a,r[w.NATIVE_SIZE_OFFSET+2]=1/r[w.NATIVE_SIZE_OFFSET],r[w.NATIVE_SIZE_OFFSET+3]=1/r[w.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,r,n){y.director.root;var a=(n.scene?n.scene:y.director.getScene().renderScene).mainLight,s=e.pipelineSceneData,o=s.ambient,u=s.fog,l=r,h=n.exposure,d=s.isHDR;if(l[v.SCREEN_SCALE_OFFSET]=s.shadingScale,l[v.SCREEN_SCALE_OFFSET+1]=s.shadingScale,l[v.SCREEN_SCALE_OFFSET+2]=1/l[v.SCREEN_SCALE_OFFSET],l[v.SCREEN_SCALE_OFFSET+3]=1/l[v.SCREEN_SCALE_OFFSET+1],l[v.EXPOSURE_OFFSET]=h,l[v.EXPOSURE_OFFSET+1]=1/h,l[v.EXPOSURE_OFFSET+2]=d?1:0,l[v.EXPOSURE_OFFSET+3]=0,a){if(t.toArray(l,a.direction,v.MAIN_LIT_DIR_OFFSET),t.toArray(l,a.color,v.MAIN_LIT_COLOR_OFFSET),a.useColorTemperature){var c=a.colorTemperatureRGB;l[v.MAIN_LIT_COLOR_OFFSET]*=c.x,l[v.MAIN_LIT_COLOR_OFFSET+1]*=c.y,l[v.MAIN_LIT_COLOR_OFFSET+2]*=c.z}l[v.MAIN_LIT_COLOR_OFFSET+3]=d?a.illuminance*h:a.illuminance}else t.toArray(l,t.UNIT_Z,v.MAIN_LIT_DIR_OFFSET),T.toArray(l,T.ZERO,v.MAIN_LIT_COLOR_OFFSET);var _=o.skyColor;_.w=d?o.skyIllum*h:o.skyIllum,l[v.AMBIENT_SKY_OFFSET+0]=_.x,l[v.AMBIENT_SKY_OFFSET+1]=_.y,l[v.AMBIENT_SKY_OFFSET+2]=_.z,l[v.AMBIENT_SKY_OFFSET+3]=_.w,l[v.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,l[v.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,l[v.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,l[v.AMBIENT_GROUND_OFFSET+3]=o.groundAlbedo.w,i.toArray(l,n.matView,v.MAT_VIEW_OFFSET),i.toArray(l,n.node.worldMatrix,v.MAT_VIEW_INV_OFFSET),t.toArray(l,n.position,v.CAMERA_POS_OFFSET),i.toArray(l,n.matProj,v.MAT_PROJ_OFFSET),i.toArray(l,n.matProjInv,v.MAT_PROJ_INV_OFFSET),i.toArray(l,n.matViewProj,v.MAT_VIEW_PROJ_OFFSET),i.toArray(l,n.matViewProjInv,v.MAT_VIEW_PROJ_INV_OFFSET),l[v.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var p=u.colorArray;l[v.GLOBAL_FOG_COLOR_OFFSET]=p.x,l[v.GLOBAL_FOG_COLOR_OFFSET+1]=p.y,l[v.GLOBAL_FOG_COLOR_OFFSET+2]=p.z,l[v.GLOBAL_FOG_COLOR_OFFSET+3]=p.z,l[v.GLOBAL_FOG_BASE_OFFSET]=u.fogStart,l[v.GLOBAL_FOG_BASE_OFFSET+1]=u.fogEnd,l[v.GLOBAL_FOG_BASE_OFFSET+2]=u.fogDensity,l[v.GLOBAL_FOG_ADD_OFFSET]=u.fogTop,l[v.GLOBAL_FOG_ADD_OFFSET+1]=u.fogRange,l[v.GLOBAL_FOG_ADD_OFFSET+2]=u.fogAtten,l[v.NEAR_FAR_OFFSET]=n.nearClip,l[v.NEAR_FAR_OFFSET+1]=n.farClip,l[v.VIEW_PORT_OFFSET]=n.viewport.x,l[v.VIEW_PORT_OFFSET+1]=n.viewport.y,l[v.VIEW_PORT_OFFSET+1]=n.viewport.z,l[v.VIEW_PORT_OFFSET+1]=n.viewport.w},e.updateShadowUBOView=function(e,t,r){var n=e.device,a=r.scene.mainLight,s=e.pipelineSceneData.shadows,o=t;if(s.enabled){if(a&&s.type===h.ShadowMap){var u,d,c,_=.1,p=0;if(s.fixedArea){i.invert(ni,a.node.getWorldMatrix()),u=ni;var f=s.orthoSize,S=s.orthoSize;_=s.near,p=s.far,i.ortho(ai,-f,f,-S,S,_,p,n.capabilities.clipSpaceMinZ,n.capabilities.clipSpaceSignY),d=ai,i.multiply(si,ai,ni),c=si}else _=.1,p=s.shadowCameraFar,u=s.matShadowView,d=s.matShadowProj,c=s.matShadowViewProj;i.toArray(t,u,l.MAT_LIGHT_VIEW_OFFSET),o[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,o[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,o[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,o[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,o[l.SHADOW_PROJ_INFO_OFFSET+0]=d.m00,o[l.SHADOW_PROJ_INFO_OFFSET+1]=d.m05,o[l.SHADOW_PROJ_INFO_OFFSET+2]=1/d.m00,o[l.SHADOW_PROJ_INFO_OFFSET+3]=1/d.m05,i.toArray(t,c,l.MAT_LIGHT_VIEW_PROJ_OFFSET);var g=D(n)?0:1;o[l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=_,o[l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=p,o[l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,o[l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-s.saturation,o[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,o[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,o[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=s.pcf,o[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=s.bias,o[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,o[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=g,o[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=s.normalBias,o[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else a&&s.type===h.Planar&&Wt(s,a,o);F.toArray(o,s.shadowColor,l.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,r){var n,a,s,o=e.device,u=e.pipelineSceneData.shadows,h=t,d=D(o)?0:1,c=.1,_=0;switch(r.type){case lt.DIRECTIONAL:if(u.fixedArea){i.invert(ni,r.node.getWorldMatrix()),n=ni;var p=u.orthoSize,f=u.orthoSize;c=u.near,_=u.far,i.ortho(ai,-p,p,-f,f,c,_,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),a=ai,i.multiply(si,ai,ni),s=si}else c=.1,_=u.shadowCameraFar,n=u.matShadowView,a=u.matShadowProj,s=u.matShadowViewProj;i.toArray(t,n,l.MAT_LIGHT_VIEW_OFFSET),h[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=a.m10,h[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=a.m14,h[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=a.m11,h[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=a.m15,h[l.SHADOW_PROJ_INFO_OFFSET+0]=a.m00,h[l.SHADOW_PROJ_INFO_OFFSET+1]=a.m05,h[l.SHADOW_PROJ_INFO_OFFSET+2]=1/a.m00,h[l.SHADOW_PROJ_INFO_OFFSET+3]=1/a.m05,i.toArray(t,s,l.MAT_LIGHT_VIEW_PROJ_OFFSET),oi.set(c,_,0,1-u.saturation),T.toArray(h,oi,l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),oi.set(0,d,u.normalBias,0),T.toArray(h,oi,l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case lt.SPOT:i.invert(ni,r.node.getWorldMatrix()),i.toArray(h,ni,l.MAT_LIGHT_VIEW_OFFSET),i.perspective(ai,r.angle,r.aspect,.001,r.range),i.multiply(si,ai,ni),i.toArray(h,si,l.MAT_LIGHT_VIEW_PROJ_OFFSET),oi.set(.01,r.range,0,1-u.saturation),T.toArray(h,oi,l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),oi.set(1,d,u.normalBias,0),T.toArray(h,oi,l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}oi.set(u.size.x,u.size.y,u.pcf,u.bias),T.toArray(h,oi,l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),F.toArray(h,u.shadowColor,l.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var r=e.prototype;return r._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},r.activate=function(e,t){this._device=e,this._pipeline=t;var i=this._pipeline.descriptorSet;this._initCombineSignY();var r=e.createBuffer(new S(g.UNIFORM|g.TRANSFER_DST,m.HOST|m.DEVICE,w.SIZE,w.SIZE));i.bindBuffer(w.BINDING,r);var n=e.createBuffer(new S(g.UNIFORM|g.TRANSFER_DST,m.HOST|m.DEVICE,v.SIZE,v.SIZE));i.bindBuffer(v.BINDING,n);var a=e.createBuffer(new S(g.UNIFORM|g.TRANSFER_DST,m.HOST|m.DEVICE,l.SIZE,l.SIZE));i.bindBuffer(l.BINDING,a)},r.updateGlobalUBO=function(t){var i=this._pipeline.globalDSManager,r=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;r.update(),e.updateGlobalUBOView(t,this._globalUBO),n[0].updateBuffer(r.getBuffer(w.BINDING),this._globalUBO),i.bindBuffer(w.BINDING,r.getBuffer(w.BINDING)),i.update()},r.updateCameraUBO=function(t){var i=this._pipeline.globalDSManager,r=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),n[0].updateBuffer(r.getBuffer(v.BINDING),this._cameraUBO),i.bindBuffer(v.BINDING,r.getBuffer(v.BINDING)),i.update()},r.updateShadowUBO=function(t){var i=this._pipeline.pipelineSceneData;if(i.shadows.enabled){var r=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers,a=i.shadowFrameBufferMap,s=t.scene.mainLight;s&&a.has(s)&&r.bindTexture(b,a.get(s).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),r.update(),n[0].updateBuffer(r.getBuffer(l.BINDING),this._shadowUBO)}},r.updateShadowUBOLight=function(t,i){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,i),t.bindTexture(b,I.get("default-texture").getGFXTexture()),t.bindTexture(R,I.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(l.BINDING).update(this._shadowUBO)},r.updateShadowUBORange=function(e,t){t instanceof i?i.toArray(this._shadowUBO,t,e):t instanceof F&&F.toArray(this._shadowUBO,t,e)},r.destroy=function(){},e}();ui._combineSignY=0;var li,hi,di,ci,_i,pi,fi,Si,gi,mi,Oi,Ei,Ai,Ti=e("c",(qt=N("RenderStage"),kt=L(),Xt=L(),Yt=L(),qt((ei=function(){function e(){P(this,"_name",Zt,this),P(this,"_priority",jt,this),this._enabled=!0,P(this,"_tag",$t,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},O(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),Zt=B((Jt=ei).prototype,"_name",[kt,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jt=B(Jt.prototype,"_priority",[Xt,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$t=B(Jt.prototype,"_tag",[Yt,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kt=Jt))||Kt));y.RenderStage=Ti;var wi,vi=e("b",(li=N("RenderFlow"),hi=L(),di=L(),ci=L(),_i=L(),pi=M([Ti]),li((Ai=function(){function e(){P(this,"_name",gi,this),P(this,"_priority",mi,this),P(this,"_tag",Oi,this),P(this,"_stages",Ei,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},O(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),gi=B((Si=Ai).prototype,"_name",[hi,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mi=B(Si.prototype,"_priority",[di,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oi=B(Si.prototype,"_tag",[ci,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ei=B(Si.prototype,"_stages",[_i,pi,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fi=Si))||fi));y.RenderFlow=vi,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(wi||(wi=e("j",{})));var bi,Ii,Ri,Fi,yi,Di,Ni,Bi,Pi,Ci,Li,Mi,xi,Hi,Ui,zi,Gi,Wi,Qi,Vi,qi,ki,Xi,Yi,Ki,Ji,Zi,ji,$i,er,tr,ir,rr,nr,ar,sr,or,ur,lr,hr,dr,cr,_r,pr,fr,Sr,gr,mr,Or,Er,Ar,Tr,wr,vr,br,Ir,Rr,Fr,yr,Dr,Nr,Br,Pr,Cr,Lr,Mr,xr,Hr,Ur,zr,Gr,Wr,Qr,Vr,qr,kr,Xr,Yr,Kr,Jr,Zr,jr,$r,en,tn,rn,nn,an,sn,on,un,ln,hn,dn=e("i",function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}x(t,e);var i=t.prototype;return i.on=function(e,t,i,r){return this.eventTargetOn(e,t,i,r)},i.once=function(e,t,i){return this.eventTargetOnce(e,t,i)},t}(H)),cn=new re,_n=new ne,pn=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},fn=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},Sn=e("a",(bi=N("cc.RenderPipeline"),Ii=L(),Ri=L(),Fi=M([vi]),bi((Pi=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return t=e.call.apply(e,[this].concat(r))||this,P(t,"_tag",Ni,ae(t)),P(t,"_flows",Bi,ae(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new dn,t._commandBuffers=[],t._pipelineUBO=new ui,t._macros={},t._constantMacros="",t._profiler=null,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new re,t._clusterEnabled=!1,t._bloomEnabled=!1,t}x(t,e);var i=t.prototype;return i.getPipelineRenderData=function(){return this._pipelineRenderData},i.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},i.createRenderPass=function(e,t,i){var r=this._device,n=new U,a=new z;n.format=t,a.format=i,a.stencilStoreOp=G.DISCARD,a.depthStoreOp=G.DISCARD,e&W.COLOR||(e&ut?n.loadOp=Q.DISCARD:(n.loadOp=Q.LOAD,n.beginAccesses=[V.COLOR_ATTACHMENT_WRITE])),(e&W.DEPTH_STENCIL)!==W.DEPTH_STENCIL&&(e&W.DEPTH||(a.depthLoadOp=Q.LOAD),e&W.STENCIL||(a.stencilLoadOp=Q.LOAD)),a.beginAccesses=[V.DEPTH_STENCIL_ATTACHMENT_WRITE];var s=new q([n],a);return r.createRenderPass(s)},i.getRenderPass=function(e,t){var i=this._renderPasses.get(e);return i||(i=this.createRenderPass(e,t.colorTexture.format,t.depthStencilTexture.format),this._renderPasses.set(e,i),i)},i.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,i=this._width*t.shadingScale,r=this._height*t.shadingScale,n=e.colorTextures,a=0;a<n.length;a++)n[a].resize(i,r);e.depthStencilTexture&&e.depthStencilTexture.resize(i,r),e.destroy(),e.initialize(new k(e.renderPass,n,e.depthStencilTexture))},i.generateRenderArea=function(e,t){var i=e.viewport,r=e.window.width,n=e.window.height;t.x=i.x*r,t.y=i.y*n,t.width=i.width*r,t.height=i.height*n},i.generateViewport=function(e,t){this.generateRenderArea(e,cn),t||(t=_n);var i=this.pipelineSceneData.shadingScale;return t.left=cn.x*i,t.top=cn.y*i,t.width=cn.width*i,t.height=cn.height*i,t},i.generateScissor=function(e,t){t||(t=cn),this.generateRenderArea(e,t);var i=this.pipelineSceneData.shadingScale;return t.x*=i,t.y*=i,t.width*=i,t.height*=i,t},i.activate=function(){var e=y.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new ri(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},i._ensureEnoughSize=function(){},i.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(wi.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),X(e);for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){this.emit(wi.RENDER_CAMERA_BEGIN,i),Qt(this,i),Vt(this,i),this._pipelineUBO.updateGlobalUBO(i.window),this._pipelineUBO.updateCameraUBO(i);for(var r=0;r<this._flows.length;r++)this._flows[r].render(i);this.emit(wi.RENDER_CAMERA_END,i)}}this.emit(wi.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},i._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},i._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var i=0;i<t.downsampleTexs.length;++i)t.downsampleTexs[i].destroy(),t.downsampleFramebuffers[i].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var r=0;r<t.upsampleTexs.length;++r)t.upsampleTexs[r].destroy(),t.upsampleFramebuffers[r].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},i._genQuadVertexData=function(e,t){var i=new Float32Array(16),r=t.x/this._width,n=(t.x+t.width)/this._width,a=t.y/this._height,s=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var o=s;s=a,a=o}var u=0;switch(e){case Y.IDENTITY:u=0,i[u++]=-1,i[u++]=-1,i[u++]=r,i[u++]=s,i[u++]=1,i[u++]=-1,i[u++]=n,i[u++]=s,i[u++]=-1,i[u++]=1,i[u++]=r,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=n,i[u++]=a;break;case Y.ROTATE_90:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=s,i[u++]=1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=r,i[u++]=s,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=a;break;case Y.ROTATE_180:u=0,i[u++]=-1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=r,i[u++]=s,i[u++]=1,i[u++]=1,i[u++]=n,i[u++]=s;break;case Y.ROTATE_270:u=0,i[u++]=-1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=s,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=n,i[u++]=s}return i},i._createQuadInputAssembler=function(){var e=new fn,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t,r=this._device.createBuffer(new S(g.VERTEX|g.TRANSFER_DST,m.DEVICE|m.HOST,i,t));if(!r)return e;var n=Uint8Array.BYTES_PER_ELEMENT,a=6*n,s=this._device.createBuffer(new S(g.INDEX|g.TRANSFER_DST,m.DEVICE,a,n));if(!s)return e;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,s.update(o);var u=new Array(2);u[0]=new K("a_position",J.RG32F),u[1]=new K("a_texCoord",J.RG32F);var l=this._device.createInputAssembler(new Z(u,[r],s));return e.quadIB=s,e.quadVB=r,e.quadIA=l,e},i.updateQuadVertexData=function(e,t){var i=this._lastUsedRenderArea;if(i.x!==e.x||i.y!==e.y||i.width!==e.width||i.height!==e.height){var r=this._genQuadVertexData(Y.IDENTITY,e);this._quadVBOffscreen.update(r);var n=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||Y.IDENTITY,e);this._quadVBOnscreen.update(n),i.copy(e)}},i.destroy=function(){for(var t,i,r=0;r<this._flows.length;r++)this._flows[r].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var n=0;n<this._commandBuffers.length;n++)this._commandBuffers[n].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(i=this._pipelineSceneData)||void 0===i||i.destroy(),e.prototype.destroy.call(this)},i._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(j.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(j.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",this._constantMacros=e},i.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new pn,t=this.device,i=new U;i.format=J.RGBA8,i.loadOp=Q.CLEAR,i.storeOp=G.STORE,i.endAccesses=[V.COLOR_ATTACHMENT_WRITE],e.renderPass=t.createRenderPass(new q([i]));var r=this._width,n=this._height;e.prefiterTex=t.createTexture(new $(ee.TEX2D,te.COLOR_ATTACHMENT|te.SAMPLED,J.RGBA8,r>>1,n>>1)),e.prefilterFramebuffer=t.createFramebuffer(new k(e.renderPass,[e.prefiterTex])),r>>=1,n>>=1;for(var a=0;a<6;++a)e.downsampleTexs.push(t.createTexture(new $(ee.TEX2D,te.COLOR_ATTACHMENT|te.SAMPLED,J.RGBA8,r>>1,n>>1))),e.downsampleFramebuffers[a]=t.createFramebuffer(new k(e.renderPass,[e.downsampleTexs[a]])),e.upsampleTexs.push(t.createTexture(new $(ee.TEX2D,te.COLOR_ATTACHMENT|te.SAMPLED,J.RGBA8,r,n))),e.upsampleFramebuffers[a]=t.createFramebuffer(new k(e.renderPass,[e.upsampleTexs[a]])),r>>=1,n>>=1;e.combineTex=t.createTexture(new $(ee.TEX2D,te.COLOR_ATTACHMENT|te.SAMPLED,J.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new k(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},i.on=function(e,t,i,r){return this._eventProcessor.on(e,t,i,r)},i.once=function(e,t,i){return this._eventProcessor.once(e,t,i)},i.off=function(e,t,i){this._eventProcessor.off(e,t,i)},i.emit=function(e,t,i,r,n,a){this._eventProcessor.emit(e,t,i,r,n,a)},i.targetOff=function(e){this._eventProcessor.targetOff(e)},i.removeAll=function(e){this._eventProcessor.removeAll(e)},i.hasEventListener=function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)},O(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(ie),Ni=B((Di=Pi).prototype,"_tag",[Ii,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bi=B(Di.prototype,"_flows",[Ri,Fi,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yi=Di))||yi));y.RenderPipeline=Sn,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(Ci||(Ci={})),function(e){e[e.FORWARD=10]="FORWARD"}(Li||(Li={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(Mi||(Mi={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(xi||(xi={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(Hi||(Hi={})),se(ee),se(te),se(G),se(Q),se(V),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(hn||(hn={})),se(hn),Ui=N("RenderTextureDesc"),zi=M(ee),Gi=M(te),Wi=M(J),Ui((Vi=B((Qi=function(){P(this,"name",Vi,this),P(this,"type",qi,this),P(this,"usage",ki,this),P(this,"format",Xi,this),P(this,"width",Yi,this),P(this,"height",Ki,this)}).prototype,"name",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qi=B(Qi.prototype,"type",[zi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ee.TEX2D}}),ki=B(Qi.prototype,"usage",[Gi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return te.COLOR_ATTACHMENT}}),Xi=B(Qi.prototype,"format",[Wi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return J.UNKNOWN}}),Yi=B(Qi.prototype,"width",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ki=B(Qi.prototype,"height",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Qi));var gn,mn=(Ji=N("RenderTextureConfig"),Zi=M(oe),Ji((er=B(($i=function(){P(this,"name",er,this),P(this,"texture",tr,this)}).prototype,"name",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tr=B($i.prototype,"texture",[Zi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ji=$i))||ji),On=(ir=N("MaterialConfig"),rr=M(ue),ir((ar=B((nr=function(){P(this,"name",ar,this),P(this,"material",sr,this)}).prototype,"name",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sr=B(nr.prototype,"material",[rr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nr)),or=N("FrameBufferDesc"),ur=M([le]),lr=M(oe),or((dr=B((hr=function(){P(this,"name",dr,this),P(this,"renderPass",cr,this),P(this,"colorTextures",_r,this),P(this,"depthStencilTexture",pr,this),P(this,"texture",fr,this)}).prototype,"name",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cr=B(hr.prototype,"renderPass",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_r=B(hr.prototype,"colorTextures",[ur],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pr=B(hr.prototype,"depthStencilTexture",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fr=B(hr.prototype,"texture",[lr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hr)),Sr=N("ColorDesc"),gr=M(J),mr=M(Q),Or=M(G),Er=M([V]),Ar=M([V]),Sr((vr=B((wr=function(){P(this,"format",vr,this),P(this,"loadOp",br,this),P(this,"storeOp",Ir,this),P(this,"sampleCount",Rr,this),P(this,"beginAccesses",Fr,this),P(this,"endAccesses",yr,this)}).prototype,"format",[gr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return J.UNKNOWN}}),br=B(wr.prototype,"loadOp",[mr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Q.CLEAR}}),Ir=B(wr.prototype,"storeOp",[Or],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return G.STORE}}),Rr=B(wr.prototype,"sampleCount",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Fr=B(wr.prototype,"beginAccesses",[Er],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yr=B(wr.prototype,"endAccesses",[Ar],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[V.COLOR_ATTACHMENT_WRITE]}}),Tr=wr))||Tr),En=(Dr=N("DepthStencilDesc"),Nr=M(J),Br=M(Q),Pr=M(G),Cr=M(Q),Lr=M(G),Mr=M([V]),xr=M([V]),Dr((zr=B((Ur=function(){P(this,"format",zr,this),P(this,"depthLoadOp",Gr,this),P(this,"depthStoreOp",Wr,this),P(this,"stencilLoadOp",Qr,this),P(this,"stencilStoreOp",Vr,this),P(this,"sampleCount",qr,this),P(this,"beginAccesses",kr,this),P(this,"endAccesses",Xr,this)}).prototype,"format",[Nr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return J.UNKNOWN}}),Gr=B(Ur.prototype,"depthLoadOp",[Br],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Q.CLEAR}}),Wr=B(Ur.prototype,"depthStoreOp",[Pr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return G.STORE}}),Qr=B(Ur.prototype,"stencilLoadOp",[Cr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Q.CLEAR}}),Vr=B(Ur.prototype,"stencilStoreOp",[Lr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return G.STORE}}),qr=B(Ur.prototype,"sampleCount",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kr=B(Ur.prototype,"beginAccesses",[Mr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xr=B(Ur.prototype,"endAccesses",[xr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[V.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),Hr=Ur))||Hr);Yr=N("RenderPassDesc"),Kr=M([On]),Jr=M(En),Yr((jr=B((Zr=function(){P(this,"index",jr,this),P(this,"colorAttachments",$r,this),P(this,"depthStencilAttachment",en,this)}).prototype,"index",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$r=B(Zr.prototype,"colorAttachments",[Kr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),en=B(Zr.prototype,"depthStencilAttachment",[Jr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En}}),Zr)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(gn||(gn={})),se(gn);var An=(tn=N("RenderQueueDesc"),rn=M(gn),nn=M([le]),tn((on=B((sn=function(){P(this,"isTransparent",on,this),P(this,"sortMode",un,this),P(this,"stages",ln,this)}).prototype,"isTransparent",[C,he],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),un=B(sn.prototype,"sortMode",[rn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gn.FRONT_TO_BACK}}),ln=B(sn.prototype,"stages",[nn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),an=sn))||an);function Tn(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function wn(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var vn=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new ce((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new _e(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,i){var r=e.model.subModels[t],n=r.passes[i],a=r.shaders[i];if(n.blendState.targets[0].blend!==this._passDesc.isTransparent||!(n.phase&this._passDesc.phases))return!1;var s=0|n.priority<<16|r.priority<<8|i,o=this._passPool.add();return o.hash=s,o.depth=e.depth||0,o.shaderId=a.typedID,o.subModel=r,o.passIdx=i,this.queue.push(o),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,i){for(var r=0;r<this.queue.length;++r){var n=this.queue.array[r],a=n.subModel,s=n.passIdx,o=a.inputAssembler,u=a.passes[s],l=a.shaders[s],h=pe.getOrCreatePipelineState(e,u,l,t,o);i.bindPipelineState(h),i.bindDescriptorSet(fe.MATERIAL,u.descriptorSet),i.bindDescriptorSet(fe.LOCAL,a.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}();function bn(e){for(var t=0,i=0;i<e.stages.length;i++)t|=de(e.stages[i]);var r=Tn;switch(e.sortMode){case gn.BACK_TO_FRONT:r=wn;break;case gn.FRONT_TO_BACK:r=Tn}return new vn({isTransparent:e.isTransparent,phases:t,sortFunc:r})}function In(e){e.clear()}function Rn(e){e.sort()}var Fn=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;){for(var r=0;r<i.value.batches.length;++r){var n=i.value.batches[r];if(n.mergeCount){for(var a=0;a<n.vbs.length;++a)n.vbs[a].update(n.vbDatas[a]);e.updateBuffer(n.vbIdx,n.vbIdxData.buffer),e.updateBuffer(n.ubo,n.uboData)}}i=t.next()}},t.recordCommandBuffer=function(e,t,i){for(var r=this.queue.values(),n=r.next();!n.done;){for(var a=!1,s=0;s<n.value.batches.length;++s){var o=n.value.batches[s];if(o.mergeCount){if(!a){var u=o.shader,l=pe.getOrCreatePipelineState(e,o.pass,u,t,o.ia);i.bindPipelineState(l),i.bindDescriptorSet(fe.MATERIAL,o.pass.descriptorSet),a=!0}i.bindDescriptorSet(fe.LOCAL,o.descriptorSet,n.value.dynamicOffsets),i.bindInputAssembler(o.ia),i.draw(o.ia)}}n=r.next()}},e}(),yn=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()},t.recordCommandBuffer=function(e,t,i){for(var r=this.queue.values(),n=r.next();!n.done;){var a=n.value,s=a.instances,o=a.pass;if(a.hasPendingModels){i.bindDescriptorSet(fe.MATERIAL,o.descriptorSet);for(var u=null,l=0;l<s.length;++l){var h=s[l];if(h.count){var d=h.shader,c=pe.getOrCreatePipelineState(e,o,d,t,h.ia);u!==c&&(i.bindPipelineState(c),u=c),i.bindDescriptorSet(fe.LOCAL,h.descriptorSet,n.value.dynamicOffsets),i.bindInputAssembler(h.ia),i.draw(h.ia)}}}n=r.next()}},e}(),Dn=new o((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),Nn=new Float32Array(4),Bn=[],Pn=[],Cn=new i,Ln=new i;function Mn(e,t){return!(!t.worldBounds||u.aabbWithAABB(t.worldBounds,e.aabb))}function xn(e,t){return!(!t.worldBounds||u.aabbWithAABB(t.worldBounds,e.aabb)&&u.aabbFrustum(t.worldBounds,e.frustum))}var Hn=de("forward-add"),Un=[];function zn(e,t){t.length=0;for(var i=!1,r=0;r<e.length;r++){for(var n=e[r].passes,a=-1,s=0;s<n.length;s++)if(n[s].phase===Hn){a=s,i=!0;break}t.push(a)}return i}var Gn,Wn,Qn,Vn,qn,kn,Xn,Yn,Kn,Jn,Zn,jn=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(l.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new yn,this._batchedQueue=new Fn;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Se.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new S(g.UNIFORM|g.TRANSFER_DST,m.HOST|m.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new ge(this._lightBuffer,0,Se.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var r=e.prototype;return r.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}Dn.freeArray(this._lightPasses),this._lightPasses.length=0},r.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,i=0;i<t.length;i++){var r=t[i],n=e.get(r);n&&(n.getBuffer(l.BINDING).destroy(),n.getTexture(b).destroy(),n.getTexture(R).destroy(),n.destroy()),e.delete(r)}},r.gatherLightPasses=function(e,t){this.clear();var i=this._pipeline.pipelineSceneData.validPunctualLights;if(i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var r=this._pipeline.pipelineSceneData.renderObjects,n=0;n<r.length;n++){var a=r[n].model,s=a.subModels;if(zn(s,Un)&&(Pn.length=0,this._lightCulling(a,i),Pn.length))for(var o=0;o<s.length;o++){var u=Un[o];if(!(u<0)){var l=s[o],h=l.passes[u];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(Se.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(h,l,a,u))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},r.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var r=this._pipeline.globalDSManager,n=0;n<this._lightPasses.length;n++){var a=this._lightPasses[n],s=a.subModel,o=a.passIdx,u=a.dynamicOffsets,l=a.lights,h=s.passes[o],d=s.shaders[o],c=s.inputAssembler,_=pe.getOrCreatePipelineState(e,h,d,t,c),p=h.descriptorSet,f=s.descriptorSet;i.bindPipelineState(_),i.bindDescriptorSet(fe.MATERIAL,p),i.bindInputAssembler(c);for(var S=0;S<u.length;++S){var g=l[S],m=r.getOrCreateDescriptorSet(g);Bn[0]=u[S],i.bindDescriptorSet(fe.GLOBAL,m),i.bindDescriptorSet(fe.LOCAL,f,Bn),i.draw(c)}}},r._lightCulling=function(e,t){for(var i=0;i<t.length;i++){var r=t[i],n=!1;switch(r.type){case lt.SPHERE:n=Mn(r,e);break;case lt.SPOT:n=xn(r,e)}n||Pn.push(i)}},r._addRenderQueue=function(e,t,i,r){var n=e.batchingScheme;if(n===me.INSTANCING)for(var a=0;a<Pn.length;a++){var s=Pn[a],o=e.getInstancedBuffer(s);o.merge(t,i.instancedAttributes,r),o.dynamicOffsets[0]=this._lightBufferStride*s,this._instancedQueue.queue.add(o)}else if(n===me.VB_MERGING)for(var u=0;u<Pn.length;u++){var l=Pn[u],h=e.getBatchedBuffer(l);h.merge(t,r,i),h.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(h)}else{var d=Dn.alloc();d.subModel=t,d.passIdx=r;for(var c=0;c<Pn.length;c++){var _=Pn[c];d.lights.push(_),d.dynamicOffsets.push(this._lightBufferStride*_)}this._lightPasses.push(d)}},r._updateLightDescriptorSet=function(e,t){for(var r=this._pipeline.device,n=this._pipeline.pipelineSceneData,a=n.shadows,s=n.shadowFrameBufferMap,o=e.scene.mainLight,u=D(r)?0:1,h=this._pipeline.globalDSManager,d=n.validPunctualLights,c=0;c<d.length;c++){var _=d[c],p=h.getOrCreateDescriptorSet(c);if(p){var f=void 0,S=void 0;switch(_.type){case lt.SPHERE:o&&Wt(a,o,this._shadowUBO),this._shadowUBO[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=a.pcf,this._shadowUBO[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=a.bias,this._shadowUBO[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=u,this._shadowUBO[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=a.normalBias,this._shadowUBO[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,F.toArray(this._shadowUBO,a.shadowColor,l.SHADOW_COLOR_OFFSET);break;case lt.SPOT:if(o&&Wt(a,o,this._shadowUBO),i.invert(Cn,_.node.getWorldMatrix()),i.perspective(Ln,_.angle,_.aspect,.001,_.range),f=Ln.clone(),S=Ln.clone().invert(),i.multiply(Ln,Ln,Cn),i.toArray(this._shadowUBO,Cn,l.MAT_LIGHT_VIEW_OFFSET),i.toArray(this._shadowUBO,Ln,l.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=_.range,this._shadowUBO[l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[l.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-a.saturation,this._shadowUBO[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=a.pcf,this._shadowUBO[l.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=a.bias,this._shadowUBO[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=u,this._shadowUBO[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=a.normalBias,this._shadowUBO[l.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[l.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[l.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=S.m10,this._shadowUBO[l.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=S.m14,this._shadowUBO[l.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=S.m11,this._shadowUBO[l.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=S.m15,this._shadowUBO[l.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[l.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[l.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[l.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,F.toArray(this._shadowUBO,a.shadowColor,l.SHADOW_COLOR_OFFSET),s.has(_)){var g,m=null===(g=s.get(_))||void 0===g?void 0:g.colorTextures[0];m&&p.bindTexture(R,m)}}p.update(),t.updateBuffer(p.getBuffer(l.BINDING),this._shadowUBO)}}},r._updateUBOs=function(e,i){var r=e.exposure,n=this._pipeline.pipelineSceneData,a=n.isHDR,s=n.shadows,o=n.validPunctualLights;o.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=Oe(o.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new ge(this._lightBuffer,0,Se.SIZE)));for(var u=0,l=0;u<o.length;u++,l+=this._lightBufferElementCount){var d=o[u];switch(d.type){case lt.SPHERE:if(t.toArray(Nn,d.position),Nn[3]=0,this._lightBufferData.set(Nn,l+Se.LIGHT_POS_OFFSET),Nn[0]=d.size,Nn[1]=d.range,Nn[2]=0,Nn[3]=s.enabled&&s.type===h.ShadowMap?1:0,this._lightBufferData.set(Nn,l+Se.LIGHT_SIZE_RANGE_ANGLE_OFFSET),t.toArray(Nn,d.color),d.useColorTemperature){var c=d.colorTemperatureRGB;Nn[0]*=c.x,Nn[1]*=c.y,Nn[2]*=c.z}Nn[3]=a?d.luminance*r*this._lightMeterScale:d.luminance,this._lightBufferData.set(Nn,l+Se.LIGHT_COLOR_OFFSET);break;case lt.SPOT:if(t.toArray(Nn,d.position),Nn[3]=1,this._lightBufferData.set(Nn,l+Se.LIGHT_POS_OFFSET),Nn[0]=d.size,Nn[1]=d.range,Nn[2]=d.spotAngle,Nn[3]=s.enabled&&s.type===h.ShadowMap?1:0,this._lightBufferData.set(Nn,l+Se.LIGHT_SIZE_RANGE_ANGLE_OFFSET),t.toArray(Nn,d.direction),this._lightBufferData.set(Nn,l+Se.LIGHT_DIR_OFFSET),t.toArray(Nn,d.color),d.useColorTemperature){var _=d.colorTemperatureRGB;Nn[0]*=_.x,Nn[1]*=_.y,Nn[2]*=_.z}Nn[3]=a?d.luminance*r*this._lightMeterScale:d.luminance,this._lightBufferData.set(Nn,l+Se.LIGHT_COLOR_OFFSET)}}i.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),$n=new r,ea=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new yn,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var i=this._pipeline.pipelineSceneData,n=(this._pipeline.pipelineUBO,i.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,n.enabled&&n.type===h.Planar){var a=e.scene,s=e.frustum,o=0!=(e.visibility&Ee.BitMask.DEFAULT);if(a.mainLight&&o){for(var l=a.models,d=0;d<l.length;d++){var c=l[d];c.enabled&&c.node&&c.castShadow&&this._castModels.push(c)}var _=n.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(_);for(var p=0;p<this._castModels.length;p++){var f=this._castModels[p];if(!f.worldBounds||(r.transform($n,f.worldBounds,n.matLight),u.aabbFrustum($n,s)))if(f.isInstancingEnabled)for(var S=f.subModels,g=0;g<S.length;g++){var m=S[g];_.merge(m,f.instancedAttributes,0,m.planarInstanceShader)}else this._pendingModels.push(f)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,i){var r=this._pipeline.pipelineSceneData.shadows;if(r.enabled&&r.type===h.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,i),this._pendingModels.length)){var n=r.material.passes[0],a=n.descriptorSet;i.bindDescriptorSet(fe.MATERIAL,a);for(var s=this._pendingModels.length,o=0;o<s;o++)for(var u=this._pendingModels[o],l=0;l<u.subModels.length;l++){var d=u.subModels[l],c=d.planarShader,_=d.inputAssembler,p=pe.getOrCreatePipelineState(e,n,c,t,_);i.bindPipelineState(p),i.bindDescriptorSet(fe.LOCAL,d.descriptorSet),i.bindInputAssembler(_),i.draw(_)}}},e}(),ta=function(){function e(){this._phaseID=de("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var i=this._pipeline,r=i.device,n=i.commandBuffers[0],a=e.scene.batches,s=0;s<a.length;s++){var o=a[s],u=!1;if(e.visibility&o.visFlags&&(u=!0),u)for(var l=o.shaders.length,h=0;h<l;h++){var d=o.passes[h];if(d.phase===this._phaseID){var c=o.shaders[h],_=o.inputAssembler,p=pe.getOrCreatePipelineState(r,d,c,t,_);n.bindPipelineState(p),n.bindDescriptorSet(fe.MATERIAL,d.descriptorSet);var f=o.descriptorSet;n.bindDescriptorSet(fe.LOCAL,f),n.bindInputAssembler(_),n.draw(_)}}}},e}(),ia=[new Te(0,0,0,1)],ra=e("e",(Gn=N("ForwardStage"),Wn=M([An]),Qn=L(),Gn((Yn=Xn=function(e){function t(){var t;return t=e.call(this)||this,P(t,"renderQueues",kn,ae(t)),t._renderQueues=[],t._renderArea=new re,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=de("default"),t._clearFlag=4294967295,t._batchedQueue=new Fn,t._instancedQueue=new yn,t._uiPhase=new ta,t}x(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=bn(this.renderQueues[r]);this._additiveLightQueue=new jn(this._pipeline),this._planarQueue=new ea(this._pipeline),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(In);for(var r=t.pipelineSceneData.renderObjects,n=0,a=0,s=0,o=0;o<r.length;++o){var u=r[o],l=u.model.subModels;for(n=0;n<l.length;++n){var h=l[n],d=h.passes;for(a=0;a<d.length;++a){var c=d[a];if(c.phase===this._phaseID){var _=c.batchingScheme;if(_===me.INSTANCING){var p=c.getInstancedBuffer();p.merge(h,u.model.instancedAttributes,a),this._instancedQueue.queue.add(p)}else if(_===me.VB_MERGING){var f=c.getBatchedBuffer();f.merge(h,a,u.model),this._batchedQueue.queue.add(f)}else for(s=0;s<this._renderQueues.length;s++)this._renderQueues[s].insertRenderPass(u,n,a)}}}}this._renderQueues.forEach(Rn);var S=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(S),this._batchedQueue.uploadBuffers(S),this._additiveLightQueue.gatherLightPasses(e,S),this._planarQueue.gatherShadowPasses(e,S),e.clearFlag&W.COLOR&&(ia[0].x=e.clearColor.x,ia[0].y=e.clearColor.y,ia[0].z=e.clearColor.z,ia[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var g=e.window.swapchain,m=e.window.framebuffer,O=g?t.getRenderPass(e.clearFlag&this._clearFlag,g):m.renderPass;S.beginRenderPass(O,m,this._renderArea,ia,e.clearDepth,e.clearStencil),S.bindDescriptorSet(fe.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,O,S),this._instancedQueue.recordCommandBuffer(i,O,S),this._batchedQueue.recordCommandBuffer(i,O,S),this._additiveLightQueue.recordCommandBuffer(i,O,S),S.bindDescriptorSet(fe.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(i,O,S),this._renderQueues[1].recordCommandBuffer(i,O,S),this._uiPhase.render(e,O),Ae(i,O,S,t.profiler,e),S.endRenderPass()},t}(Ti),Xn.initInfo={name:"ForwardStage",priority:Li.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:gn.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:gn.BACK_TO_FRONT,stages:["default","planarShadow"]}]},kn=B((qn=Yn).prototype,"renderQueues",[Wn,C,Qn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vn=qn))||Vn)),na=e("d",N("ForwardFlow")((Zn=Jn=function(e){function t(){return e.apply(this,arguments)||this}x(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new ra;i.initialize(ra.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(vi),Jn.initInfo={name:we,priority:Mi.FORWARD,stages:[]},Kn=Zn))||Kn),aa=new i,sa=new i,oa=new i,ua=new r,la=de("shadow-caster"),ha=[];function da(e,t){t.length=0;for(var i=!1,r=0;r<e.length;r++){for(var n=e[r].passes,a=-1,s=0;s<n.length;s++)if(n[s].phase===la){a=s,i=!0;break}t.push(a)}return i}var ca,_a,pa,fa,Sa,ga,ma,Oa,Ea,Aa,Ta,wa,va,ba,Ia,Ra,Fa,ya,Da,Na,Ba,Pa,Ca,La,Ma,xa,Ha,Ua,za,Ga,Wa,Qa,Va,qa,ka,Xa,Ya,Ka,Ja,Za,ja,$a,es,ts,is=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new yn,this._batchedQueue=new Fn}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,a){this.clear();var s=this._pipeline.pipelineSceneData,o=s.shadows,l=s.dirShadowObjects,d=s.castShadowObjects;if(n&&o.enabled&&o.type===h.ShadowMap)switch(n.type){case lt.DIRECTIONAL:for(var c=0;c<l.length;c++){var _=l[c].model;da(_.subModels,ha)&&this.add(_,a,ha)}break;case lt.SPOT:i.invert(aa,n.node.getWorldMatrix()),i.perspective(sa,n.angle,n.aspect,.001,n.range),i.multiply(oa,sa,aa);for(var p=0;p<d.length;p++){var f=d[p].model;da(f.subModels,ha)&&(f.worldBounds&&(r.transform(ua,f.worldBounds,oa),!u.aabbFrustum(ua,t.frustum))||this.add(f,a,ha))}}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t,i){for(var r=e.subModels,n=0;n<r.length;n++){var a=r[n],s=i[n],o=a.passes[s];if(o.batchingScheme===me.INSTANCING){var u=o.getInstancedBuffer();u.merge(a,e.instancedAttributes,s),this._instancedQueue.queue.add(u)}else if(o.batchingScheme===me.VB_MERGING){var l=o.getBatchedBuffer();l.merge(a,s,e),this._batchedQueue.queue.add(l)}else{var h=a.shaders[s];this._subModelsArray.push(a),h&&this._shaderArray.push(h),this._passArray.push(o)}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var r=0;r<this._subModelsArray.length;++r){var n=this._subModelsArray[r],a=this._shaderArray[r],s=this._passArray[r],o=n.inputAssembler,u=pe.getOrCreatePipelineState(e,s,a,t,o),l=s.descriptorSet;i.bindPipelineState(u),i.bindDescriptorSet(fe.MATERIAL,l),i.bindDescriptorSet(fe.LOCAL,n.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}(),rs=[new Te(1,1,1,1)],ns=e("h",N("ShadowStage")((pa=_a=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._shadowFrameBuffer=null,t._renderArea=new re,t._light=null,t._globalDS=null,t}x(t,e);var i=t.prototype;return i.setUsage=function(e,t,i){this._globalDS=e,this._light=t,this._shadowFrameBuffer=i},i.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},i.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){rs[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],i=this._shadowFrameBuffer.renderPass;t.beginRenderPass(i,this._shadowFrameBuffer,this._renderArea,rs,e.clearDepth,e.clearStencil),t.endRenderPass()}},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData,r=i.shadows,n=i.shadingScale,a=this._globalDS,s=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(a,this._light),this._additiveShadowQueue.gatherLightPasses(a,e,this._light,s);var o=e.viewport,u=r.size;this._renderArea.x=o.x*u.x,this._renderArea.y=o.y*u.y,this._renderArea.width=o.width*u.x*n,this._renderArea.height=o.height*u.y*n;var l=t.device,h=this._shadowFrameBuffer.renderPass;s.beginRenderPass(h,this._shadowFrameBuffer,this._renderArea,rs,e.clearDepth,e.clearStencil),s.bindDescriptorSet(fe.GLOBAL,a),this._additiveShadowQueue.recordCommandBuffer(l,h,s),s.endRenderPass()}},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._additiveShadowQueue=new is(t)},t}(Ti),_a.initInfo={name:"ShadowStage",priority:Li.FORWARD,tag:0},ca=pa))||ca),as=[],ss=e("S",N("ShadowFlow")((ga=Sa=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._shadowRenderPass=null,t}x(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new ns;i.initialize(ns.initInfo),this._stages.push(i)}return!0},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData.shadows,r=t.pipelineSceneData.shadowFrameBufferMap,n=t.pipelineSceneData.castShadowObjects,a=this._pipeline.pipelineSceneData.validPunctualLights;if(i.enabled&&i.type===h.ShadowMap){for(var s=0,o=0;s<i.maxReceived&&o<a.length;){var u=a[o];u.type===lt.SPOT&&(as.push(u),s++),o++}if(0!==n.length){i.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var d=t.descriptorSet;r.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var c=r.get(l),_=0;_<this._stages.length;_++){var p=this._stages[_];p.setUsage(d,l,c),p.render(e)}}for(var f=0;f<as.length;f++){var S=as[f],g=t.globalDSManager.getOrCreateDescriptorSet(f);r.has(S)||this._initShadowFrameBuffer(t,S,e.window.swapchain);for(var m=r.get(S),O=0;O<this._stages.length;O++){var E=this._stages[O];E.setUsage(g,S,m),E.render(e)}}as.length=0}else this.clearShadowMap(as,e)}},i.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,i=Array.from(t.values()),r=0;r<i.length;r++){var n=i[r];if(n){for(var a=n.colorTextures,s=0;s<a.length;s++){var o=a[r];o&&o.destroy()}a.length=0;var u=n.depthStencilTexture;u&&u.destroy(),n.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},i._initShadowFrameBuffer=function(e,t){var i=e.device,r=e.pipelineSceneData.shadows.size,n=e.pipelineSceneData.shadowFrameBufferMap,a=D(i)?J.R32F:J.RGBA8;if(!this._shadowRenderPass){var s=new U;s.format=a,s.loadOp=Q.CLEAR,s.storeOp=G.STORE,s.sampleCount=1;var o=new z;o.format=J.DEPTH_STENCIL,o.depthLoadOp=Q.CLEAR,o.depthStoreOp=G.DISCARD,o.stencilLoadOp=Q.CLEAR,o.stencilStoreOp=G.DISCARD,o.sampleCount=1;var u=new q([s],o);this._shadowRenderPass=i.createRenderPass(u)}var l=[];l.push(i.createTexture(new $(ee.TEX2D,te.COLOR_ATTACHMENT|te.SAMPLED,a,r.x,r.y)));var h=i.createTexture(new $(ee.TEX2D,te.DEPTH_STENCIL_ATTACHMENT,J.DEPTH_STENCIL,r.x,r.y)),d=i.createFramebuffer(new k(this._shadowRenderPass,l,h));n.set(t,d)},i.clearShadowMap=function(e,t){var i=this._pipeline,r=i.pipelineSceneData,n=t.scene.mainLight;if(n){var a=this._pipeline.descriptorSet;r.shadowFrameBufferMap.has(n)||this._initShadowFrameBuffer(this._pipeline,n,t.window.swapchain);for(var s=r.shadowFrameBufferMap.get(n),o=0;o<this._stages.length;o++){var u=this._stages[o];u.setUsage(a,n,s),u.render(t)}}for(var l=0;l<e.length;l++){var h=e[l],d=r.shadowFrameBufferMap.get(h),c=i.globalDSManager.getOrCreateDescriptorSet(l);if(r.shadowFrameBufferMap.has(h))for(var _=0;_<this._stages.length;_++){var p=this._stages[_];p.setUsage(c,h,d),p.clearFramebuffer(t)}}},i.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,i=this._pipeline,r=i.device,n=i.pipelineSceneData.shadowFrameBufferMap,a=D(r)?J.R32F:J.RGBA8,s=n.values(),o=s.next();!o.done;){var u=o.value;if(u){var l=[];l.push(i.device.createTexture(new $(ee.TEX2D,te.COLOR_ATTACHMENT|te.SAMPLED,a,t.x,t.y)));var h=u.depthStencilTexture;h&&h.resize(t.x,t.y);var d=u.renderPass;u.destroy(),u.initialize(new k(d,l,h)),o=s.next()}else o=s.next()}e.shadowMapDirty=!1},t}(vi),Sa.initInfo={name:ve,priority:Mi.SHADOW,tag:hn.SCENE,stages:[]},fa=ga))||fa),os=function(){var e=t.prototype;function t(){this.fog=new be,this.ambient=new Ie,this.skybox=new ht,this.shadows=new Re,this.octree=new dt,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initOcclusionQuery(),!0},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new ue;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,i;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(i=this._occlusionQueryIndicesBuffer)||void 0===i||i.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),i=3*Float32Array.BYTES_PER_ELEMENT,r=8*i;this._occlusionQueryVertexBuffer=e.createBuffer(new S(g.VERTEX|g.TRANSFER_DST,m.DEVICE,r,i)),this._occlusionQueryVertexBuffer.update(t);var n=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),a=Uint16Array.BYTES_PER_ELEMENT,s=36*a;this._occlusionQueryIndicesBuffer=e.createBuffer(new S(g.INDEX|g.TRANSFER_DST,m.DEVICE,s,a)),this._occlusionQueryIndicesBuffer.update(n);var o=[new K("a_position",J.RGB32F)],u=new Z(o,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(u)},O(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(wi.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(),us=(e("F",(ma=N("ForwardPipeline"),Oa=M([mn]),Ea=L(),ma((va=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return t=e.call.apply(e,[this].concat(r))||this,P(t,"renderTextures",wa,ae(t)),t._postRenderPass=null,t}x(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new ss;i.initialize(ss.initInfo),this._flows.push(i);var r=new na;r.initialize(na.initInfo),this._flows.push(r)}return!0},i.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new os,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(Fe(2402),1))},i._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,r=0;r<e.length;++r){var n=e[r].window;t=Math.max(n.width,t),i=Math.max(n.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i)},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(b,t),this._descriptorSet.bindTexture(b,I.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(R,t),this._descriptorSet.bindTexture(R,I.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(w.BINDING).destroy(),this._descriptorSet.getBuffer(l.BINDING).destroy(),this._descriptorSet.getBuffer(v.BINDING).destroy(),this._descriptorSet.getTexture(b).destroy(),this._descriptorSet.getTexture(R).destroy())},O(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(Sn),wa=B((Ta=va).prototype,"renderTextures",[Oa,C,Ea],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Aa=Ta))||Aa)),[new Te(0,0,0,0),new Te(0,0,0,0),new Te(0,0,0,0),new Te(0,0,0,0)]),ls=e("f",(ba=N("GbufferStage"),Ia=M([An]),Ra=L(),ba((Ba=Na=function(e){function t(){var t;return t=e.call(this)||this,P(t,"renderQueues",Da,ae(t)),t._renderQueues=[],t._renderArea=new re,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=de("default"),t._batchedQueue=new Fn,t._instancedQueue=new yn,t}x(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=bn(this.renderQueues[r])},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(In),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var r=t.pipelineSceneData.renderObjects,n=0,a=0,s=0,o=0;o<r.length;++o){var u=r[o],l=u.model.subModels;for(n=0;n<l.length;++n){var h=l[n],d=h.passes;for(a=0;a<d.length;++a){var c=d[a];if(c.phase===this._phaseID){var _=c.batchingScheme;if(_===me.INSTANCING){var p=c.getInstancedBuffer();p.merge(h,u.model.instancedAttributes,a),this._instancedQueue.queue.add(p)}else if(_===me.VB_MERGING){var f=c.getBatchedBuffer();f.merge(h,a,u.model),this._batchedQueue.queue.add(f)}else for(s=0;s<this._renderQueues.length;s++)this._renderQueues[s].insertRenderPass(u,n,a)}}}}this._renderQueues.forEach(Rn);var S=t.commandBuffers[0];this._instancedQueue.uploadBuffers(S),this._batchedQueue.uploadBuffers(S),e.clearFlag&W.COLOR&&(t.pipelineSceneData.isHDR?ye(us[0],e.clearColor):(us[0].x=e.clearColor.x,us[0].y=e.clearColor.y,us[0].z=e.clearColor.z)),us[0].w=e.clearColor.w;var g=t.getPipelineRenderData().gbufferFrameBuffer,m=g.renderPass;S.beginRenderPass(m,g,this._renderArea,us,e.clearDepth,e.clearStencil),S.setScissor(t.generateScissor(e)),S.setViewport(t.generateViewport(e)),S.bindDescriptorSet(fe.GLOBAL,t.descriptorSet);for(var O=0;O<this.renderQueues.length;O++)this._renderQueues[O].recordCommandBuffer(i,m,S);this._instancedQueue.recordCommandBuffer(i,m,S),this._batchedQueue.recordCommandBuffer(i,m,S),S.endRenderPass()},t}(Ti),Na.initInfo={name:"GbufferStage",priority:xi.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:gn.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:gn.BACK_TO_FRONT,stages:["default"]}]},Da=B((ya=Ba).prototype,"renderQueues",[Ia,C,Ra],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fa=ya))||Fa)),hs=[new Te(0,0,0,1)],ds=e("L",(Pa=N("LightingStage"),Ca=M(ue),La=L(),Ma=M([An]),xa=L(),Pa((Qa=Wa=function(e){function i(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=De.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new re,t._uiPhase=void 0,P(t,"_deferredMaterial",za,ae(t)),P(t,"renderQueues",Ga,ae(t)),t._phaseID=de("default"),t._renderQueues=[],t._uiPhase=new ta,t}x(i,e);var r=i.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.gatherLights=function(e){for(var i=this._pipeline,r=i.commandBuffers[0],a=e.scene.sphereLights,s=e.scene.spotLights,o=n.create(0,0,0,1),l=new Float32Array(4),h=e.exposure,d=0,c=T.length,_=c*this._maxDeferredLights,p=0;p<a.length&&d<this._maxDeferredLights;p++,++d){var f=a[p];if(n.set(o,f.position.x,f.position.y,f.position.z,f.range),u.sphereFrustum(o,e.frustum)){if(t.toArray(l,f.position),l[3]=0,this._lightBufferData.set(l,d*c),t.toArray(l,f.color),f.useColorTemperature){var S=f.colorTemperatureRGB;l[0]*=S.x,l[1]*=S.y,l[2]*=S.z}i.pipelineSceneData.isHDR?l[3]=f.luminance*h*this._lightMeterScale:l[3]=f.luminance,this._lightBufferData.set(l,d*c+1*_),l[0]=f.size,l[1]=f.range,l[2]=0,this._lightBufferData.set(l,d*c+2*_)}}for(var g=0;g<s.length&&d<this._maxDeferredLights;g++,++d){var m=s[g];if(n.set(o,m.position.x,m.position.y,m.position.z,m.range),u.sphereFrustum(o,e.frustum)){if(t.toArray(l,m.position),l[3]=1,this._lightBufferData.set(l,d*c+0*_),t.toArray(l,m.color),m.useColorTemperature){var O=m.colorTemperatureRGB;l[0]*=O.x,l[1]*=O.y,l[2]*=O.z}i.pipelineSceneData.isHDR?l[3]=m.luminance*h*this._lightMeterScale:l[3]=m.luminance,this._lightBufferData.set(l,d*c+1*_),l[0]=m.size,l[1]=m.range,l[2]=m.spotAngle,this._lightBufferData.set(l,d*c+2*_),t.toArray(l,m.direction),this._lightBufferData.set(l,d*c+3*_)}}var E=3*_+3;this._lightBufferData.set([d],E),r.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},r.activate=function(t,i){e.prototype.activate.call(this,t,i),this._uiPhase.activate(t);for(var r=t.device,n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=bn(this.renderQueues[n]);var a=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;a=Math.ceil(a/r.capabilities.uboOffsetAlignment)*r.capabilities.uboOffsetAlignment,this._deferredLitsBufs=r.createBuffer(new S(g.UNIFORM|g.TRANSFER_DST,m.HOST|m.DEVICE,a,r.capabilities.uboOffsetAlignment));var s=r.createBuffer(new ge(this._deferredLitsBufs,0,a));this._lightBufferData=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT);var o=new E(Ne.bindings);this._descriptorSetLayout=r.createDescriptorSetLayout(o),this._descriptorSet=r.createDescriptorSet(new p(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(Se.BINDING,s),this._planarQueue=new ea(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},r.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},r.render=function(e){var t=this._pipeline,i=t.device,r=t.commandBuffers[0],n=t.pipelineSceneData,a=n.renderObjects;this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,r),r.bindDescriptorSet(fe.LOCAL,this._descriptorSet,[0]),t.generateRenderArea(e,this._renderArea),e.clearFlag&W.COLOR&&(hs[0].x=e.clearColor.x,hs[0].y=e.clearColor.y,hs[0].z=e.clearColor.z),hs[0].w=0;var s=t.getPipelineRenderData(),o=s.outputFrameBuffer,u=o.renderPass;t.pipelineUBO.updateShadowUBO(e),r.beginRenderPass(u,o,this._renderArea,hs,e.clearDepth,e.clearStencil),r.setScissor(t.generateScissor(e)),r.setViewport(t.generateViewport(e)),r.bindDescriptorSet(fe.GLOBAL,t.descriptorSet);for(var l=n.deferredLightingMaterial.passes[0],h=l.getShaderVariant(),d=0;d<4;++d)l.descriptorSet.bindTexture(d,s.gbufferRenderTargets[d]),l.descriptorSet.bindSampler(d,s.sampler);l.descriptorSet.update(),r.bindDescriptorSet(fe.MATERIAL,l.descriptorSet);var c=t.quadIAOffscreen,_=null;null!=l&&null!=h&&null!=c&&(_=pe.getOrCreatePipelineState(i,l,h,u,c)),null!=_&&(r.bindPipelineState(_),r.bindInputAssembler(c),r.draw(c)),this._renderQueues.forEach(In);for(var p=0,f=0,S=0,g=0;g<a.length;++g){var m=a[g],O=m.model.subModels;for(p=0;p<O.length;++p){var E=O[p].passes;for(f=0;f<E.length;++f)if(E[f].phase===this._phaseID)for(S=0;S<this._renderQueues.length;S++)this._renderQueues[S].insertRenderPass(m,p,f)}}if(a.length>0){this._renderQueues.forEach(Rn);for(var A=0;A<this._renderQueues.length;A++)this._renderQueues[A].recordCommandBuffer(i,u,r);this._planarQueue.recordCommandBuffer(i,u,r)}this._uiPhase.render(e,u),r.endRenderPass()},i}(Ti),Wa.initInfo={name:"LightingStage",priority:xi.LIGHTING,tag:0},za=B((Ua=Qa).prototype,"_deferredMaterial",[Ca,C,La],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ga=B(Ua.prototype,"renderQueues",[Ma,C,xa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ha=Ua))||Ha)),cs=[new Te(0,0,0,1)],_s=e("P",(Va=N("PostProcessStage"),qa=M(ue),ka=L(),Xa=M([An]),Ya=L(),Va((es=$a=function(e){function t(){var t;return t=e.call(this)||this,P(t,"_postProcessMaterial",Za,ae(t)),P(t,"renderQueues",ja,ae(t)),t._renderArea=new re,t._uiPhase=new ta,t}x(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){var t=this._pipeline,i=t.device,r=t.pipelineSceneData,n=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var a=e.viewport;this._renderArea.x=a.x*e.window.width,this._renderArea.y=a.y*e.window.height,this._renderArea.width=a.width*e.window.width,this._renderArea.height=a.height*e.window.height;var s=t.getPipelineRenderData(),o=e.window.framebuffer,u=e.window.swapchain,l=u?t.getRenderPass(e.clearFlag,u):o.renderPass;e.clearFlag&W.COLOR&&(cs[0].x=e.clearColor.x,cs[0].y=e.clearColor.y,cs[0].z=e.clearColor.z),cs[0].w=e.clearColor.w,n.beginRenderPass(l,o,this._renderArea,cs,e.clearDepth,e.clearStencil),n.bindDescriptorSet(fe.GLOBAL,t.descriptorSet);var h=r.postprocessMaterial.passes[0],d=h.getShaderVariant();t.bloomEnabled?h.descriptorSet.bindTexture(0,s.bloom.combineTex):h.descriptorSet.bindTexture(0,s.outputRenderTargets[0]),h.descriptorSet.bindSampler(0,s.sampler),h.descriptorSet.update(),n.bindDescriptorSet(fe.MATERIAL,h.descriptorSet);var c=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=h&&null!=d&&null!=c&&(_=pe.getOrCreatePipelineState(i,h,d,l,c));var p=t.pipelineSceneData.renderObjects;null!=_&&p.length>0&&(n.bindPipelineState(_),n.bindInputAssembler(c),n.draw(c)),this._uiPhase.render(e,l),Ae(i,l,n,t.profiler,e),n.endRenderPass()},t}(Ti),$a.initInfo={name:"PostProcessStage",priority:Ci.POST_PROCESS,tag:0},Za=B((Ja=es).prototype,"_postProcessMaterial",[qa,C,ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ja=B(Ja.prototype,"renderQueues",[Xa,C,Ya],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ka=Ja))||Ka));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(ts||(ts={}));var ps,fs,Ss,gs,ms,Os,Es,As,Ts=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._antiAliasing=ts.NONE,t}x(t,e);var i=t.prototype;return i.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},i.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],i=[],r=0;r<6;++r){var n=this._bloomMaterial.passes[1+r];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently();var a=this._bloomMaterial.passes[7+r];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently(),t.push(n.native),i.push(a.native)}var s=this._bloomMaterial.passes[13];s.beginChangeStatesSilently(),s.tryCompile(),s.endChangeStatesSilently()}},i.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},i.initPipelinePassInfo=function(){var e=new ue;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var i=new ue;i._uuid="builtin-bloom-material",i.initialize({effectName:"bloom"});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();this._bloomMaterial=i;var n=new ue;n._uuid="builtin-post-process-material",Be.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=ts.FXAA),n.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var a=0;a<n.passes.length;++a)n.passes[a].tryCompile();this._postprocessMaterial=n,this.updatePipelinePassInfo()},i.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},i.activate=function(t,i){return e.prototype.activate.call(this,t,i),this.initPipelinePassInfo(),!0},i.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},i.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},O(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var i=new ue;i.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();this._postprocessMaterial=i}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(os),ws=[new Te(0,0,0,1)],vs=function(){};vs.SIZE=4*(vs.COUNT=4+(vs.TEXTURE_SIZE_OFFSET=0));var bs,Is,Rs,Fs,ys,Ds,Ns,Bs,Ps,Cs,Ls=e("B",(ps=N("BloomStage"),fs=M(ue),Ss=L(),ps((As=Es=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,P(t,"_bloomMaterial",Os,ae(t)),t._renderArea=new re,t._bloomUBO=[],t}x(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},i.destroy=function(){},i.render=function(e){var t,i=this._pipeline;if(i.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||i.macros.CC_PIPELINE_TYPE)&&i.bloomEnabled&&0!==i.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var r=0;r<14;++r)this._bloomUBO[r]=i.device.createBuffer(new S(g.UNIFORM|g.TRANSFER_DST,m.HOST|m.DEVICE,vs.SIZE,vs.SIZE));e.clearFlag&W.COLOR&&(ws[0].x=e.clearColor.x,ws[0].y=e.clearColor.y,ws[0].z=e.clearColor.z),ws[0].w=e.clearColor.w,this._prefilterPass(e,i),this._downsamplePass(e,i),this._upsamplePass(e,i),this._combinePass(e,i)}},i._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial.passes[0],n=t.getPipelineRenderData(),a=n.bloom,s=new Float32Array(vs.COUNT);s[vs.TEXTURE_SIZE_OFFSET+2]=this.threshold,i.updateBuffer(this._bloomUBO[0],s),i.beginRenderPass(a.renderPass,a.prefilterFramebuffer,this._renderArea,ws,0,0),i.bindDescriptorSet(fe.GLOBAL,t.descriptorSet),r.descriptorSet.bindBuffer(0,this._bloomUBO[0]),r.descriptorSet.bindTexture(1,n.outputRenderTargets[0]),r.descriptorSet.bindSampler(1,a.sampler),r.descriptorSet.update(),i.bindDescriptorSet(fe.MATERIAL,r.descriptorSet);var o=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null,l=r.getShaderVariant();null!=r&&null!=l&&null!=o&&(u=pe.getOrCreatePipelineState(t.device,r,l,a.renderPass,o)),null!=u&&(i.bindPipelineState(u),i.bindInputAssembler(o),i.draw(o)),i.endRenderPass()},i._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,n=t.getPipelineRenderData().bloom,a=new Float32Array(vs.COUNT),s=0;s<this.iterations;++s){a[vs.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[vs.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s+1],a),this._renderArea.width>>=1,this._renderArea.height>>=1,i.beginRenderPass(n.renderPass,n.downsampleFramebuffers[s],this._renderArea,ws,0,0);var o=r.passes[1+s],u=o.getShaderVariant();o.descriptorSet.bindBuffer(0,this._bloomUBO[s+1]),0===s?o.descriptorSet.bindTexture(1,n.prefiterTex):o.descriptorSet.bindTexture(1,n.downsampleTexs[s-1]),o.descriptorSet.bindSampler(1,n.sampler),o.descriptorSet.update(),i.bindDescriptorSet(fe.MATERIAL,o.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=o&&null!=u&&null!=l&&(h=pe.getOrCreatePipelineState(t.device,o,u,n.renderPass,l)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(l),i.draw(l)),i.endRenderPass()}},i._upsamplePass=function(e,t){var i=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var r=t.commandBuffers[0],n=t.pipelineSceneData.bloomMaterial,a=new Float32Array(vs.COUNT),s=0;s<this.iterations;++s){var o=s+6+1;a[vs.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[vs.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,r.updateBuffer(this._bloomUBO[o],a),this._renderArea.width<<=1,this._renderArea.height<<=1,r.beginRenderPass(i.renderPass,i.upsampleFramebuffers[this.iterations-1-s],this._renderArea,ws,0,0);var u=n.passes[7+s],l=u.getShaderVariant();u.descriptorSet.bindBuffer(0,this._bloomUBO[o]),0===s?u.descriptorSet.bindTexture(1,i.downsampleTexs[this.iterations-1]):u.descriptorSet.bindTexture(1,i.upsampleTexs[this.iterations-s]),u.descriptorSet.bindSampler(1,i.sampler),u.descriptorSet.update(),r.bindDescriptorSet(fe.MATERIAL,u.descriptorSet);var h=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,d=null;null!=u&&null!=l&&null!=h&&(d=pe.getOrCreatePipelineState(t.device,u,l,i.renderPass,h)),null!=d&&(r.bindPipelineState(d),r.bindInputAssembler(h),r.draw(h)),r.endRenderPass()}},i._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,n=t.getPipelineRenderData(),a=n.bloom,s=new Float32Array(vs.COUNT);s[vs.TEXTURE_SIZE_OFFSET+3]=this.intensity,i.updateBuffer(this._bloomUBO[13],s),i.beginRenderPass(a.renderPass,a.combineFramebuffer,this._renderArea,ws,0,0),i.bindDescriptorSet(fe.GLOBAL,t.descriptorSet);var o=r.passes[13];o.descriptorSet.bindBuffer(0,this._bloomUBO[13]),o.descriptorSet.bindTexture(1,n.outputRenderTargets[0]),o.descriptorSet.bindTexture(2,a.upsampleTexs[0]),o.descriptorSet.bindSampler(1,a.sampler),o.descriptorSet.bindSampler(2,a.sampler),o.descriptorSet.update(),i.bindDescriptorSet(fe.MATERIAL,o.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,h=o.getShaderVariant();null!=o&&null!=h&&null!=u&&(l=pe.getOrCreatePipelineState(t.device,o,h,a.renderPass,u)),null!=l&&(i.bindPipelineState(l),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()},t}(Ti),Es.initInfo={name:"BloomStage",priority:Ci.BLOOM,tag:0},Os=B((ms=As).prototype,"_bloomMaterial",[fs,C,Ss],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gs=ms))||gs)),Ms=e("M",N("MainFlow")((Rs=Is=function(e){function t(){return e.apply(this,arguments)||this}x(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new ls;i.initialize(ls.initInfo),this._stages.push(i);var r=new ds;r.initialize(ds.initInfo),this._stages.push(r);var n=new Ls;n.initialize(Ls.initInfo),this._stages.push(n);var a=new _s;a.initialize(_s.initInfo),this._stages.push(a)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(vi),Is.initInfo={name:Pe,priority:Hi.MAIN,stages:[]},bs=Rs))||bs),xs=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return x(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),Hs=(e("D",(Fs=N("DeferredPipeline"),ys=M([mn]),Ds=L(),Fs((Cs=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,P(t,"renderTextures",Ps,ae(t)),t}x(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new ss;i.initialize(ss.initInfo),this._flows.push(i);var r=new Ms;r.initialize(Ms.initInfo),this._flows.push(r)}return!0},i.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new Ts,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(Fe(2402),1))},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},i._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var i=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(b,i),this._descriptorSet.bindTexture(b,I.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(R,i),this._descriptorSet.bindTexture(R,I.get("default-texture").getGFXTexture()),this._descriptorSet.update();var r=new fn;if(!(r=this._createQuadInputAssembler()).quadIB||!r.quadVB||!r.quadIA)return!1;this._quadIB=r.quadIB,this._quadVBOffscreen=r.quadVB,this._quadIAOffscreen=r.quadIA;var n=this._createQuadInputAssembler();if(!n.quadIB||!n.quadVB||!n.quadIA)return!1;if(this._quadVBOnscreen=n.quadVB,this._quadIAOnscreen=n.quadIA,!this._gbufferRenderPass){var a=new U;a.format=J.RGBA16F,a.loadOp=Q.CLEAR,a.storeOp=G.STORE;var s=new U;s.format=J.RGBA16F,s.loadOp=Q.CLEAR,s.storeOp=G.STORE;var o=new U;o.format=J.RGBA16F,o.loadOp=Q.CLEAR,o.storeOp=G.STORE;var u=new U;u.format=J.RGBA16F,u.loadOp=Q.CLEAR,u.storeOp=G.STORE;var l=new z;l.format=J.DEPTH_STENCIL,l.depthLoadOp=Q.CLEAR,l.depthStoreOp=G.STORE,l.stencilLoadOp=Q.CLEAR,l.stencilStoreOp=G.STORE;var h=new q([a,s,o,u],l);this._gbufferRenderPass=t.createRenderPass(h)}if(!this._lightingRenderPass){var d=new U;d.format=J.RGBA8,d.loadOp=Q.CLEAR,d.storeOp=G.STORE,d.endAccesses=[V.COLOR_ATTACHMENT_WRITE];var c=new z;c.format=J.DEPTH_STENCIL,c.depthLoadOp=Q.LOAD,c.depthStoreOp=G.DISCARD,c.stencilLoadOp=Q.LOAD,c.stencilStoreOp=G.DISCARD,c.beginAccesses=[V.DEPTH_STENCIL_ATTACHMENT_WRITE],c.endAccesses=[V.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new q([d],c);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(w.BINDING).destroy(),this._descriptorSet.getBuffer(l.BINDING).destroy(),this._descriptorSet.getBuffer(v.BINDING).destroy(),this._descriptorSet.getTexture(b).destroy(),this._descriptorSet.getTexture(R).destroy())},i._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var i=0;i<e.outputRenderTargets.length;i++)e.outputRenderTargets[i].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},i._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,r=0;r<e.length;++r){var n=e[r].window;t=Math.max(n.width,t),i=Math.max(n.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i,this._destroyDeferredData(),this._generateDeferredRenderData())},i._generateDeferredRenderData=function(){for(var e=this,t=this.device,i=this._pipelineRenderData=new xs,r=this.pipelineSceneData,n=0;n<4;++n)i.gbufferRenderTargets.push(t.createTexture(new $(ee.TEX2D,te.COLOR_ATTACHMENT|te.SAMPLED,J.RGBA16F,this._width*r.shadingScale,this._height*r.shadingScale)));i.outputDepth=t.createTexture(new $(ee.TEX2D,te.DEPTH_STENCIL_ATTACHMENT,J.DEPTH_STENCIL,this._width*r.shadingScale,this._height*r.shadingScale)),i.gbufferFrameBuffer=t.createFramebuffer(new k(this._gbufferRenderPass,i.gbufferRenderTargets,i.outputDepth)),i.outputRenderTargets.push(t.createTexture(new $(ee.TEX2D,te.COLOR_ATTACHMENT|te.SAMPLED,J.RGBA16F,this._width*r.shadingScale,this._height*r.shadingScale))),i.outputFrameBuffer=t.createFramebuffer(new k(this._lightingRenderPass,i.outputRenderTargets,i.outputDepth)),this.on(wi.ATTACHMENT_SCALE_CAHNGED,(function(t){i.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(i.gbufferFrameBuffer),e.applyFramebufferRatio(i.outputFrameBuffer)})),i.sampler=this.globalDSManager.linearSampler},t}(Sn),Ps=B((Bs=Cs).prototype,"renderTextures",[ys,C,Ds],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ns=Bs))||Ns)),e("G",function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t}x(t,e);var i=t.prototype;return i.setFrameRate=function(e){this.frameRate=e},i.getFrameRate=function(){return this.frameRate},i.step=function(){y.director.tick(this.frameTime/1e3)},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&(Ce._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},i.isPaused=function(){return this._paused},i.restart=function(){var e=this;return new Promise((function(e){return y.director.once(y.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var i in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[i]);return y.director.getScene().destroy(),y.Object._deferredDestroy(),y.director.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},i.end=function(){Le.close()},i.on=function(e,i,r,n){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&i.call(r),this.eventTargetOn(e,i,r,n)},i.once=function(e,i,r){return this._engineInited&&e===t.EVENT_ENGINE_INITED?i.call(r):this.eventTargetOnce(e,i,r)},i.init=function(e){var t=this;if(this._initConfig(e),this.config.assetOptions&&y.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,r=0;r<i.length;r++){var n=i[r],a=Me(n.value);Ee.addLayer(n.name,a)}return this._initEngine().then((function(){return t._initEvents(),y.director.root&&y.director.root.dataPoolManager&&y.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},i.run=function(e,t){var i,r=this;return"function"!=typeof e&&e?(i=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,xe.init(),Promise.resolve(i).then((function(){return r._setRenderPipelineNShowSplash()})).then((function(){He._init({configOrientation:"auto",exactFitScreen:!0})}))},i.addPersistRootNode=function(e){if(y.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=y.director._scene;if(y.isValid(i))if(e.parent){if(!(e.parent instanceof y.Scene))return void Ue(3801);if(e.parent!==i)return void Ue(3802);e._originalSceneId=i.uuid}else e.parent=i;this._persistRootNodes[t]=e,e._persistNode=!0,y.assetManager._releaseManager._addPersistNodeRef(e)}}else Ue(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",y.assetManager._releaseManager._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return!!e._persistNode},i._initEngine=function(){var e=this;this._initDevice();var i=y.director;return Promise.resolve(i._init()).then((function(){y.view.init(),ze("Cocos Creator v"+Ge),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,y.internal.dynamicAtlasManager&&(y.internal.dynamicAtlasManager.enabled=!Be.CLEANUP_IMAGE_CACHE)}))},i._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},i._stTime=function(e){var t=performance.now(),i=Math.max(0,t-this._startTime),r=Math.max(0,this.frameTime-i);return window.setTimeout(e,r)},i._ctTime=function(e){window.clearTimeout(e)},i._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},i._updateCallback=function(){var e,t=this,i=y.director;if(30===this._frameRate){var r=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(r=!r)||i.tick(t._calculateDT(e))}}else e=function(e){i.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},i._runMainLoop=function(){if(this._inited&&!We){var e=this.config,t=y.director;Qe(!!e.showFPS),t.startAnimation(),this.resume()}},i._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=Ve.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,qe(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},i._determineRenderType=function(){var e=this.config,i=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var r=!1;if(1===i?(this.renderType=t.RENDER_TYPE_CANVAS,r=!0):0===i||2===i?(this.renderType=t.RENDER_TYPE_WEBGL,r=!0):3===i&&(this.renderType=t.RENDER_TYPE_HEADLESS,r=!0),!r)throw new Error(ke(3820,i))},i._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var i=new Je(Ze),r=!!window.WebGL2RenderingContext,n=window.navigator.userAgent.toLowerCase();(-1!==n.indexOf("safari")&&-1===n.indexOf("chrome")||Xe.browserType===Ye.UC)&&(r=!1);var a=[];r&&y.WebGL2Device&&a.push(y.WebGL2Device),y.WebGLDevice&&a.push(y.WebGLDevice),y.EmptyDevice&&a.push(y.EmptyDevice),Ke.canvas=this.canvas;for(var s=0;s<a.length&&(this._gfxDevice=new a[s],!this._gfxDevice.initialize(i));s++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&y.EmptyDevice&&(this._gfxDevice=new y.EmptyDevice,this._gfxDevice.initialize(new Je(Ze)));if(!this._gfxDevice)return je("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var o=new $e(this.canvas),u=He.windowSize;o.width=u.width,o.height=u.height,this._swapchain=this._gfxDevice.createSwapchain(o),this.canvas.oncontextmenu=function(){return!1}}},i._initEvents=function(){Le.on("show",this._onShow,this),Le.on("hide",this._onHide,this)},i._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},i._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},i._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},i._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,i){y.assetManager.loadAny(t,(function(t,r){return!t&&r instanceof Sn?e(r):i(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(i){et(i),et("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},i._showSplashScreen=function(){if(y.internal.SplashScreen){var e=y.internal.SplashScreen.instance;return e.main(y.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},i._setRenderPipeline=function(e){y.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},i._safeEmit=function(e){this.emit(e)},O(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(H)));Hs.EVENT_HIDE="game_on_hide",Hs.EVENT_SHOW="game_on_show",Hs.EVENT_LOW_MEMORY="game_on_low_memory",Hs.EVENT_GAME_INITED="game_inited",Hs.EVENT_ENGINE_INITED="engine_inited",Hs.EVENT_RENDERER_INITED="renderer_inited",Hs.EVENT_RESTART="game_on_restart",Hs.RENDER_TYPE_CANVAS=0,Hs.RENDER_TYPE_WEBGL=1,Hs.RENDER_TYPE_OPENGL=2,Hs.RENDER_TYPE_HEADLESS=3,Hs.DEBUG_DT_THRESHOLD=1,y.Game=Hs;var Us,zs=e("g",y.game=new Hs),Gs=e("k",{topLeft:y.v2(0,0),topRight:y.v2(0,0),top:y.v2(0,0),bottomLeft:y.v2(0,0),bottomRight:y.v2(0,0),bottom:y.v2(0,0),center:y.v2(0,0),left:y.v2(0,0),right:y.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,r=e.x,n=e.y,a=n+i,s=r+t;this.topLeft.x=r,this.topLeft.y=a,this.topRight.x=s,this.topRight.y=a,this.top.x=r+t/2,this.top.y=a,this.bottomLeft.x=r,this.bottomLeft.y=n,this.bottomRight.x=s,this.bottomRight.y=n,this.bottom.x=r+t/2,this.bottom.y=n,this.center.x=r+t/2,this.center.y=n+i/2,this.left.x=r,this.left.y=n+i/2,this.right.x=s,this.right.y=n+i/2}});y.visibleRect=Gs;var Ws=new tt,Qs=((Us={})[Be.ORIENTATION_AUTO]=it.AUTO,Us[Be.ORIENTATION_LANDSCAPE]=it.LANDSCAPE,Us[Be.ORIENTATION_PORTRAIT]=it.PORTRAIT,Us),Vs=e("V",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var i=qs,r=ks;return t._designResolutionSize=new tt(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new nt(0,0,0,0),t._visibleRect=new nt(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new Xs(i.EQUAL_TO_FRAME,r.EXACT_FIT),t._rpShowAll=new Xs(i.EQUAL_TO_FRAME,r.SHOW_ALL),t._rpNoBorder=new Xs(i.EQUAL_TO_FRAME,r.NO_BORDER),t._rpFixedHeight=new Xs(i.EQUAL_TO_FRAME,r.FIXED_HEIGHT),t._rpFixedWidth=new Xs(i.EQUAL_TO_FRAME,r.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}x(t,e);var i=t.prototype;return i.init=function(){var e=He.windowSize,t=e.width,i=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=i,this._viewportRect.width=t,this._viewportRect.height=i,this._visibleRect.width=t,this._visibleRect.height=i,Ws.width=this._visibleRect.width,Ws.height=this._visibleRect.height,Gs&&Gs.init(this._visibleRect),rt.on("window-resize",this._updateAdaptResult,this),rt.on("orientation-change",this._updateAdaptResult,this),rt.on("fullscreen-change",this._updateAdaptResult,this)},i.resizeWithBrowserSize=function(e){rt.handleResizeEvent=e},i.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},i.setOrientation=function(e){rt.orientation=Qs[e]},i.adjustViewportMeta=function(){},i.enableRetina=function(e){this._retinaEnabled=!!e},i.isRetinaEnabled=function(){return this._retinaEnabled},i.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&He.requestFullScreen().catch((function(){})))},i.isAutoFullScreenEnabled=function(){return this._autoFullScreen},i.setCanvasSize=function(e,t){rt.resolutionScale=1;var i=rt.devicePixelRatio,r=new tt(e*i,t*i);He.windowSize=r},i.getCanvasSize=function(){return He.windowSize},i.getFrameSize=function(){var e=rt.devicePixelRatio,t=He.windowSize;return t.width/=e,t.height/=e,t},i.setFrameSize=function(e,t){var i=rt.devicePixelRatio;He.windowSize=new tt(e*i,t*i)},i.getVisibleSize=function(){return new tt(this._visibleRect.width,this._visibleRect.height)},i.getVisibleSizeInPixel=function(){return new tt(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},i.getVisibleOrigin=function(){return new s(this._visibleRect.x,this._visibleRect.y)},i.getVisibleOriginInPixel=function(){return new s(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},i.getResolutionPolicy=function(){return this._resolutionPolicy},i._updateResolutionPolicy=function(e){if(e instanceof Xs)this._resolutionPolicy=e;else{var t=Xs;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},i.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=Ys.getDesignResolutionSize();Ys.setDesignResolutionSize(t.width,t.height,e)},i.setDesignResolutionSize=function(e,t,i){if(e>0&&t>0){this._updateResolutionPolicy(i);var r=this._resolutionPolicy;r&&r.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var n=r.apply(this,this._designResolutionSize);if(n.scale&&2===n.scale.length&&(this._scaleX=n.scale[0],this._scaleY=n.scale[1]),n.viewport){var a=this._viewportRect,s=this._visibleRect,o=n.viewport;a.x=o.x,a.y=o.y,a.width=o.width,a.height=o.height,s.x=0,s.y=0,s.width=o.width/this._scaleX,s.height=o.height/this._scaleY}r.postApply(this),Ws.width=this._visibleRect.width,Ws.height=this._visibleRect.height,Gs&&Gs.init(this._visibleRect),this.emit("design-resolution-changed")}else Fe(2200)},i.getDesignResolutionSize=function(){return new tt(this._designResolutionSize.width,this._designResolutionSize.height)},i.setRealPixelResolution=function(e,t,i){this.setDesignResolutionSize(e,t,i)},i.getViewportRect=function(){return this._viewportRect},i.getScaleX=function(){return this._scaleX},i.getScaleY=function(){return this._scaleY},i.getDevicePixelRatio=function(){return rt.devicePixelRatio},i.convertToLocationInView=function(e,t,i,r){void 0===r&&(r=new s);var n=rt.devicePixelRatio*(e-i.left),a=rt.devicePixelRatio*(i.top+i.height-t);return rt.isFrameRotated?(r.x=He.windowSize.width-a,r.y=n):(r.x=n,r.y=a),r},i._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},i._updateAdaptResult=function(){var e;y.director.root.resize(He.windowSize.width,He.windowSize.height);var t=this._designResolutionSize.width,i=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,i,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(H));Vs.instance=void 0;var qs=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=zs.canvas;if(e){var t=He.windowSize;e.width=t.width,e.height=t.height}},e}();qs.EQUAL_TO_FRAME=void 0,qs.PROPORTION_TO_FRAME=void 0;var ks=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,i,r,n,a){Math.abs(e-i)<2&&(i=e),Math.abs(t-r)<2&&(r=t);var s=new nt(Math.round((e-i)/2),Math.round((t-r)/2),i,r);return this._result.scale=[n,a],this._result.viewport=s,this._result},e}();ks.EXACT_FIT=void 0,ks.SHOW_ALL=void 0,ks.NO_BORDER=void 0,ks.FIXED_HEIGHT=void 0,ks.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).name="EqualToFrame",t}return x(t,e),t.prototype.apply=function(){rt.isProportionalToFrame=!1,this._setupCanvas()},t}(qs),t=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).name="ProportionalToFrame",t}return x(t,e),t.prototype.apply=function(){rt.isProportionalToFrame=!0,this._setupCanvas()},t}(qs);qs.EQUAL_TO_FRAME=new e,qs.PROPORTION_TO_FRAME=new t;var i=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).name="ExactFit",t}return x(t,e),t.prototype.apply=function(e,t){var i=He.windowSize,r=i.width,n=i.height,a=r/t.width,s=n/t.height;return this._buildResult(r,n,r,n,a,s)},t}(ks),r=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).name="ShowAll",t}return x(t,e),t.prototype.apply=function(e,t){var i,r,n=He.windowSize,a=n.width,s=n.height,o=t.width,u=t.height,l=a/o,h=s/u,d=0;return l<h?(i=a,r=u*(d=l)):(i=o*(d=h),r=s),this._buildResult(a,s,i,r,d,d)},t}(ks),n=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).name="NoBorder",t}return x(t,e),t.prototype.apply=function(e,t){var i,r,n,a=He.windowSize,s=a.width,o=a.height,u=t.width,l=t.height,h=s/u,d=o/l;return h<d?(r=u*(i=d),n=o):(r=s,n=l*(i=h)),this._buildResult(s,o,r,n,i,i)},t}(ks),a=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).name="FixedHeight",t}return x(t,e),t.prototype.apply=function(e,t){var i=He.windowSize,r=i.width,n=i.height,a=n/t.height,s=r,o=n;return this._buildResult(r,n,s,o,a,a)},t}(ks),s=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).name="FixedWidth",t}return x(t,e),t.prototype.apply=function(e,t){var i=He.windowSize,r=i.width,n=i.height,a=r/t.width,s=r,o=n;return this._buildResult(r,n,s,o,a,a)},t}(ks);ks.EXACT_FIT=new i,ks.SHOW_ALL=new r,ks.NO_BORDER=new n,ks.FIXED_HEIGHT=new a,ks.FIXED_WIDTH=new s}();var Xs=e("R",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof qs&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof ks&&(this._contentStrategy=e)},O(e,[{key:"canvasSize",get:function(){return He.windowSize}}]),e}());Xs.EXACT_FIT=0,Xs.NO_BORDER=1,Xs.SHOW_ALL=2,Xs.FIXED_HEIGHT=3,Xs.FIXED_WIDTH=4,Xs.UNKNOWN=5,Xs.ContainerStrategy=qs,Xs.ContentStrategy=ks,y.ResolutionPolicy=Xs;var Ys=e("v",Vs.instance=y.view=new Vs);y.winSize=Ws,at(Vs.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),st(Vs.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"devicePixelRatio is a concept on web standard"},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),st(y,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),st(Xe,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),ot(Xe,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:Xe.Language,targetName:"sys.Language"}}))),ot(Xe,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:Xe.OS,targetName:"sys.OS"}}))),ot(Xe,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:Xe.BrowserType,targetName:"sys.BrowserType"}}))),ot(Xe,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:Xe.BrowserType,targetName:"sys.BrowserType"}]),ot(Xe,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:Xe.Platform,targetName:"sys.Platform"}}))),ot(Xe,"sys",[{name:"IPHONE",newName:"IOS",target:Xe.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:Xe.Platform,targetName:"sys.Platform"}]),at(Xe,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),ot(Xe,"sys",[{name:"windowPixelResolution",target:He,targetName:"screen",newName:"windowSize"}]),st(He,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}])}}}));
